# 技術研究與決策：關鍵字優先選擇與條件式自動遞補

**功能**: 關鍵字優先選擇與條件式自動遞補
**建立日期**: 2025-10-31
**研究人員**: AI Assistant

## 研究概述

本功能是對現有日期與區域選擇邏輯的重構，主要變更在於：
1. 從「掃描全部關鍵字後再選擇」改為「第一個匹配立即選擇」
2. 新增條件式遞補機制（透過布林開關控制）

由於這是邏輯重構而非新技術導入，研究重點在於：
- 現有程式碼結構分析
- 邏輯變更的最佳實踐
- 設定檔擴展策略
- UI 控制項最佳位置

---

## 決策 1：關鍵字匹配邏輯的實作策略

### 選擇：早期返回（Early Return）模式

### 理由

1. **效能提升**：一旦找到第一個匹配的關鍵字，立即返回結果，不需要繼續掃描後續關鍵字清單，平均節省 30% 的匹配時間（根據 SC-006）
2. **程式碼簡潔性**：使用 early return 模式比維護一個匹配陣列後再篩選更直觀，符合憲章第 IV 條「單一職責」原則
3. **符合使用者預期**：使用者設定關鍵字時已按優先順序排列，第一個匹配立即選擇是最符合直覺的行為

### 考慮過的替代方案

#### 替代方案 A：掃描全部後取最高優先級

**描述**：掃描所有關鍵字，記錄所有匹配項，然後從中選擇優先級最高（索引最小）的一個。

**優點**：
- 可以記錄所有可用選項供日誌輸出
- 更容易實作單元測試（可驗證所有匹配項）

**缺點**：
- 效能較差，需要完整掃描整個關鍵字清單
- 增加不必要的複雜度
- 與需求不符（Q2: A 明確選擇「第一個匹配立即選擇」）

**不採用原因**：與需求明確衝突，且效能劣於 early return 模式。

#### 替代方案 B：使用生成器（Generator）模式

**描述**：將關鍵字匹配邏輯設計為 Python generator，使用 `yield` 返回匹配結果，調用方使用 `next()` 取得第一個匹配項。

**優點**：
- 更 Pythonic 的寫法
- 天然支援 lazy evaluation（延遲求值）

**缺點**：
- 增加程式碼複雜度
- 對於簡單的線性掃描邏輯過度設計
- 不符合專案現有的程式風格

**不採用原因**：過度工程化，違反「三問法則」第二問（有更簡單的方法嗎？）。

---

## 決策 2：新增布林參數的設定檔整合策略

### 選擇：頂層獨立欄位（`date_auto_fallback` / `area_auto_fallback`）

### 理由

1. **符合規格明確定義**：FR-005 明確要求「系統必須在設定檔中新增 date_auto_fallback 和 area_auto_fallback 兩個布林欄位」
2. **存取直接**：頂層欄位存取更直接（如 `config["date_auto_fallback"]`）
3. **向後相容性**：新增欄位而非修改既有欄位，舊版設定檔升級時可提供預設值（true），符合憲章第 III 條「會破壞相容性嗎？」

### 考慮過的替代方案

#### 替代方案 A：在 `date_auto_select` 和 `area_auto_select` 父物件下新增巢狀欄位

**描述**：將遞補開關放在對應的自動選擇配置物件下（如 `config["date_auto_select"]["enable_fallback"]`）。

**優點**：
- 結構更清晰，語意明確
- 符合現有設定檔的巢狀結構
- 當未來需要更多自動選擇相關配置時，避免頂層欄位爆炸

**缺點**：
- 與規格定義不符（規格明確要求頂層欄位）
- 存取路徑較長

**不採用原因**：與功能規格明確定義衝突，規格優先。

#### 替代方案 B：單一全局開關（`auto_select_fallback`）

**描述**：僅新增一個全局布林開關，同時控制日期和區域的遞補行為。

**優點**：
- 最簡潔，設定檔與 UI 最簡單

**缺點**：
- 與需求衝突（Q3: A 明確選擇「各自獨立」）
- 無法滿足進階使用者需要（如僅對日期啟用遞補，區域保持嚴格匹配）

**不採用原因**：與需求明確衝突。

---

## 決策 3：UI 控制項的設計與位置

### 選擇：在 settings.html 中對應的「日期自動點選」和「區域自動點選」區塊各新增一個核取方塊

### 理由

1. **邏輯分組**：遞補功能是自動選擇的一部分，放在對應區塊下最直觀
2. **視覺清晰**：使用 Bootstrap checkbox 樣式，與現有 UI 風格一致
3. **中文標籤**：使用「日期自動遞補」和「區域自動遞補」這樣的中文標籤，符合使用者友善原則（FR-006, FR-007）

### 考慮過的替代方案

#### 替代方案 A：新增獨立的「遞補設定」區塊

**描述**：在設定頁面新增一個專門的「遞補設定」區塊，集中管理日期和區域的遞補開關。

**優點**：
- 更明確的功能分類
- 便於未來擴展更多遞補相關配置

**缺點**：
- 增加頁面複雜度
- 使用者需要在多個區塊間切換查找相關設定
- 不符合現有頁面結構（目前配置按功能類別分組）

**不採用原因**：違反「有更簡單的方法嗎？」原則，現有結構已足夠。

#### 替代方案 B：使用下拉選單（Select）而非核取方塊

**描述**：將核取方塊改為下拉選單，選項為「啟用遞補」、「停用遞補」、「僅在關鍵字未設定時遞補」。

**優點**：
- 提供更多彈性選項
- 便於未來擴展更多遞補策略

**缺點**：
- 過度設計，目前需求僅為簡單的啟用/停用
- 增加使用者學習成本
- 違反 YAGNI 原則

**不採用原因**：過度工程化，不符合 MVP 原則。

---

## 決策 4：日誌訊息格式與詳細程度

### 選擇：結構化英文日誌訊息，明確記錄匹配過程與決策邏輯

### 理由

1. **除錯友善**：清楚的日誌可快速定位問題（FR-009, FR-010, FR-011）
2. **國際化標準**：英文日誌符合國際標準，便於跨語言開發者理解
3. **符合現有風格**：專案已有豐富的日誌輸出，新訊息應保持一致性

### 日誌訊息範例（英文版）

```
[DATE KEYWORD] Start checking keywords in order: ['11/16', '11/17', '11/18']
[DATE KEYWORD] Checking keyword #1: '11/16' - No match
[DATE KEYWORD] Checking keyword #2: '11/17' - Match found
[DATE SELECT] Keyword #2 matched: '11/17', selected immediately and stopped further checks
[DATE SELECT] Selected date: 11/17

# Fallback scenario
[DATE KEYWORD] All keywords failed to match
[DATE FALLBACK] date_auto_fallback=true, triggering auto fallback
[DATE FALLBACK] Selecting available date based on date_select_order='from_near_to_far'
[DATE SELECT] Selected date: 11/18 (fallback)

# Fallback disabled scenario
[DATE KEYWORD] All keywords failed to match
[DATE FALLBACK] date_auto_fallback=false, fallback is disabled
[DATE SELECT] Waiting for manual intervention
```

### 考慮過的替代方案

#### 替代方案 A：中文日誌訊息

**描述**：使用中文輸出日誌訊息。

**優點**：
- 對中文使用者更友善

**缺點**：
- 可能導致編碼問題（Windows cp950 編碼錯誤）
- 不符合國際化標準
- 與專案現有日誌風格不一致（專案日誌多為英文）

**不採用原因**：考量編碼相容性與國際化標準，英文日誌更佳。

#### 替代方案 B：最小化日誌（僅記錄最終選擇結果）

**描述**：僅在最終選擇時輸出一條日誌，不記錄中間檢查過程。

**優點**：
- 日誌更簡潔
- 減少 I/O 開銷

**缺點**：
- 除錯困難
- 無法理解系統決策邏輯
- 與需求衝突（FR-009 明確要求記錄匹配過程）

**不採用原因**：與功能需求衝突。

---

## 決策 5：舊邏輯的移除策略

### 選擇：逐步重構，保留舊程式碼作為註解（標記為 DEPRECATED）

### 理由

1. **安全性**：萬一新邏輯有問題，可快速回滾
2. **文件價值**：舊程式碼可作為理解歷史邏輯的參考
3. **測試驗證**：可對比新舊邏輯的輸出，確保行為一致

### 移除時程

1. **Phase 1（實作階段）**：註解舊程式碼，新增 DEPRECATED 標記
2. **Phase 2（測試階段）**：驗證新邏輯正確性後，保留舊程式碼但停用
3. **Phase 3（穩定階段）**：版本穩定 2 週後，完全移除舊程式碼

### 考慮過的替代方案

#### 替代方案 A：直接刪除舊程式碼

**描述**：立即刪除所有「將所有匹配結果加入陣列再選擇」的邏輯。

**優點**：
- 程式碼最乾淨
- 避免混淆

**缺點**：
- 無法快速回滾
- 失去歷史參考價值

**不採用原因**：風險較高，不符合審慎原則。

---

## 技術約束與相依性

### 相依於現有模組

1. **關鍵字解析邏輯**（`util.py` 或相關模組）
   - 現有的分號分隔符解析必須保持正常運作
   - 確保關鍵字清單已按優先順序排列

2. **排序規則邏輯**（`date_select_order` / `area_select_order`）
   - 遞補功能依賴這些規則正常運作
   - 需驗證所有可能的排序模式（由近到遠、由遠到近等）

3. **設定檔載入/儲存機制**（`settings.py` / `settings_old.py`）
   - 必須支援新欄位的載入與儲存
   - 需提供預設值機制（當欄位不存在時）

### 憲章合規檢查

1. **NoDriver First（第 I 條）**：✅ 邏輯重構對所有引擎通用，不違反此原則
2. **資料結構優先（第 II 條）**：✅ 已在 data-model.md 定義新欄位結構
3. **三問法則（第 III 條）**：
   - ✅ 是核心問題嗎？是，直接影響搶票成功率
   - ✅ 有更簡單方法嗎？已選擇 early return 這個最簡單的方案
   - ✅ 會破壞相容性嗎？否，新欄位預設值（true）保持與舊版本一致行為
4. **單一職責（第 IV 條）**：✅ 匹配邏輯與遞補邏輯分離為獨立函數
5. **設定驅動（第 V 條）**：✅ 新增布林開關完全由 settings.json 控制
6. **測試驅動（第 VI 條）**：✅ 需執行實際搶票測試驗證新邏輯
7. **MVP 原則（第 VII 條）**：✅ P1 優先級專注核心邏輯，P2 才處理 UI
8. **文件同步（第 VIII 條）**：✅ 需更新 settings-guide.md 說明新欄位

---

## 實作優先順序建議

根據 User Story 的優先級（P1 vs P2），建議實作順序：

### Phase 1（P1 - 核心邏輯）

1. 修改日期選擇邏輯（FR-001, FR-003）
2. 修改區域選擇邏輯（FR-002, FR-004）
3. 新增 date_auto_fallback 和 area_auto_fallback 欄位（FR-005）
4. 實作條件式遞補邏輯（FR-003, FR-004）
5. 新增日誌輸出（FR-009, FR-010, FR-011）
6. 移除舊邏輯（FR-012）

### Phase 2（P2 - UI 改善）

7. 在 settings.html 新增核取方塊（FR-006, FR-007）
8. 實作設定檔同步邏輯（FR-008）

### Phase 3（測試與文件）

9. 執行實際搶票測試（遵循憲章第 VI 條）
10. 更新 settings-guide.md

---

## 風險與緩解措施

### 風險 1：邏輯變更導致非預期行為

**緩解措施**：
- 新增單元測試驗證每個驗收情境
- 保留舊程式碼作為註解，便於對比
- 使用測試頁面驗證新邏輯

### 風險 2：設定檔相容性問題

**緩解措施**：
- 提供預設值機制（true），確保舊設定檔升級後行為不變
- 在 CHANGELOG.md 記錄新增欄位

### 風險 3：日誌輸出過多影響效能

**緩解措施**：
- 日誌僅在 verbose 模式下詳細輸出
- 使用結構化日誌，便於過濾

---

## 結論

本次邏輯重構的核心決策已完成，所有技術選擇皆基於「簡潔性優先」、「向後相容」、「符合需求」三大原則。日誌訊息採用英文輸出，符合國際化標準並避免編碼問題。下一階段將根據這些決策產生 data-model.md 和 API contracts。
