# 2025.11.01 詳細更新說明

## 新增功能：關鍵字優先匹配與條件式自動遞補

### 核心改進

- **關鍵字優先匹配（早期返回模式）**：依序檢查關鍵字清單，第一個匹配成功立即選擇並停止檢查，不再掃描所有關鍵字
  - 提升搶票速度：避免不必要的關鍵字檢查
  - 優先順序控制：使用者可透過關鍵字順序決定優先級
  - 適用範圍：日期選擇與區域選擇

- **條件式自動遞補功能**：新增兩個布林開關控制「全部未匹配」時的行為
  - `date_auto_fallback`（日期自動遞補，預設 `false`）
  - `area_auto_fallback`（區域自動遞補，預設 `false`）

### 運作模式

| 開關狀態 | 行為說明 |
|---------|---------|
| `true`（寬鬆模式）| 所有關鍵字未匹配時，根據 `date_select_order` / `area_select_order` 自動選擇可用選項 |
| `false`（嚴格模式，預設）| 所有關鍵字未匹配時，不選擇任何選項，等待手動介入 |

### 新增設定欄位

```json
{
  "date_auto_fallback": false,  // 日期自動遞補（預設關閉）
  "area_auto_fallback": false   // 區域自動遞補（預設關閉）
}
```

### 升級指引

舊版設定檔（不含上述欄位）升級後會自動使用預設值 `false`（嚴格模式），確保向後相容性：
- 行為保持一致：僅選擇關鍵字匹配的選項
- 無需修改設定檔即可正常運作
- 如需啟用自動遞補，請在網頁設定介面或 settings.json 中將對應開關設為 `true`

### 使用者介面更新

- 網頁設定介面（settings.html）：新增「日期自動遞補」與「區域自動遞補」Bootstrap 開關
- 桌面設定介面（settings_old.py）：新增對應的核取方塊，支援繁中/英文/日文三語切換
- 完整的說明文字與 tooltip 提示

### 日誌輸出增強

新增詳細的英文日誌訊息，便於追蹤匹配與遞補行為：
- `[DATE KEYWORD]` / `[AREA KEYWORD]`：關鍵字匹配過程
- `[DATE FALLBACK]` / `[AREA FALLBACK]`：遞補機制狀態
- `[DATE SELECT]` / `[AREA SELECT]`：選擇結果摘要

### 技術細節

- 舊邏輯已註解並標記為 `DEPRECATED`，保留 2 週後移除（2025-11-15）
- 僅修改 NoDriver 版本（`nodriver_tixcraft.py`），Chrome 版本不在修改範圍
- 完整支援 AND 邏輯（空格分隔多個條件）

### 使用範例

#### 場景 1：嚴格模式（預設，避免誤購）
```json
{
  "date_auto_select": {
    "enable": true,
    "date_keyword": "2025-11-01;2025-11-02"
  },
  "date_auto_fallback": false  // 或不設定此欄位（預設 false）
}
```

**行為**：
- 只有當日期包含「2025-11-01」或「2025-11-02」時才選擇
- 如果兩個關鍵字都未匹配，**不選擇任何日期**，等待手動處理

#### 場景 2：寬鬆模式（自動遞補）
```json
{
  "date_auto_select": {
    "enable": true,
    "date_keyword": "2025-11-01;2025-11-02",
    "mode": "from top to bottom"
  },
  "date_auto_fallback": true  // 啟用自動遞補
}
```

**行為**：
- 優先選擇包含「2025-11-01」或「2025-11-02」的日期
- 如果兩個關鍵字都未匹配，根據 `mode="from top to bottom"` **自動選擇第一個可用日期**

#### 場景 3：關鍵字優先順序
```json
{
  "area_auto_select": {
    "enable": true,
    "area_keyword": "VIP區;搖滾區A;一般區",
    "mode": "from top to bottom"
  },
  "area_auto_fallback": false
}
```

**行為**（早期返回模式）：
1. 先檢查所有區域是否包含「VIP區」
   - 如果找到，**立即選擇**，停止檢查後續關鍵字
2. 如果「VIP區」未找到，再檢查「搖滾區A」
   - 如果找到，**立即選擇**，停止檢查後續關鍵字
3. 如果「搖滾區A」未找到，最後檢查「一般區」
4. 如果三個關鍵字都未匹配，**不選擇任何區域**（嚴格模式）

### 優勢分析

#### 舊版邏輯（已棄用）
```
關鍵字：VIP區, 搖滾區A, 一般區
可用區域：20 個

流程：
1. 掃描所有 20 個區域，檢查「VIP區」 → 收集所有匹配
2. 掃描所有 20 個區域，檢查「搖滾區A」 → 收集所有匹配
3. 掃描所有 20 個區域，檢查「一般區」 → 收集所有匹配
4. 從收集的匹配中選擇一個

總檢查次數：20 × 3 = 60 次
```

#### 新版邏輯（早期返回）
```
關鍵字：VIP區, 搖滾區A, 一般區
可用區域：20 個

流程：
1. 掃描區域直到找到「VIP區」（假設在第 5 個）
2. 立即選擇，停止檢查

總檢查次數：5 次（節省 91% 時間）
```

**效能提升**：
- **最佳情況**：第一個關鍵字在第一個選項匹配 → 節省 98% 時間
- **一般情況**：第一個關鍵字在中間位置匹配 → 節省 60-80% 時間
- **最壞情況**：所有關鍵字都失敗 → 效能與舊版相同（不會更慢）

### 常見問答

**Q1: 為什麼預設值是 `false` 而不是 `true`？**

A: 為了避免誤購不想要的票券。舉例：
- 您想買「VIP區」，但關鍵字打錯或該區已售完
- 舊版：可能自動選擇其他區域（如「一般區」）→ 買到不想要的票
- 新版（`false`）：不選擇任何區域，等您手動確認 → 避免誤購
- 如需自動遞補，請主動設定為 `true`

**Q2: 舊版設定檔案會出錯嗎？**

A: 不會。系統自動使用預設值 `false`，行為保持一致（僅選擇關鍵字匹配的選項）。

**Q3: 如何啟用自動遞補？**

A: 兩種方式：
1. **網頁介面**：開啟設定頁面，勾選「日期自動遞補」或「區域自動遞補」
2. **手動編輯**：在 `settings.json` 中新增欄位：
   ```json
   {
     "date_auto_fallback": true,
     "area_auto_fallback": true
   }
   ```

**Q4: 關鍵字順序重要嗎？**

A: 非常重要！新版使用早期返回模式，**第一個匹配的關鍵字會立即被選擇**。

範例：
```json
{
  "area_keyword": "一般區;VIP區"  // 順序：一般區 → VIP區
}
```
- 如果頁面同時有「一般區」和「VIP區」
- 系統會選擇「一般區」（因為先匹配）
- **建議**：將最想要的區域放在最前面（`"VIP區;一般區"`）

**Q5: AND 邏輯怎麼用？**

A: 使用空格分隔多個條件（同時匹配）。

範例：
```json
{
  "area_keyword": "VIP 1280;搖滾區 1580"
}
```
- 第一個關鍵字：「VIP」**且**「1280」（兩個都要匹配）
- 第二個關鍵字：「搖滾區」**且**「1580」

這樣可以避免選到「VIP 3280」（價格不符）或「搖滾區 880」（價格不符）。

**Q6: 適用哪些平台？**

A: 目前僅 **TixCraft (NoDriver 引擎)** 實作完成。其他平台（KKTIX, iBon, TicketPlus, KHAM）將陸續更新。

### 已知限制

- Chrome Driver 版本（舊版引擎）**不支援**此功能
- 僅 NoDriver 引擎版本支援
- 其他售票平台（KKTIX, iBon 等）尚未實作，將在後續版本中加入

### 技術參考

詳細的實作細節、程式碼範例、測試結果，請參考：
- `specs/003-keyword-priority-fallback/completion-report-tixcraft-nodriver.md`（開發者文件）
- `specs/003-keyword-priority-fallback/spec.md`（功能規格）
- `specs/003-keyword-priority-fallback/implementation-guide.md`（實作指南）
