# 功能規格：FANSI GO 平台支援

**功能分支**：`012-fansigo-platform`
**建立日期**：2026-02-05
**狀態**：草稿
**輸入**：使用者描述："新增對 FANSI GO (go.fansi.me) 售票平台的自動化搶票支援"
**參考文件**：`docs/09-platform-research/fansi-go-research.md`

## 使用者情境與測試 *（強制）*

### 使用者故事 1 - 基本購票自動化（優先順序：P1）

使用者想要在 FANSI GO 平台上自動完成購票流程。使用者設定好目標活動網址、票種關鍵字後，系統自動導航至購票頁面，選擇符合條件的票種，並完成至付款頁面的所有步驟。

**為何此優先順序**：這是平台支援的核心功能，沒有此功能其他功能都無法發揮作用。

**獨立測試**：可透過設定一個真實的 FANSI GO 活動網址，執行程式後觀察是否成功導航至付款方式選擇頁面來完整測試。

**驗收情境**：

1. **給定** 使用者已設定 FANSI GO 活動網址和票種關鍵字，**當** 執行自動化程式，**則** 系統成功導航至付款方式選擇頁面並停止
2. **給定** 目標票種已售完，**當** 執行自動化程式，**則** 系統顯示票種售完訊息並根據設定重試或停止
3. **給定** 活動有多個票種區域（如 VIP、一般），**當** 設定 area_keyword 為 "VIP"，**則** 系統正確選擇包含 "VIP" 的票種

---

### 使用者故事 2 - 多場次選擇（優先順序：P1）

使用者想要在有多個演出場次的活動中（如高雄場、台北場），自動選擇符合關鍵字的場次。

**為何此優先順序**：FANSI GO 平台的活動常有多場次，這是完整購票流程的必要功能。

**獨立測試**：可透過設定有多場次的活動（如普通隊長活動），驗證 date_keyword 設定是否正確匹配目標場次。

**驗收情境**：

1. **給定** 活動有高雄場和台北場兩個場次，**當** date_keyword 設定為 "高雄"，**則** 系統自動選擇高雄場並進入購票頁面
2. **給定** 活動有多個場次，**當** date_keyword 為空，**則** 系統選擇第一個可購買的場次
3. **給定** date_keyword 設定的場次不存在或已售完，**當** 執行自動化程式，**則** 系統顯示找不到符合條件的場次

---

### 使用者故事 3 - Cookie 登入（優先順序：P2）

使用者想要透過預先登入的 Cookie 來維持登入狀態，避免每次都要手動登入。

**為何此優先順序**：雖然部分活動可能不需要登入就能購票，但登入後能獲得會員優惠或存取限定活動，是重要的輔助功能。

**獨立測試**：可透過導出登入後的 FansiAuthInfo Cookie，在新的瀏覽器 session 中匯入，驗證是否恢復登入狀態。

**驗收情境**：

1. **給定** 使用者已設定有效的 FansiAuthInfo Cookie，**當** 開啟 FANSI GO 頁面，**則** 系統以登入狀態運行（顯示「我的票劵」等選項）
2. **給定** Cookie 已過期或無效，**當** 開啟 FANSI GO 頁面，**則** 系統以未登入狀態運行並記錄警告訊息

---

### 使用者故事 4 - 追蹤器封鎖（優先順序：P3）

使用者想要封鎖 Google Analytics、Smartlook 等追蹤技術，減少被偵測為自動化的風險並提升頁面載入速度。

**為何此優先順序**：這是效能和隱私優化，不影響核心購票功能。

**獨立測試**：可透過網路請求監控，驗證封鎖清單中的域名是否被成功攔截。

**驗收情境**：

1. **給定** 追蹤器封鎖已啟用，**當** 載入 FANSI GO 頁面，**則** Google Analytics 和 Smartlook 的請求被攔截
2. **給定** 追蹤器封鎖已啟用，**當** 載入 FANSI GO 頁面，**則** Cloudflare、支付服務、核心功能的請求正常通過

---

### 邊界案例

- 當 Cloudflare Challenge 觸發時，系統應等待使用者手動完成驗證後繼續
- 當網路連線中斷時，系統應重試連線而非直接失敗
- 當票種數量選擇器被禁用（如已達購買上限）時，系統應識別並提示使用者
- 當頁面結構改變導致選擇器失效時，系統應記錄詳細錯誤供除錯

## 需求 *（強制）*

### 功能需求

- **FR-001**：系統必須能識別 FANSI GO 平台的 URL 模式（`go.fansi.me`）
- **FR-002**：系統必須能在活動頁面（`/events/{eventId}`）根據 date_keyword 選擇目標場次
- **FR-003**：系統必須能在購票頁面（`/tickets/show/{showId}`）根據 area_keyword 選擇目標票種
- **FR-004**：系統必須能操作票種數量選擇器（增加/減少按鈕）
- **FR-005**：系統必須能偵測購票流程的完成點（付款方式選擇頁面 `/tickets/payment/checkout/*`）並停止自動化
- **FR-006**：系統必須能透過 Cookie（FansiAuthInfo）維持登入狀態
- **FR-007**：系統必須封鎖追蹤器（Google Analytics、Smartlook）但不封鎖核心功能和支付服務
- **FR-008**：系統必須能處理票種狀態分類（熱賣中、即將開賣、已結束）
- **FR-009**：系統必須能處理票種區域分類（如 VIP 區塊）
- **FR-010**：系統必須在設定檔中提供 FANSI GO 相關的設定選項

### 關鍵實體

- **活動（Event）**：由 eventId 識別，包含活動名稱、主辦單位、場次列表
- **場次（Show）**：由 showId 識別，包含場次名稱、日期時間、場地、票種列表
- **票種（Section）**：由 sectionId 識別，包含票種名稱、價格、剩餘數量、販售狀態
- **訂單（Order）**：由 orderId 識別，格式為 `FG_YYMMDD_USERID_XXXX`

## 成功標準 *（強制）*

### 可衡量結果

- **SC-001**：從程式啟動到抵達付款頁面的時間不超過 30 秒（在票種有庫存的情況下）
- **SC-002**：場次關鍵字匹配準確率達到 100%（精確匹配設定的關鍵字）
- **SC-003**：票種關鍵字匹配準確率達到 100%（精確匹配設定的關鍵字）
- **SC-004**：Cookie 登入成功率達到 100%（在 Cookie 有效期內）
- **SC-005**：追蹤器封鎖不影響核心購票功能的正常運作
- **SC-006**：系統能正確識別至少 3 種票種狀態（熱賣中、即將開賣、已結束）

## 假設

- 使用者已安裝必要的執行環境（Python、NoDriver 相依套件）
- 使用者有有效的 FANSI GO 帳號（如需登入功能）
- 目標活動頁面結構符合研究文件中記錄的結構
- Cloudflare Challenge 不會在正常瀏覽情況下持續觸發

## 範圍外

- 付款流程自動化（系統停止於付款方式選擇頁面）
- 多帳號輪換
- 票數監控和自動搶票排程
- 驗證碼自動識別（FANSI GO 目前無驗證碼）
