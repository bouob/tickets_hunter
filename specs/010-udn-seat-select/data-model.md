# 資料模型：UDN 售票網座位選擇

**分支**：`010-udn-seat-select` | **日期**：2025-12-17

## 概述

定義 UDN 售票網座位選擇功能涉及的核心實體、關係與狀態轉換。

---

## 實體定義

### 1. Seat（座位）

代表座位圖中的單一座位。

**屬性**：

| 屬性 | 類型 | 說明 | 範例 |
|------|------|------|------|
| `title` | string | 座位完整標題 | "2樓黃2D區-3排-14號" |
| `floor` | string | 樓層 | "2樓" |
| `area` | string | 區域名稱 | "黃2D區" |
| `row` | string | 排號（數字或字母） | "3排" / "H排" |
| `row_number` | int | 排號數值（字母轉換後） | 3 / 8 |
| `seat_number` | int | 座位號 | 14 |
| `dom_index` | int | DOM 中的索引位置 | 5 |
| `status` | SeatStatus | 座位狀態 | `available` |
| `css_class` | string | CSS 類別 | "empty up" |

**狀態 (SeatStatus)**：

```
┌──────────────┐
│  available   │  ← 可選擇（td.empty）
└──────┬───────┘
       │ click
       ▼
┌──────────────┐
│   selected   │  ← 已選擇（td.selected）
└──────┬───────┘
       │ confirm
       ▼
┌──────────────┐
│   in_cart    │  ← 已加入購物車
└──────────────┘

┌──────────────┐
│     sold     │  ← 已售出（td.people）
└──────────────┘
```

**座位標題解析規則**：

```
格式：{樓層}{區域}-{排數}-{座位號}號
正則：^(.+區)-(\d+|\w+)排-(\d+)號$

字母排轉換：
  A → 1, B → 2, ..., Z → 26
  AA → 27, AB → 28, ...
```

---

### 2. Area（票區）

代表售票區域（票價分區）。

**屬性**：

| 屬性 | 類型 | 說明 | 範例 |
|------|------|------|------|
| `name` | string | 區域名稱 | "特A區" |
| `price` | int | 票價（元） | 3680 |
| `status` | AreaStatus | 售票狀態 | `available` |
| `css_class` | string | CSS 類別 | "status_tr" |
| `is_excluded` | bool | 是否被排除關鍵字過濾 | false |

**狀態 (AreaStatus)**：

```
┌──────────────┐
│  available   │  ← 可選擇
└──────────────┘

┌──────────────┐
│   soldout    │  ← 已售完（class="Soldout"）
└──────────────┘

┌──────────────┐
│   excluded   │  ← 被 keyword_exclude 過濾
└──────────────┘
```

---

### 3. Session（場次）

代表活動的特定演出時間。

**屬性**：

| 屬性 | 類型 | 說明 | 範例 |
|------|------|------|------|
| `date` | string | 演出日期 | "2025/12/25" |
| `time` | string | 演出時間 | "19:30" |
| `display_text` | string | 顯示文字 | "2025/12/25 (週四) 19:30" |
| `status` | SessionStatus | 場次狀態 | `available` |
| `is_matched` | bool | 是否符合關鍵字 | true |

**狀態 (SessionStatus)**：

```
┌──────────────┐
│  available   │  ← 可選擇
└──────────────┘

┌──────────────┐
│   soldout    │  ← 已售完
└──────────────┘

┌──────────────┐
│   disabled   │  ← 已禁用
└──────────────┘
```

---

### 4. KeywordSet（關鍵字組）

代表使用者設定的關鍵字配置。

**屬性**：

| 屬性 | 類型 | 說明 | 範例 |
|------|------|------|------|
| `raw_string` | string | 原始設定字串 | `"\"12/25\",\"12/26\""` |
| `keywords` | list[Keyword] | 解析後的關鍵字陣列 | `["12/25", "12/26"]` |
| `logic_type` | LogicType | 關鍵字間邏輯 | `OR` |

**子類型 Keyword**：

| 屬性 | 類型 | 說明 | 範例 |
|------|------|------|------|
| `value` | string | 關鍵字值 | "12/25 週六" |
| `parts` | list[string] | AND 邏輯分解 | `["12/25", "週六"]` |
| `logic_type` | LogicType | 內部邏輯 | `AND`（空格分隔） |

**邏輯類型 (LogicType)**：

```
OR  ← 逗號分隔，任一匹配即可
AND ← 空格分隔，全部匹配才成功
```

---

### 5. SelectionConfig（選擇配置）

代表選擇行為的配置參數。

**屬性**：

| 屬性 | 類型 | 說明 | 預設值 |
|------|------|------|--------|
| `date_keyword` | string | 日期關鍵字 | "" |
| `date_auto_fallback` | bool | 日期遞補開關 | false |
| `area_keyword` | string | 區域關鍵字 | "" |
| `area_auto_fallback` | bool | 區域遞補開關 | false |
| `keyword_exclude` | string | 排除關鍵字 | "" |
| `auto_select_mode` | SelectMode | 自動選擇模式 | `from_top_to_bottom` |
| `ticket_number` | int | 購票數量 | 2 |
| `pass_date_is_sold_out` | bool | 跳過售罄日期 | true |

**選擇模式 (SelectMode)**：

```
from_top_to_bottom  ← 從第一個開始
from_bottom_to_top  ← 從最後一個開始
center              ← 從中間開始
random              ← 隨機選擇
```

---

### 6. StageDirection（舞台方向）

代表座位圖相對於舞台的方向。

**值**：

| 值 | CSS 類別 | 說明 |
|-----|---------|------|
| `up` | topright / topleft | 舞台在上方 |
| `down` | downright / downleft | 舞台在下方 |
| `left` | left | 舞台在左方 |
| `right` | right | 舞台在右方 |

---

## 實體關係

```
┌─────────────────────────────────────────────────────────────┐
│                        Activity                             │
│                       （活動）                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Session                              │
│                       （場次）                               │
│  - date, time, status                                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Area                                │
│                       （票區）                               │
│  - name, price, status                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Seat                                │
│                       （座位）                               │
│  - title, row, seat_number, status                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 狀態轉換

### 購票流程狀態機

```
┌──────────────────┐
│  page_activity   │  ← UTK0201: 活動頁面
│                  │     [點擊「立即購票」]
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  page_session    │  ← UTK0203: 場次選擇
│                  │     [日期關鍵字匹配 / 遞補]
│                  │     [點擊「前往購票」]
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│   page_area      │  ← UTK0204: 票區選擇
│                  │     [區域關鍵字匹配 / 遞補]
│                  │     [點擊票區列]
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│   page_seat      │  ← UTK0205: 座位選擇（彈出視窗）
│                  │     [自動選擇座位]
│                  │     [加入購物車]
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│   page_cart      │  ← 購物車頁面
└──────────────────┘
```

### 關鍵字匹配狀態機

```
                    ┌────────────────────┐
                    │  start_matching    │
                    └─────────┬──────────┘
                              │
                              ▼
                    ┌────────────────────┐
          ┌────────│  try_keyword_N     │────────┐
          │        └─────────┬──────────┘        │
          │                  │                   │
     matched              no match          all_failed
          │                  │                   │
          ▼                  ▼                   ▼
┌──────────────────┐ ┌────────────────┐ ┌────────────────────┐
│  early_return    │ │ try_next_kw    │ │  check_fallback    │
│  (選擇並停止)    │ │ (嘗試下一個)   │ │                    │
└──────────────────┘ └────────────────┘ └─────────┬──────────┘
                                                  │
                              ┌────────────────────┴────────────────────┐
                              │                                         │
                    fallback = true                            fallback = false
                              │                                         │
                              ▼                                         ▼
                    ┌────────────────────┐               ┌────────────────────┐
                    │  use_select_mode   │               │  wait_manual       │
                    │  (自動選擇)        │               │  (等待手動介入)    │
                    └────────────────────┘               └────────────────────┘
```

---

## 驗證規則

### Seat 驗證

1. `title` 必須符合格式：`{區域}-{排數}排-{座位號}號`
2. `row_number` 必須 > 0
3. `seat_number` 必須 > 0
4. `dom_index` 必須 >= 0

### KeywordSet 驗證

1. `raw_string` 可為空字串（表示無關鍵字匹配）
2. 解析後的 `keywords` 陣列長度可為 0
3. AND 邏輯的 `parts` 陣列長度必須 >= 1

### SelectionConfig 驗證

1. `ticket_number` 必須在 1-10 範圍內
2. `auto_select_mode` 必須為有效的 SelectMode 值
3. `date_auto_fallback` 和 `area_auto_fallback` 為布林值

---

## 約束

### 不變性約束

1. **座位唯一性**：同一座位圖中，每個 `title` 唯一
2. **DOM 索引連續性**：相鄰座位的 `dom_index` 差值為 1
3. **關鍵字優先級**：`keywords` 陣列索引越小，優先級越高

### 業務約束

1. **遞補開關獨立**：`date_auto_fallback` 和 `area_auto_fallback` 獨立運作
2. **排除優先**：`keyword_exclude` 過濾在關鍵字匹配之前執行
3. **售罄跳過**：售罄狀態的場次/票區不參與匹配
