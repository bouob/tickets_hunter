# 功能規格：UDN 售票網自動搶票功能

**功能分支**：`010-udn-seat-select`
**建立日期**：2025-12-17
**狀態**：草稿
**輸入**：使用者描述："實作 UDN 售票網 (tickets.udnfunlife.com) 完整搶票自動化功能"
**參考實作**：Feature 003 (Keyword Priority Fallback)

## 背景

UDN 售票網 (tickets.udnfunlife.com) 是 KHAM 家族成員，與 kham.com.tw、ticket.com.tw 共用相同的 UTK 後端系統。現有程式碼已有部分 UDN 支援（場次選擇、票區選擇），但缺少關鍵的座位自動選擇功能。

本功能需整合 Feature 003 的關鍵字優先匹配與條件回退機制，確保日期選擇和區域選擇遵循專案統一的選擇邏輯標準。

**參考網址**：
- 首頁：https://tickets.udnfunlife.com/application/utk01/utk0101_.aspx
- 演唱會範例：https://tickets.udnfunlife.com/application/UTK02/UTK0201_.aspx?PRODUCT_ID=P12YQQ5C

## 使用者情境與測試 *（強制）*

### 使用者故事 1 - 座位自動選擇（優先順序：P1）

使用者在 UDN 售票網搶購演唱會門票時，點選票區後會彈出座位選擇視窗。使用者希望系統能根據設定的購票數量，自動選擇適當數量的座位並加入購物車，省去手動逐個點選座位的時間。

**為何此優先順序**：座位自動選擇是目前 UDN 支援中唯一缺失的關鍵功能。沒有此功能，使用者必須手動點選座位，無法達成完整自動化搶票。

**獨立測試**：可透過進入 UDN 活動頁面，手動點選票區觸發選位視窗，驗證系統是否自動選擇正確數量的座位並成功加入購物車。

**驗收情境**：

1. **給定** 使用者已進入票區選位彈出視窗，且設定 ticket_number=2，**當** 視窗載入完成且有空位可選，**則** 系統自動選擇 2 個空位並顯示已選狀態
2. **給定** 使用者設定 ticket_number=4，但可用空位只有 3 個，**當** 系統嘗試選擇座位，**則** 系統選擇全部 3 個可用空位並提示使用者
3. **給定** 使用者設定優先連號座位，**當** 有連續相鄰的空位可選，**則** 系統優先選擇相鄰座位
4. **給定** 座位選擇完成，**當** 使用者點擊確認或系統自動確認，**則** 所選座位成功加入購物車

---

### 使用者故事 2 - 場次日期選擇與遞補（優先順序：P2）

使用者在 UDN 售票網活動頁面，需要根據日期關鍵字自動選擇特定場次。系統採用 **Early Return Pattern**（優先級驅動匹配），依序嘗試關鍵字，第一個成功即停止。當所有關鍵字都無法匹配時，根據 `date_auto_fallback` 設定決定是否啟用遞補機制。

**為何此優先順序**：場次選擇是完整購票流程的第一步，需要穩定可靠的關鍵字匹配功能，並支援智能遞補避免錯過購票機會。

**獨立測試**：可透過設定特定日期關鍵字，進入活動頁面後驗證系統是否正確選擇符合關鍵字的場次，或在關鍵字失敗時觸發遞補機制。

**驗收情境**：

1. **給定** 活動有多個場次且設定 date_keyword 為「"12/25","12/26"」（優先級遞減），**當** 12/25 場次可用，**則** 系統立即選擇 12/25 並停止（Early Return）
2. **給定** 設定 date_keyword 為「"12/25","12/26"」但 12/25 已售完，**當** 系統檢查第一個關鍵字失敗，**則** 自動嘗試第二個關鍵字 12/26
3. **給定** 所有關鍵字都無法匹配且 date_auto_fallback=true，**當** 系統觸發條件回退，**則** 根據 auto_select_mode 選擇第一個/最後一個/隨機場次
4. **給定** 所有關鍵字都無法匹配且 date_auto_fallback=false（嚴格模式），**當** 系統偵測到匹配失敗，**則** 不自動選擇，等待使用者手動介入
5. **給定** 設定 AND 邏輯關鍵字「"10/03 週六"」（空格分隔），**當** 頁面有「2025/10/03 (週六)」場次，**則** 系統正確匹配（必須同時包含「10/03」且「週六」）
6. **給定** 場次選擇完成，**當** 點擊「前往購票」按鈕，**則** 系統成功導航到票區選擇頁面

---

### 使用者故事 3 - 票區自動選擇與遞補（優先順序：P2）

使用者在票區選擇頁面，需要根據區域關鍵字自動選擇特定票區。系統採用與場次選擇相同的 **Early Return Pattern** 和 **條件回退機制**，並支援 `keyword_exclude` 排除不想要的區域。

**為何此優先順序**：票區選擇是連接場次選擇和座位選擇的關鍵步驟，需要正確過濾售完票區並支援智能遞補。

**獨立測試**：可透過設定特定區域關鍵字，進入票區選擇頁面後驗證系統是否正確選擇未售完且符合關鍵字的票區。

**驗收情境**：

1. **給定** 頁面有多個票區且設定 area_keyword 為「"特A區","特B區"」（優先級遞減），**當** 特A區可用且未售完，**則** 系統立即選擇特A區並停止
2. **給定** 設定 keyword_exclude 為「"輪椅","身障"」，**當** 頁面有「特A區輪椅席」符合 area_keyword，**則** 系統跳過此區域（被排除關鍵字過濾）
3. **給定** 符合關鍵字的票區已售完（Soldout class），**當** 系統嘗試選擇，**則** 跳過售完票區並嘗試下一個關鍵字
4. **給定** 所有關鍵字都無法匹配且 area_auto_fallback=true，**當** 系統觸發條件回退，**則** 根據 auto_select_mode 選擇可用票區
5. **給定** 所有關鍵字都無法匹配且 area_auto_fallback=false（嚴格模式），**當** 系統偵測到匹配失敗，**則** 不自動選擇，等待使用者手動介入
6. **給定** 票區點選成功，**當** 系統等待回應，**則** 成功觸發座位選擇彈出視窗

---

### 使用者故事 4 - 完整購票流程串接（優先順序：P3）

使用者希望從活動頁面開始，系統能自動完成「點擊購票 → 選擇場次 → 選擇票區 → 選擇座位 → 加入購物車」的完整流程，各步驟的遞補機制可獨立控制。

**為何此優先順序**：整合各個步驟形成完整流程，是功能完整性的最終驗證。

**獨立測試**：可透過從活動首頁開始，設定好所有參數後，驗證系統是否能自動完成整個購票流程直到購物車。

**驗收情境**：

1. **給定** 使用者在活動頁面 (UTK0201) 且已設定完整參數，**當** 點擊「立即購票」或「快速訂購」，**則** 系統自動進入場次選擇流程
2. **給定** 系統完成場次選擇 (UTK0203)，**當** 點擊「前往購票」，**則** 自動進入票區選擇頁面 (UTK0204)
3. **給定** 系統完成票區選擇，**當** 座位彈出視窗出現，**則** 自動選擇座位並加入購物車
4. **給定** 發生任何步驟失敗，**當** 系統偵測錯誤，**則** 記錄錯誤資訊並通知使用者
5. **給定** date_auto_fallback=true 且 area_auto_fallback=false，**當** 日期選擇失敗觸發遞補但區域選擇失敗不觸發，**則** 兩個遞補開關獨立運作

---

### 邊界案例

- 當選位視窗中所有座位都已售出時，系統應顯示提示並返回票區選擇
- 當網路延遲導致選位視窗載入緩慢時，系統應等待至 timeout 後重試
- 當使用者設定的 ticket_number 超過單筆訂單上限時，系統應選擇最大允許數量
- 當多個票區同時符合關鍵字時，系統應根據 auto_select_mode 決定選擇順序
- 當座位狀態在選擇過程中被其他人搶走時，系統應自動選擇其他可用座位
- 當日期/區域關鍵字為空字串時，系統應直接使用 auto_select_mode 選擇（無關鍵字匹配階段）
- 當 keyword_exclude 過濾掉所有區域時，系統應顯示無可用選項提示

## 需求 *（強制）*

### 功能需求

**座位自動選擇（核心）**

- **FR-001**：系統必須能偵測 UDN 票區選擇後彈出的座位選擇視窗
- **FR-002**：系統必須根據 settings.json 中的 ticket_number 設定，自動選擇指定數量的空位
- **FR-003**：系統必須能識別座位狀態（空位、已售出、已選擇、已加入購物車）
- **FR-004**：系統必須支援連號座位優先選擇策略（相鄰座位優先）
- **FR-005**：系統必須在座位選擇完成後自動觸發「加入購物車」動作

**場次選擇與遞補機制（Feature 003 整合）**

- **FR-006**：系統必須實作 Early Return Pattern，依關鍵字優先級順序嘗試匹配，第一個成功即停止
- **FR-007**：系統必須支援日期關鍵字 AND/OR 邏輯（逗號分隔=OR，空格分隔=AND）
- **FR-008**：系統必須實作 `date_auto_fallback` 條件回退開關：
  - **true**：關鍵字全部失敗時，根據 auto_select_mode 自動選擇可用選項
  - **false（預設）**：關鍵字全部失敗時，不自動選擇，等待手動介入（嚴格模式）
- **FR-009**：系統必須支援 `pass_date_is_sold_out` 設定，過濾已售罄場次
- **FR-010**：系統必須在選擇場次後自動點擊「前往購票」按鈕

**票區選擇與遞補機制（Feature 003 整合）**

- **FR-011**：系統必須實作 Early Return Pattern，依區域關鍵字優先級順序嘗試匹配
- **FR-012**：系統必須支援區域關鍵字 AND/OR 邏輯
- **FR-013**：系統必須實作 `area_auto_fallback` 條件回退開關：
  - **true**：關鍵字全部失敗時，根據 auto_select_mode 自動選擇可用選項
  - **false（預設）**：關鍵字全部失敗時，不自動選擇，等待手動介入（嚴格模式）
- **FR-014**：系統必須支援 `keyword_exclude` 排除關鍵字功能，過濾不想要的區域
- **FR-015**：系統必須過濾已售完票區（含 `Soldout` class 的元素）

**流程控制**

- **FR-016**：系統必須依循 UTK0201 → UTK0203 → UTK0204 → 選位視窗 的頁面流程
- **FR-017**：系統必須在每個步驟失敗時提供錯誤回饋
- **FR-018**：系統必須支援 auto_select_mode 設定（from top to bottom / from bottom to top / center / random）

**設定檔整合**

- **FR-019**：系統必須讀取並應用 settings.json 中的 date_auto_select 相關設定：
  - `date_keyword`：日期關鍵字
  - `date_auto_fallback`：日期遞補開關
- **FR-020**：系統必須讀取並應用 settings.json 中的 area_auto_select 相關設定：
  - `area_keyword`：區域關鍵字
  - `area_auto_fallback`：區域遞補開關
- **FR-021**：系統必須讀取並應用 settings.json 中的 ticket_number 設定
- **FR-022**：系統必須讀取並應用 settings.json 中的 keyword_exclude 設定
- **FR-023**：系統必須讀取並應用 settings.json 中的 udn_account/udn_password 設定（如需登入）

**除錯輸出**

- **FR-024**：系統必須在 verbose 模式下輸出關鍵字匹配日誌（含 T005-T024 標記格式）
- **FR-025**：系統必須在遞補觸發時輸出明確的回退日誌

### 關鍵實體

- **座位 (Seat)**：票區內的單一座位，包含位置資訊（區域、排、號）、狀態（可選/已售/已選）
- **票區 (Area)**：活動場地的票價分區，包含區域名稱、票價、售票狀態、是否被排除
- **場次 (Session)**：活動的特定演出時間，包含日期、時間、場次狀態、是否售罄
- **購物車項目 (CartItem)**：已選座位的集合，準備進入結帳流程
- **關鍵字組 (KeywordSet)**：使用者設定的關鍵字陣列，按優先級排列

## 成功標準 *（強制）*

### 可衡量結果

- **SC-001**：從座位選擇視窗出現到完成選位並加入購物車，整體流程在 5 秒內完成
- **SC-002**：座位選擇準確率達 95%（選擇的座位數量符合 ticket_number 設定）
- **SC-003**：連號座位選擇成功率達 80%（當有連號座位可選時）
- **SC-004**：完整購票流程（場次 → 票區 → 座位 → 購物車）在 15 秒內完成
- **SC-005**：售完票區/場次過濾準確率達 100%（不會點選已售完的選項）
- **SC-006**：日期/區域關鍵字匹配準確率達 90%
- **SC-007**：Early Return Pattern 正確性達 100%（第一個匹配成功的關鍵字即停止）
- **SC-008**：條件回退機制觸發準確率達 100%（僅在所有關鍵字失敗且開關為 true 時觸發）
- **SC-009**：keyword_exclude 過濾準確率達 100%（不會選擇含排除關鍵字的選項）

## 假設與約束

### 假設

- UDN 網站結構與 KHAM 家族其他網站相似，共用 UTK 後端系統
- 座位選擇視窗為標準 DOM 結構，非 Shadow DOM 或 iframe
- 使用者已事先登入 UDN 帳號或設定帳密自動登入
- 網路環境穩定，頁面載入時間在合理範圍內
- Feature 003 的關鍵字解析邏輯可直接複用

### 約束

- 必須遵循 NoDriver First 原則（憲法第 I 條）
- 程式碼禁止使用 emoji（Windows cp950 編碼限制）
- 必須使用設定驅動架構（憲法第 V 條）
- reCaptcha 驗證暫不處理（UDN 使用 reCaptcha，非圖形驗證碼）
- 必須與現有 KHAM 邏輯保持相容性
- 日期/區域遞補機制必須符合 Feature 003 的設計標準
- `date_auto_fallback` 和 `area_auto_fallback` 預設值必須為 false（嚴格模式）

## 範圍外

- reCaptcha 自動解決方案
- 付款流程自動化
- UDN 帳號自動註冊
- 座位圖視覺化顯示

## 參考文件

- [Stage 4: 日期選擇機制](../../docs/03-mechanisms/04-date-selection.md) - Early Return Pattern 與條件回退詳細說明
- [Stage 5: 區域選擇機制](../../docs/03-mechanisms/05-area-selection.md) - 區域選擇與 keyword_exclude 詳細說明
- Feature 003: Keyword Priority Fallback - 完整實作指南
