# 任務：UDN 售票網自動搶票功能

**分支**：`010-udn-seat-select` | **日期**：2025-12-17
**輸入**：來自 `/specs/010-udn-seat-select/` 的設計文件
**先決條件**：plan.md、spec.md、research.md、data-model.md、contracts/

**組織**：任務按使用者故事分組，以實現每個故事的獨立實作和測試。

## 格式：`[ID] [P?] [Story] 描述`

- **[P]**：可平行執行（不同檔案、無相依性）
- **[Story]**：此任務屬於哪個使用者故事（US1、US2、US3、US4）
- 在描述中包含確切的檔案路徑

---

## 階段 1：設定（共享基礎設施）

**目的**：確認開發環境和現有程式碼位置

- [x] T001 確認 Python 3.10+ 環境和 NoDriver 相依性已安裝
- [x] T002 確認 `src/nodriver_tixcraft.py` 中 KHAM 座位選擇函數位置（行 18807-19172）
- [x] T003 [P] 確認 `src/settings.json` 結構，識別新增設定項目位置

---

## 階段 2：基礎（阻擋先決條件）

**目的**：在任何使用者故事可實作之前必須完成的核心修改

**關鍵**：此階段完成後，使用者故事可依優先順序實作

- [x] T004 在 `src/settings.json` 新增 `date_auto_select.date_auto_fallback` 設定項目（預設 `false`）（已存在於根層級）
- [x] T005 [P] 在 `src/settings.json` 新增 `area_auto_select.area_auto_fallback` 設定項目（預設 `false`）（已存在於根層級）
- [x] T006 在 `src/nodriver_tixcraft.py` 新增設定讀取邏輯，支援 `date_auto_fallback` 和 `area_auto_fallback`（已存在於行 16417, 16803）
- [x] T006.1 [P] 確認現有 KHAM 程式碼已支援 `udn_account`/`udn_password` 設定讀取（FR-023）；若不存在則新增讀取邏輯（已存在於行 17620-17624）

**檢查點**：設定項目就緒——現在可以開始使用者故事實作

---

## 階段 3：使用者故事 1 - 座位自動選擇（優先順序：P1）MVP

**目標**：在 UDN 票區選擇後彈出的座位選擇視窗中，自動選擇指定數量的座位並加入購物車

**獨立測試**：進入 UDN 活動頁面，手動點選票區觸發選位視窗，驗證系統自動選擇正確數量的座位

**FR 對應**：FR-001~FR-005、SC-001~SC-003

### 使用者故事 1 的實作

- [x] T007 [US1] 在 `src/nodriver_tixcraft.py` 新增 `nodriver_udn_seat_auto_select()` 函數框架（複用 KHAM 邏輯，行 17508-17523）
- [x] T008 [US1] 實作座位偵測邏輯：使用選擇器 `#TBL td.empty` 識別可用座位（複用 KHAM 邏輯）
- [x] T009 [US1] 實作座位狀態識別：區分 `empty`（可選）、`people`（已售）、`selected`（已選/已加入購物車）（複用 KHAM 邏輯）
- [x] T009.1 [US1] 實作座位競態條件處理：當點擊座位後狀態變為已售時，自動選擇其他可用座位（複用 KHAM 邏輯）
- [x] T010 [US1] 實作連號座位優先選擇策略：使用 DOM 索引檢測相鄰座位（複用 KHAM 邏輯）
- [x] T011 [US1] 實作舞台方向智慧選座：根據 `.stageDirection` class 決定選座策略（複用 KHAM 邏輯）
- [x] T012 [US1] 實作座位點擊邏輯：按 `ticket_number` 設定選擇指定數量座位（複用 KHAM 邏輯）
- [x] T013 [US1] 實作「加入購物車」按鈕點擊：選擇器 `button.sumitButton`（複用 KHAM 邏輯）
- [x] T014 [US1] 在 `nodriver_kham_main()` 新增 UDN 網域判斷（行 17508-17523），當 URL 包含 `udnfunlife.com` 時呼叫座位選擇邏輯
- [x] T015 [US1] 新增 `[UDN SEAT]` 和 `[SUCCESS]` 日誌標記輸出（行 17513, 17520）

**檢查點**：UDN 座位自動選擇功能可獨立運作

---

## 階段 4：使用者故事 2 - 場次日期選擇與遞補（優先順序：P2）

**目標**：根據日期關鍵字自動選擇場次，支援 Early Return Pattern 和條件回退

**獨立測試**：設定特定日期關鍵字，驗證系統正確選擇符合關鍵字的場次，或在關鍵字失敗時觸發遞補

**FR 對應**：FR-006~FR-010、SC-006~SC-008

### 使用者故事 2 的實作

- [x] T016 [US2] 在 `src/nodriver_tixcraft.py` 修改 `nodriver_kham_date_auto_select()`（行 16401-16650）已支援 UDN 網域與 Feature 003 邏輯
- [x] T017 [US2] 實作 Early Return Pattern：依關鍵字優先級順序嘗試，第一個成功即停止（行 16526-16563）
- [x] T018 [US2] 實作 AND/OR 邏輯：逗號分隔=OR，空格分隔=AND（行 16539-16547）
- [x] T019 [US2] 實作 `date_auto_fallback` 條件回退（行 16583-16597）：
  - `true`：關鍵字全部失敗時，根據 `auto_select_mode` 自動選擇
  - `false`：關鍵字全部失敗時，返回 False 等待手動介入
- [x] T020 [US2] 實作 `pass_date_is_sold_out` 售罄場次過濾（行 16472-16474 for UDN）
- [x] T021 [US2] 新增 `[DATE KEYWORD]`、`[DATE SELECT]`、`[DATE FALLBACK]` 日誌標記（行 16532, 16555, 16589）

**檢查點**：日期選擇與遞補機制可獨立運作

---

## 階段 5：使用者故事 3 - 票區自動選擇與遞補（優先順序：P2）

**目標**：根據區域關鍵字自動選擇票區，支援 Early Return Pattern、條件回退和 keyword_exclude

**獨立測試**：設定特定區域關鍵字，驗證系統正確選擇未售完且符合關鍵字的票區

**FR 對應**：FR-011~FR-015、SC-006、SC-008、SC-009

### 使用者故事 3 的實作

- [x] T022 [US3] 在 `src/nodriver_tixcraft.py` 修改 `nodriver_kham_area_auto_select()`（行 16790-17213）已支援 Feature 003 邏輯
- [x] T023 [US3] 實作 Early Return Pattern：依區域關鍵字優先級順序嘗試（行 17144-17153, 16901-16906）
- [x] T024 [US3] 實作 AND/OR 邏輯：與日期選擇相同（行 16892, 17132）
- [x] T025 [US3] 實作 `keyword_exclude` 排除過濾：在關鍵字匹配前執行（行 16882-16885, 17108-17110）
- [x] T026 [US3] 實作 `area_auto_fallback` 條件回退（行 16803, 16916-16932, 17170-17186）：
  - `true`：關鍵字全部失敗時，根據 `auto_select_mode` 自動選擇
  - `false`：關鍵字全部失敗時，返回 False 等待手動介入
- [x] T027 [US3] 實作售完票區過濾：跳過含 `售完` 或 `Soldout` 的元素（行 17082-17083）
- [x] T028 [US3] 新增 `[KHAM AREA KEYWORD]`、`[KHAM AREA SELECT]`、`[KHAM AREA FALLBACK]` 日誌標記（行 16905, 16919, 17152, 17173）

**檢查點**：區域選擇與遞補機制可獨立運作

---

## 階段 6：使用者故事 4 - 完整購票流程串接（優先順序：P3）

**目標**：整合場次選擇、票區選擇、座位選擇形成完整自動化流程

**獨立測試**：從活動首頁開始，驗證系統自動完成整個購票流程直到購物車

**FR 對應**：FR-016~FR-018、SC-004、SC-005

### 使用者故事 4 的實作

- [x] T029 [US4] 在 `nodriver_kham_main()` 確認 UTK0201 活動頁面處理邏輯（購買按鈕點擊）（行 17566-17576）
- [x] T030 [US4] 確認 UTK0203 場次選擇頁面導航到 UTK0204 的流程（行 17645-17667）
- [x] T031 [US4] 新增 UTK0204 票區選擇頁面處理邏輯（行 17669-17688）
- [x] T032 [US4] 驗證 `date_auto_fallback` 和 `area_auto_fallback` 獨立運作（行 16417, 16803 獨立讀取）
- [x] T033 [US4] 新增完整流程日誌標記：`[UDN SEAT]`、`[UDN AREA]`、`[SUCCESS]`（行 17513, 17676）

**檢查點**：完整購票流程從活動頁面到購物車可自動完成

---

## 階段 7：收尾與跨領域關注點

**目的**：文件同步、程式碼品質、驗證

- [x] T034 [P] 更新 `docs/02-development/structure.md` 新增 UDN 座位選擇函數索引
- [x] T035 [P] 更新 `docs/03-mechanisms/` 相關文件，記錄 UDN 整合細節（04-date-selection.md, 05-area-selection.md）
- [ ] T036 執行 `quickstart.md` 中的快速測試驗證所有功能（需 MCP 連接 UDN 測試頁面）
- [ ] T037 執行 MCP 即時除錯驗證頁面互動（需 MCP 連接 UDN 測試頁面）
- [x] T038 程式碼檢查：確認無 emoji、符合 cp950 編碼
- [ ] T039 [P] 更新 CHANGELOG.md 記錄功能變更

---

## 相依性與執行順序

### 階段相依性

- **設定（階段 1）**：無相依性——可立即開始
- **基礎（階段 2）**：依賴設定完成——阻擋所有使用者故事
- **使用者故事 1（階段 3）**：依賴基礎完成——P1 優先
- **使用者故事 2（階段 4）**：依賴基礎完成——可與 US1 平行（不同函數）
- **使用者故事 3（階段 5）**：依賴基礎完成——可與 US1/US2 平行（不同函數）
- **使用者故事 4（階段 6）**：依賴 US1/US2/US3 完成——整合驗證
- **收尾（階段 7）**：依賴所有使用者故事完成

### 使用者故事相依性圖

```
設定(1) → 基礎(2) ─┬→ US1(3) 座位選擇 ─┐
                   │                    │
                   ├→ US2(4) 日期遞補 ──┼→ US4(6) 流程整合 → 收尾(7)
                   │                    │
                   └→ US3(5) 區域遞補 ──┘
```

### 每個使用者故事內

- 框架先於實作
- 核心邏輯先於日誌輸出
- 故事完成後才移至下一優先順序（或平行進行）

### 平行機會

- T002、T003 可平行（設定階段確認）
- T004、T005 可平行（基礎階段設定項目）
- US1、US2、US3 可平行（不同函數，無相依性）
- T034、T035、T039 可平行（收尾階段文件更新）

---

## 平行範例：使用者故事 1-3 平行開發

```bash
# 基礎階段完成後，可同時啟動：

# 開發者 A：使用者故事 1（座位選擇）
任務："在 src/nodriver_tixcraft.py 新增 nodriver_udn_seat_auto_select() 函數"

# 開發者 B：使用者故事 2（日期遞補）
任務："修改 nodriver_kham_date_auto_select() 新增 Feature 003 邏輯"

# 開發者 C：使用者故事 3（區域遞補）
任務："修改 nodriver_kham_area_auto_select() 新增 Feature 003 邏輯"
```

---

## 實作策略

### MVP 優先（僅使用者故事 1）

1. 完成階段 1：設定
2. 完成階段 2：基礎
3. 完成階段 3：使用者故事 1（座位自動選擇）
4. **停止並驗證**：獨立測試座位選擇功能
5. 如準備就緒則可發布 MVP

### 增量交付

1. 完成設定 + 基礎 → 基礎準備就緒
2. 新增使用者故事 1 → 獨立測試 → MVP 完成
3. 新增使用者故事 2 → 獨立測試 → 日期遞補完成
4. 新增使用者故事 3 → 獨立測試 → 區域遞補完成
5. 新增使用者故事 4 → 獨立測試 → 完整流程整合
6. 收尾 → 發布

### 建議執行順序（單人開發）

```
T001 → T002 → T003 → T004 → T005 → T006
     → T007 → T008 → T009 → T010 → T011 → T012 → T013 → T014 → T015 （US1 完成）
     → T016 → T017 → T018 → T019 → T020 → T021 （US2 完成）
     → T022 → T023 → T024 → T025 → T026 → T027 → T028 （US3 完成）
     → T029 → T030 → T031 → T032 → T033 （US4 完成）
     → T034 → T035 → T036 → T037 → T038 → T039 （收尾完成）
```

---

## 註記

- [P] 任務 = 不同檔案、無相依性，可平行執行
- [Story] 標籤將任務對應到特定使用者故事以便追溯
- 每個使用者故事應可獨立完成和測試
- 每個任務或邏輯群組後使用 `/gsave` 提交
- 在任何檢查點停止以獨立驗證故事
- 本功能核心策略：複用 KHAM 座位選擇邏輯，新增 UDN 網域判斷
