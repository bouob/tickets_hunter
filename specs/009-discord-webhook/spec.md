# 功能規格：搶票成功 Discord Webhook 通知

**功能分支**：`009-discord-webhook`
**建立日期**：2025-12-04
**狀態**：草稿
**輸入**：使用者描述："搶票成功 Discord Webhook 通知：當搶票成功時透過 Discord Webhook 發送即時通知，用戶只需設定一個 webhook URL，觸發時機與現有音效通知相同（階段1找到票、階段2購票成功），通知內容包含平台名稱和提醒訊息，使用現有 requests 庫非同步發送，失敗時靜默處理不影響主流程"

## 使用者情境與測試 *（強制）*

### 使用者故事 1 - 購票成功即時通知（優先順序：P1）

身為搶票使用者，當系統成功搶到票或完成訂單時，我希望能收到 Discord 通知，這樣即使我不在電腦前也能立即知道並趕快去結帳。

**為何此優先順序**：這是功能的核心價值 — 讓使用者不錯過搶票成功的黃金結帳時間。

**獨立測試**：可透過設定 webhook URL 後執行搶票流程，驗證 Discord 頻道是否收到通知訊息。

**驗收情境**：

1. **給定** 使用者已設定有效的 Discord Webhook URL，**當** 系統找到可購票券（階段1），**則** Discord 頻道收到「找到票券」通知
2. **給定** 使用者已設定有效的 Discord Webhook URL，**當** 訂單成功進入結帳頁面（階段2），**則** Discord 頻道收到「訂單成功，請儘速結帳」通知
3. **給定** 使用者已設定有效的 Discord Webhook URL，**當** 通知發送成功，**則** 通知內容包含平台名稱和提醒訊息

---

### 使用者故事 2 - 在網頁設定介面填入 Webhook URL（優先順序：P1）

身為使用者，我只需要在 settings.html 網頁設定介面中填入一個 Discord Webhook URL，按下儲存後就能啟用通知功能，不需要任何複雜的設定步驟。

**為何此優先順序**：設定簡單是使用者採用此功能的關鍵，與核心通知功能同等重要。

**獨立測試**：可透過在 settings.html 頁面加入 webhook URL 欄位，驗證存檔後是否正確寫入 settings.json。

**驗收情境**：

1. **給定** 使用者在 settings.html 網頁介面填入 Discord Webhook URL 並按下儲存，**當** 系統啟動，**則** 系統從 settings.json 正確載入 webhook 設定
2. **給定** 使用者在 settings.html 網頁介面將 webhook URL 欄位留空並按下儲存，**當** 系統運行，**則** 系統正常運作且不發送任何 webhook 通知

---

### 使用者故事 3 - 通知失敗不影響搶票（優先順序：P2）

身為使用者，即使 Discord 通知發送失敗（網路問題、URL 錯誤等），搶票主流程也不應該受到任何影響。

**為何此優先順序**：搶票是核心功能，通知只是輔助，不能因為通知問題而影響搶票成功率。

**獨立測試**：可透過設定無效的 webhook URL，驗證搶票流程是否仍能正常完成。

**驗收情境**：

1. **給定** 使用者設定了無效的 Webhook URL，**當** 觸發通知發送，**則** 系統靜默處理錯誤，搶票流程繼續執行
2. **給定** 網路暫時中斷，**當** 觸發通知發送，**則** 系統不等待回應，搶票流程不受阻塞

---

### 邊界案例

- 當 Webhook URL 格式錯誤時，系統應靜默跳過通知發送
- 當 Discord 服務暫時不可用時，系統應在超時後放棄發送，不影響主流程
- 當同一階段被重複觸發時，應避免發送重複通知（與現有音效防重複機制一致）
- 當 Webhook URL 為空字串或未設定時，系統應完全跳過通知邏輯

## 需求 *（強制）*

### 功能需求

- **FR-001**：系統必須在 settings.html 網頁設定介面中提供 Discord Webhook URL 輸入欄位
- **FR-002**：使用者在 settings.html 填入 Webhook URL 並儲存後，系統必須將設定寫入 settings.json
- **FR-003**：系統必須在找到可購票券時（階段1）發送 Discord 通知
- **FR-004**：系統必須在訂單成功進入結帳頁面時（階段2）發送 Discord 通知
- **FR-005**：通知訊息必須包含平台名稱（如 TixCraft、ibon、KKTIX 等）
- **FR-006**：通知訊息必須包含明確的提醒文字（如「請儘速結帳」）
- **FR-007**：系統必須使用非同步方式發送通知，不阻塞搶票主流程
- **FR-008**：系統必須在通知發送失敗時靜默處理，不拋出異常或中斷流程
- **FR-009**：系統必須防止同一階段重複發送通知（與現有音效機制一致）
- **FR-010**：當 Webhook URL 未設定或為空時，系統必須跳過通知邏輯

### 關鍵實體

- **Webhook 設定**：Discord Webhook URL，透過 settings.html 設定，儲存於 settings.json
- **通知事件**：包含觸發階段（ticket/order）、平台名稱、通知訊息
- **通知狀態**：追蹤每個階段是否已發送通知，防止重複發送

## 成功標準 *（強制）*

### 可衡量結果

- **SC-001**：使用者設定 Webhook URL 後，100% 的搶票成功事件能觸發通知發送
- **SC-002**：通知從觸發到 Discord 頻道收到訊息的延遲不超過 3 秒
- **SC-003**：通知發送超時不超過 3 秒，失敗時不阻塞主流程
- **SC-004**：使用者在 settings.html 設定 Webhook 只需填入一個 URL 欄位並儲存，無需其他額外設定步驟

## 範圍外 *（可選）*

以下項目明確不在此功能範圍內：

- 支援其他通知平台（如 Telegram、Line Notify、Slack）
- 自訂通知訊息模板
- 通知發送歷史記錄
- 通知發送重試機制
- Webhook URL 驗證功能（測試按鈕）

## 假設 *（可選）*

- 使用者已有 Discord 帳號並知道如何建立 Webhook
- 系統已安裝 requests 庫（專案現有依賴）
- Discord Webhook API 保持穩定且向後相容
- 通知發送使用 HTTP POST 請求，超時設定為 3 秒
- settings.html 的儲存機制已正常運作，可直接新增欄位
