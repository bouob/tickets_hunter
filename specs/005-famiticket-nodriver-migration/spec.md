# 功能規格說明: FamiTicket NoDriver 遷移

**功能分支**: `005-famiticket-nodriver-migration`
**建立日期**: 2025-11-04
**狀態**: 草稿
**輸入**: 用戶描述: "將 FamiTicket (全家網) 從 Chrome 遷移到 NoDriver，實作完整票務自動化流程（帳號密碼登入、日期/區域選擇、驗證問題、自動補票），參考 Chrome 實作邏輯與 NoDriver TixCraft/KKTIX 模式"

## 用戶情境與測試 *(必填)*

### User Story 1 - 使用帳號密碼登入 FamiTicket (Priority: P1)

使用者希望系統能夠自動使用其 FamiTicket 帳號與密碼登入平台，無需手動輸入，以節省時間並提高搶票效率。

**優先級說明**: 登入是所有後續操作的前提，沒有登入就無法進行票務購買。這是最基礎且不可或缺的功能。

**獨立測試方式**: 可透過設定帳號/密碼後啟動系統，觀察是否成功登入並進入活動頁面，完整測試登入流程，並帶來「使用者免手動登入」的價值。

**驗收情境**:

1. **假設** 使用者已在設定檔中填寫正確的 FamiTicket 帳號與密碼，**當** 系統偵測到登入頁面（URL 包含 `/Home/User/SignIn`），**則** 系統自動填寫帳號、密碼並提交登入表單
2. **假設** 使用者填寫的帳號或密碼錯誤，**當** 系統嘗試登入，**則** 系統記錄錯誤訊息並停止執行
3. **假設** 使用者已登入（session 有效），**當** 系統訪問 FamiTicket，**則** 系統跳過登入步驟，直接進入活動頁面

---

### User Story 2 - 自動選擇符合條件的演出日期 (Priority: P1)

使用者希望系統能夠根據其設定的日期關鍵字（例如："週六"、"12/25"、"聖誕節"），自動從所有可用日期中選擇符合條件的演出場次，避免手動逐一檢查。

**優先級說明**: 日期選擇是票務自動化的核心功能，直接決定使用者能否搶到目標場次。

**獨立測試方式**: 可透過設定日期關鍵字後訪問活動頁面，觀察系統是否正確匹配並選擇目標日期，完整測試日期選擇邏輯，並帶來「自動篩選目標場次」的價值。

**驗收情境**:

1. **假設** 使用者設定日期關鍵字為 "週六"，**當** 系統掃描日期列表，**則** 系統僅選擇日期文字中包含「週六」的項目
2. **假設** 使用者設定多個日期關鍵字（逗號分隔："12/25,12/26"），**當** 系統掃描日期列表，**則** 系統選擇任一匹配關鍵字的日期（OR 邏輯）
3. **假設** 沒有日期匹配關鍵字，**當** 系統完成掃描，**則** 系統使用自動選擇模式（`auto_select_mode`）作為回退機制
4. **假設** 日期列表包含已售完的日期，**當** 系統掃描，**則** 系統僅選擇包含「立即購買」按鈕的日期，過濾已售完項目
5. **假設** 日期列表為空（即將開賣頁面），**當** 使用者啟用自動補票功能，**則** 系統等待指定間隔後自動重新載入活動頁面

---

### User Story 3 - 自動選擇符合條件的演出區域 (Priority: P1)

使用者希望系統能夠根據其設定的區域關鍵字（例如："VIP"、"搖滾區"、"一樓"），自動從所有可用區域中選擇符合條件的座位區，避免手動逐一檢查。

**優先級說明**: 區域選擇是決定座位品質的關鍵功能，直接影響使用者的觀賞體驗。

**獨立測試方式**: 可透過設定區域關鍵字後進入區域選擇頁面，觀察系統是否正確匹配並選擇目標區域，完整測試區域選擇邏輯，並帶來「自動篩選目標座位區」的價值。

**驗收情境**:

1. **假設** 使用者設定區域關鍵字為 "VIP"，**當** 系統掃描區域列表，**則** 系統僅選擇區域文字中包含「VIP」的項目
2. **假設** 使用者設定多組 AND 關鍵字（例如："VIP,一樓"），**當** 系統掃描，**則** 系統僅選擇同時包含「VIP」和「一樓」的區域
3. **假設** 區域列表包含已售完的區域（class 包含 `"area disabled"`），**當** 系統掃描，**則** 系統自動過濾這些區域，僅選擇可購買的項目
4. **假設** 沒有區域匹配關鍵字，**當** 系統完成掃描，**則** 系統使用自動選擇模式作為回退機制

---

### User Story 4 - 自動回答驗證問題 (Priority: P1)

使用者希望系統能夠自動回答 FamiTicket 的驗證問題（例如：「請問活動名稱？」、「演出者是誰?」），避免手動輸入，提高自動化完整性。

**優先級說明**: 驗證問題是 FamiTicket 的防機器人機制，必須正確回答才能完成購票流程。

**獨立測試方式**: 可透過設定驗證問題答案後進入驗證頁面，觀察系統是否正確填寫答案並提交，完整測試驗證流程，並帶來「免手動回答驗證問題」的價值。

**驗收情境**:

1. **假設** 使用者在設定檔中預設答案為「五月天演唱會」，**當** 系統偵測到驗證問題輸入框（`#verifyPrefAnswer`），**則** 系統自動填寫答案並提交
2. **假設** 使用者啟用自動猜測功能（`auto_guess_options: true`），**當** 驗證問題出現，**則** 系統嘗試從活動標題、描述中推斷答案
3. **假設** 使用者提供的答案錯誤，**當** 系統提交後驗證失敗，**則** 系統將該答案加入錯誤清單（`fail_list`），避免重複嘗試

---

### User Story 5 - 自動補票（重新載入頁面） (Priority: P2)

使用者希望當目標演出尚未開賣（日期列表為空）時，系統能夠自動定期重新載入頁面，直到日期出現，避免手動不斷重新整理。

**優先級說明**: 自動補票功能可大幅提升搶票成功率，特別是在熱門活動即將開賣時。雖然非核心流程，但對使用者體驗有重大影響。

**獨立測試方式**: 可透過訪問即將開賣的活動頁面（日期列表為空），並啟用自動補票功能，觀察系統是否定期重新載入，完整測試補票邏輯，並帶來「免手動重新整理」的價值。

**驗收情境**:

1. **假設** 日期列表為空，**當** 使用者啟用自動補票（`auto_reload_coming_soon_page: true`）且設定間隔為 5 秒（`auto_reload_page_interval: 5`），**則** 系統等待 5 秒後自動重新載入活動頁面
2. **假設** 日期列表為空，**當** 使用者未啟用自動補票（`auto_reload_coming_soon_page: false`），**則** 系統停止執行，等待手動介入
3. **假設** 系統重新載入頁面後發現日期已出現，**當** 再次掃描，**則** 系統繼續執行日期選擇邏輯

---

### 邊界情境

- **當帳號/密碼錯誤時會怎樣？**
  系統應記錄錯誤訊息（例如：「登入失敗，請檢查帳號密碼」）並停止執行，避免重複嘗試導致帳號被鎖定。

- **當日期列表一直為空（即將開賣頁面）且啟用自動補票時會怎樣？**
  系統會持續重新載入活動頁面，直到日期出現或使用者手動停止程式。

- **當所有區域都已售完時會怎樣？**
  系統應記錄「無可用區域」訊息並停止執行，通知使用者票已售罄。

- **當網路連線中斷時會怎樣？**
  系統應捕捉網路例外（例如：`TimeoutException`）並記錄錯誤，避免程式崩潰。

- **當 FamiTicket 更改頁面結構導致 CSS 選擇器失效時會怎樣？**
  系統應記錄「元素未找到」錯誤，並在除錯模式下輸出詳細的 HTML 結構，協助開發者更新選擇器。

- **當使用者同時設定多組區域關鍵字但都無法匹配時會怎樣？**
  系統應嘗試所有關鍵字組合後，使用自動選擇模式（`auto_select_mode`）作為最終回退機制。

- **當購買按鈕（`#buyWaiting`）不存在時會怎樣？**
  系統應重新整理頁面（最多重試 3 次），若仍未出現則記錄錯誤並停止執行。

## 需求 *(必填)*

### 功能性需求

#### 認證（Authentication）

- **FR-001**: 系統必須支援使用帳號與密碼登入 FamiTicket 平台
- **FR-002**: 系統必須自動偵測登入頁面（URL 包含 `/Home/User/SignIn`）
- **FR-003**: 系統必須從設定檔讀取 FamiTicket 帳號（`advanced.fami_account`）與密碼（`advanced.fami_password` 或 `advanced.fami_password_plaintext`）
- **FR-004**: 系統必須使用正確的 CSS 選擇器填寫帳號（`#usr_act`）與密碼（`#usr_pwd`）輸入框

#### 活動頁面處理（Activity Page Handling）

- **FR-005**: 系統必須自動偵測活動資訊頁面（URL 包含 `/Home/Activity/Info/`）
- **FR-006**: 系統必須自動點擊「購買」按鈕（CSS 選擇器：`#buyWaiting`）
- **FR-007**: 當購買按鈕不存在時，系統必須重新整理頁面並重試
- **FR-008**: 系統必須支援使用 CDP (Chrome DevTools Protocol) 點擊按鈕，提供更接近真實使用者的互動行為

#### 日期選擇（Date Selection）

- **FR-009**: 系統必須從設定檔讀取日期關鍵字（`date_auto_select.date_keyword`）
- **FR-010**: 系統必須掃描所有可用日期（CSS 選擇器：`table.session__list > tbody > tr`）
- **FR-011**: 系統必須根據關鍵字匹配目標日期，支援多關鍵字（逗號分隔）與 OR 邏輯
- **FR-012**: 系統必須僅選擇包含「立即購買」按鈕的日期，過濾已售完項目
- **FR-013**: 系統必須支援從日期列中提取日期文字（CSS 選擇器：`td:nth-child(1)`）與區域文字（`td:nth-child(2)`）
- **FR-014**: 當沒有匹配的日期時，系統必須使用自動選擇模式（`date_auto_select.mode`）作為回退機制（例如：選擇第一個可用日期）
- **FR-015**: 當啟用自動補票（`tixcraft.auto_reload_coming_soon_page: true`）且日期列表為空時，系統必須等待指定間隔（`advanced.auto_reload_page_interval`）後重新載入活動頁面

#### 區域選擇（Area Selection）

- **FR-016**: 系統必須從設定檔讀取區域關鍵字（`area_auto_select.area_keyword`）
- **FR-017**: 系統必須掃描所有可用區域（CSS 選擇器：`div > a.area`）
- **FR-018**: 系統必須根據關鍵字匹配目標區域，支援 AND 邏輯（多關鍵字必須同時存在）
- **FR-019**: 系統必須過濾已停用的區域（class 屬性包含 `"area disabled"`）
- **FR-020**: 當沒有匹配的區域時，系統必須使用自動選擇模式（`area_auto_select.mode`）作為回退機制

#### 驗證問題（Verification Question）

- **FR-021**: 系統必須自動偵測驗證問題頁面（包含 CSS 選擇器 `#verifyPrefAnswer` 的輸入框）
- **FR-022**: 系統必須從設定檔讀取驗證問題答案（`area_auto_select.area_answer` 或其他相關欄位）
- **FR-023**: 系統必須支援自動猜測答案功能（當 `advanced.auto_guess_options: true` 時）
- **FR-024**: 系統必須追蹤錯誤答案（使用 `fail_list` 資料結構），避免重複嘗試相同的錯誤答案
- **FR-025**: 系統必須重用現有的驗證問題處理工具函數（例如：`fill_common_verify_form()`、`guess_tixcraft_question()`）

#### 設定檔相容性（Configuration Compatibility）

- **FR-026**: 系統必須重用現有的 `tixcraft.auto_reload_coming_soon_page` 設定（不新增 FamiTicket 專屬欄位）
- **FR-027**: 系統必須重用現有的 `advanced.auto_reload_page_interval` 設定
- **FR-028**: 系統必須支援現有的 `date_auto_select` 與 `area_auto_select` 設定結構
- **FR-029**: 使用者切換 `webdriver_type` 為 `nodriver` 或 `chrome` 時，無需修改其他設定即可使用 FamiTicket

#### NoDriver API 遷移（NoDriver API Migration）

- **FR-030**: 所有 FamiTicket 函數必須使用 async/await 語法（非同步函數）
- **FR-031**: 所有函數參數必須使用 NoDriver `tab` 物件，而非 Selenium `driver` 物件
- **FR-032**: 系統必須優先使用 CDP (Chrome DevTools Protocol) 進行元素互動（點擊、輸入）
- **FR-033**: 系統必須使用 Pierce 方法進行元素搜尋（`cdp.dom.perform_search()`），支援 Shadow DOM 穿透
- **FR-034**: 系統必須使用 NoDriver 的頁面導航方法（`await tab.get(url)`、`await tab.reload()`）
- **FR-035**: 系統必須使用 NoDriver 的等待方法（`await tab.sleep(seconds)`、`await asyncio.sleep(seconds)`）

#### 函數結構（Function Structure）

- **FR-036**: 系統必須實作以下核心函數：`nodriver_fami_login()`、`nodriver_fami_activity()`、`nodriver_fami_date_auto_select()`、`nodriver_fami_area_auto_select()`、`nodriver_fami_verify()`、`nodriver_famiticket_main()`
- **FR-037**: 主函數 `nodriver_famiticket_main()` 必須作為 URL 路由器，根據 URL 模式分派至對應的子函數
- **FR-038**: 每個函數必須返回布林值或簡單狀態（簡化狀態管理，遵循 NoDriver 現有模式）
- **FR-039**: 系統必須解除 `nodriver_tixcraft.py` 第 16841-16842 行的註解，啟用 FamiTicket 主函數呼叫

### 主要實體 *(資料相關)*

- **FamiTicket 登入憑證**: 代表使用者的 FamiTicket 帳號與密碼，從設定檔讀取（`fami_account`、`fami_password`）
- **日期列表**: 代表活動的所有可用演出日期，包含日期文字、區域文字、購買按鈕狀態
- **區域列表**: 代表單一演出日期的所有可用座位區域，包含區域名稱、售罄狀態
- **驗證問題答案字典**: 代表預設的驗證問題答案集合，用於自動填寫或猜測答案
- **錯誤答案清單（fail_list）**: 代表已嘗試但失敗的答案集合，避免重複嘗試
- **自動補票設定**: 代表自動重新載入的開關與間隔設定（`auto_reload_coming_soon_page`、`auto_reload_page_interval`）

## 成功標準 *(必填)*

### 可衡量成果

- **SC-001**: 使用者可使用帳號/密碼成功登入 FamiTicket，登入成功率達 100%（當帳號密碼正確時）
- **SC-002**: 系統可在 2 秒內完成日期列表掃描並匹配關鍵字，匹配成功率達 90%（當關鍵字設定正確時）
- **SC-003**: 系統可在 2 秒內完成區域列表掃描並匹配關鍵字，匹配成功率達 90%（當關鍵字設定正確時）
- **SC-004**: 當日期列表為空且啟用自動補票時，系統會在設定的間隔後自動重新載入頁面，觸發率達 100%
- **SC-005**: 系統可正確過濾已售完的日期與區域，過濾準確率達 100%
- **SC-006**: 遷移後的 NoDriver 版本功能完全對等於 Chrome 版本，功能覆蓋率達 100%（8 個核心函數全部實作）
- **SC-007**: 所有 FamiTicket NoDriver 函數通過 30 秒背景測試無 Python 語法錯誤，通過率達 100%
- **SC-008**: 使用者可透過設定檔切換 `webdriver_type` 為 `chrome` 或 `nodriver`，無需修改其他設定，相容性達 100%
- **SC-009**: 系統可在驗證問題頁面正確填寫答案，當答案正確時提交成功率達 100%
- **SC-010**: 當所有關鍵字匹配失敗時，系統可正確啟用自動選擇模式（`auto_select_mode`）作為回退機制，回退觸發率達 100%

## 假設與約束 *(選填)*

### 假設

1. **FamiTicket 頁面結構穩定**: 假設 FamiTicket 的 HTML 結構與 CSS 選擇器在短期內不會大幅變動（基於 Chrome 版本長期穩定運作）
2. **無 Shadow DOM**: 假設 FamiTicket 不使用 Shadow DOM 技術（基於 Chrome 程式碼分析，未見 Shadow DOM 處理邏輯）
3. **使用者擁有有效帳號**: 假設使用者已註冊 FamiTicket 帳號並擁有正確的帳號密碼
4. **使用者負責間隔設定**: 假設使用者會合理設定自動補票間隔（`auto_reload_page_interval`），避免過度頻繁請求導致 IP 被封鎖
5. **NoDriver 反偵測能力**: 假設 NoDriver 的反偵測技術足以通過 FamiTicket 的機器人偵測機制
6. **設定檔結構一致**: 假設 FamiTicket 設定欄位（`fami_account`、`fami_password` 等）已存在於 `settings.json` 結構中

### 約束

1. **遵循 NoDriver First 原則**: 本遷移必須嚴格遵循專案憲法第 I 條（NoDriver First），優先使用 NoDriver API，不得混用 Selenium 語法
2. **設定檔向後相容**: 不得破壞現有設定檔結構，必須重用 `tixcraft.*` 與 `advanced.*` 設定欄位
3. **函數命名規範**: 所有函數必須以 `nodriver_fami_` 或 `nodriver_famiticket_` 開頭，保持命名一致性
4. **測試驅動穩定性**: 遵循專案憲法第 VI 條，所有核心函數修改必須通過背景測試（30 秒 timeout）
5. **Chrome 版本維護模式**: Chrome 版本進入維護模式，僅修復嚴重錯誤，不接受新功能開發
6. **法律合規性**: 系統僅供個人使用，禁止用於商業黃牛行為，遵循台灣票務相關法規

## 憲法遵循聲明 *(必填)*

本功能規格完全遵循專案憲法（`.specify/memory/constitution.md`）的核心原則：

### 原則 I: NoDriver First（技術架構優先性）
- ✅ **完全遵循**: 本遷移將 FamiTicket 從 Chrome/Selenium 遷移至 NoDriver，符合「NoDriver > UC > Selenium」的優先順序
- ✅ **Chrome 版本進入維護模式**: 遷移完成後，Chrome FamiTicket 僅接受嚴重錯誤修復，不再開發新功能
- ✅ **推薦使用 NoDriver**: 預設使用 NoDriver 版本，提供最佳反偵測能力

### 原則 II: 資料結構優先（設計先於實作）
- ✅ **完全遵循**: 本規格先定義資料實體（登入憑證、日期列表、區域列表、驗證答案字典），再進入實作階段
- ✅ **結構決定一切**: 自動補票功能的資料結構（`auto_reload_coming_soon_page`、`auto_reload_page_interval`）已在現有設定檔中定義，無需新增欄位

### 原則 III: 三問法則（決策守門人）
- ✅ **是核心問題嗎？**: 是。FamiTicket 是台灣主要票務平台之一，目前 NoDriver 版本完全空白，影響使用者體驗
- ✅ **有更簡單方法嗎？**: 否。無法避免遷移，因為 Chrome 版本已進入維護模式，NoDriver 是未來方向
- ✅ **會破壞相容性嗎？**: 否。本遷移重用現有設定檔結構，使用者僅需切換 `webdriver_type` 即可

### 原則 IV: 單一職責與可組合性（函數設計原則）
- ✅ **完全遵循**: 每個函數僅負責單一職責（`fami_login` 僅處理登入、`fami_date_auto_select` 僅處理日期選擇）
- ✅ **小函數組合**: 主函數 `famiticket_main` 作為協調器，組合多個小函數完成完整流程

### 原則 V: 設定驅動開發（使用者友善設計）
- ✅ **完全遵循**: 所有行為由 `settings.json` 控制（帳號、密碼、關鍵字、自動補票開關、間隔設定）
- ✅ **無需修改程式碼**: 使用者切換 Chrome/NoDriver 僅需修改 `webdriver_type` 欄位

### 原則 VI: 測試驅動穩定性（品質守門人）
- ✅ **完全遵循**: 所有函數必須通過 30 秒背景測試（使用 `.temp/test_output.txt` 記錄輸出）
- ✅ **實際測試**: 遷移完成後必須在真實 FamiTicket 頁面上測試（至少測試登入、日期選擇、區域選擇流程）

### 原則 VII: MVP 原則（最小可行產品優先）
- ✅ **完全遵循**: 優先實作核心流程（P1 功能：登入、日期/區域選擇、驗證），後續迭代加入進階功能（P2：自動補票細節優化）
- ✅ **完整核心流程優先**: 確保基本購票流程完整可用，再優化邊界情況處理

### 原則 VIII: 文件與代碼同步（知識傳承）
- ✅ **完全遵循**: 本規格文件詳細記錄所有功能需求、成功標準、假設與約束，後續 `plan.md` 與 `tasks.md` 將與本規格保持同步
- ✅ **文件是代碼一部分**: 遷移完成後將更新 `docs/02-development/structure.md` 與 `docs/10-project-tracking/accept_changelog.md`

### 原則 IX: Git 提交規範與工作流程（版本控制紀律）
- ✅ **完全遵循**: 將使用 `gsave` 指令提交變更，commit 訊息採用英文主題行（例如："feat(nodriver): migrate FamiTicket from Chrome to NoDriver"）
- ✅ **分支工作流程**: 已建立功能分支 `005-famiticket-nodriver-migration`，完成後將合併回 `main`

**總結**: 本功能規格 100% 遵循專案憲法的所有核心原則，無任何衝突或例外。
