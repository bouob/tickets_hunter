# 功能規格：關鍵字分隔符號改善

**功能分支**：`002-keyword-delimiter-fix`
**建立日期**：2025-10-25
**狀態**：草稿
**問題來源**：GitHub Issue #23

## 問題描述

### 當前問題

在 TicketPlus 遠大售票平台的區域關鍵字匹配中，當使用者輸入價格關鍵字（例如「3,280」）時，程式會誤將其拆分為兩個獨立關鍵字「3」和「280」，導致匹配邏輯錯誤。

**範例**：
- 使用者設定：`"area_keyword": "3,280"`
- 當前行為：程式解析為 `["3", "280"]`（以逗號分隔）
- 預期行為：程式應解析為 `["3,280"]`（單一關鍵字）

### 根本原因

當前實作使用逗號（`,`）作為關鍵字分隔符號，與台灣地區的金額千位分隔符號衝突。

**影響範圍**：
- 日期關鍵字：受影響（可能包含逗號）
- 區域關鍵字：受影響（價格含逗號，如「3,280」）
- 時間控制關鍵字：受影響（時間格式可能包含逗號，如「09:30:00,14:15:30」）
- 排除關鍵字：受影響（可能包含逗號的文字）
- 所有平台：TixCraft、KKTIX、TicketPlus、iBon、KHAM 等

## 使用者場景與測試

### 使用者故事 1 - 修正關鍵字分隔符號（優先度：P1）

身為購票者，我希望能使用分號（`;`）來分隔多個關鍵字，讓我可以正確搜尋包含逗號的價格（如「3,280」）。

**此優先度的原因**：這是緊急 bug 修復，直接影響使用者的核心搶票功能。

**獨立測試**：可透過設定包含價格的區域關鍵字（如「3,280;1,680」），然後驗證系統正確匹配對應價格區域。

**驗收場景**：

1. **Given** 已配置區域關鍵字為「3,280;2,680」且 area_auto_select.enable = true，**When** 有多個價格區域可選時，**Then** 系統依序嘗試匹配「3,280」和「2,680」
2. **Given** 已配置區域關鍵字為「搖滾A區;搖滾B區」，**When** 選擇座位時，**Then** 系統依序嘗試匹配兩個區域
3. **Given** 已配置日期關鍵字為「10/03;10/05」，**When** 有多個日期可選時，**Then** 系統依序嘗試匹配兩個日期
4. **Given** 已配置時間控制關鍵字為「09:30:00;14:15:30」，**When** 系統檢查暫停/恢復條件時，**Then** 系統依序檢查兩個時間點
5. **Given** 舊設定檔使用逗號分隔（「3,280,2,680」），**When** 系統啟動時，**Then** 系統自動偵測並提示使用者更新設定

---

### 使用者故事 2 - 向後相容性處理（優先度：P2）

身為現有使用者，我希望系統能自動偵測舊格式的關鍵字設定，並提供清楚的遷移指引，讓我不會因格式變更而無法使用系統。

**此優先度的原因**：確保現有使用者的設定不會因更新而失效。

**獨立測試**：可透過載入舊格式的 settings.json，然後驗證系統顯示警告訊息並提供正確的新格式範例。

**驗收場景**：

1. **Given** settings.json 中 area_keyword 包含逗號但無分號，**When** 系統啟動時，**Then** 系統顯示警告訊息建議使用分號
2. **Given** 偵測到舊格式，**When** 系統顯示警告時，**Then** 警告訊息包含正確的新格式範例
3. **Given** 使用者選擇繼續使用舊格式，**When** 系統執行時，**Then** 系統仍能正常運作（但可能有匹配問題）

---

## 功能需求 (FR)

### FR-001：分隔符號變更
- **描述**：將關鍵字分隔符號從逗號（`,`）改為分號（`;`）
- **理由**：避免與金額千位分隔符號衝突
- **影響範圍**：
  - 區域關鍵字（area_keyword）
  - 日期關鍵字（date_keyword）
  - 排除關鍵字（keyword_exclude）
  - 時間控制關鍵字（idle_keyword、resume_keyword、idle_keyword_second、resume_keyword_second）

### FR-002：JSON 陣列格式支援
- **描述**：支援 JSON 陣列格式作為替代方案
- **範例**：`"area_keyword": ["3,280", "2,680"]`
- **優先度**：P2（與 FR-001 二選一）

### FR-003：向後相容性偵測
- **描述**：偵測舊格式設定並顯示警告
- **觸發條件**：關鍵字字串包含逗號但不包含分號
- **警告訊息範例**：
  ```
  [WARNING] 偵測到舊格式的關鍵字設定
  [WARNING] 當前設定: "3,280,2,680"
  [WARNING] 建議格式: "3,280;2,680"
  [WARNING] 或使用 JSON 陣列: ["3,280", "2,680"]
  ```

### FR-004：文件更新
- **描述**：更新所有相關文件以反映新格式
- **影響文件**：
  - README.md
  - docs/01-getting-started/setup.md
  - specs/001-ticket-automation-system/contracts/config-schema.md
  - specs/001-ticket-automation-system/quickstart.md

---

## 成功標準 (SC)

### SC-001：關鍵字正確解析
- **標準**：使用分號分隔的關鍵字 100% 正確解析
- **測試方法**：單元測試覆蓋 10+ 個測試案例

### SC-002：平台相容性
- **標準**：所有平台（TixCraft、KKTIX、TicketPlus、iBon、KHAM）正確使用新分隔符號
- **測試方法**：每個平台至少執行 1 次實際測試

### SC-003：向後相容性
- **標準**：舊格式設定觸發警告訊息，但不影響系統啟動
- **測試方法**：載入舊設定檔並驗證警告訊息

### SC-004：文件完整性
- **標準**：所有範例和說明使用新格式
- **測試方法**：grep 搜尋所有文件中的舊格式範例

---

## 非功能需求 (NFR)

### NFR-001：效能
- **要求**：關鍵字解析效能不受影響（< 1ms）

### NFR-002：可維護性
- **要求**：分隔符號定義為常數，便於未來修改

### NFR-003：可測試性
- **要求**：關鍵字解析邏輯獨立為函式，便於單元測試

---

## 核心設計原則

1. **最小影響原則**：僅修改關鍵字解析邏輯，不影響其他功能
2. **向後相容原則**：舊設定仍可運作，但會顯示警告
3. **文件同步原則**：程式碼與文件必須同步更新

---

## 平台特定考量

### 所有平台通用
- 關鍵字解析邏輯統一處理
- 分隔符號常數集中定義

### TicketPlus 特定
- 修復 `nodriver_ticketplus_unified_select` 函式中的關鍵字解析
- 修復 `nodriver_ticketplus_order_expansion_auto_select` 函式中的關鍵字解析

### TixCraft 特定
- 修復 `nodriver_tixcraft_area_auto_select` 函式中的 JSON 解析邏輯

### KKTIX 特定
- 修復 `nodriver_kktix_travel_price_list` 函式中的關鍵字解析

---

## 假設與約束

### 假設
- 使用者願意將逗號改為分號
- 大多數使用者會閱讀更新說明並更新設定

### 約束
- 必須維持向後相容性
- 不得影響現有已正常運作的設定
- 修改必須遵循憲法原則（單一職責、資料結構優先）

---

## 參考資料

- **相關 Issue**：GitHub Issue #23
- **憲法原則**：`.specify/memory/constitution.md`
- **現有實作**：`src/nodriver_tixcraft.py`
- **設定檔 Schema**：`specs/001-ticket-automation-system/contracts/config-schema.md`
