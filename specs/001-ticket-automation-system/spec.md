# 功能規格：多平台自動化搶票系統

**功能分支**：`001-ticket-automation-system`
**建立日期**：2025-10-16
**狀態**：草稿
**輸入**：使用者描述：「具有 12 階段購票工作流程的多平台自動化搶票系統」

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 自動化購票流程（優先度：P1）

身為購票者，我希望系統能自動完成從頭到尾的整個購票流程，讓我無需在關鍵搶票時間手動介入即可搶到票。

**此優先度的原因**：這是系統的核心價值主張。若沒有此功能，系統就沒有價值。

**獨立測試**：可透過配置目標活動、執行自動化、驗證票券訂單成功建立且無需手動介入，來完整測試此功能。

**驗收場景**：

1. **Given** 已配置活動 URL 和所需的票券條件，**When** 自動化啟動時，**Then** 系統導航至活動頁面並等待票券開賣
2. **Given** 票券已開賣，**When** 日期和座位選擇頁面出現時，**Then** 系統自動選擇已配置的日期和座位區域
3. **Given** 訂單表單已顯示，**When** 所有欄位填寫完成時，**Then** 系統成功送出訂單並確認購買

---

### 使用者故事 2 - 智慧日期與座位選擇（優先度：P1）

身為購票者，我希望系統使用關鍵字匹配搭配回退策略來選擇我偏好的日期和座位區域，讓我能最大化搶到想要票券的機會。

**此優先度的原因**：這對使用者滿意度至關重要 - 使用者需要能控制他們購買的票券類型。

**獨立測試**：可透過在配置中提供日期/區域關鍵字和模式，然後驗證系統選擇匹配選項或正確回退，來測試此功能。

**驗收場景**：

1. **Given** 已配置日期關鍵字（例如「10/03」）且 date_auto_select.enable = true，**When** 有多個日期可選時，**Then** 系統選擇匹配關鍵字的日期
2. **Given** 關鍵字未匹配任何日期且已配置選擇模式（例如「從上到下」），**When** date_auto_select.enable = true 時，**Then** 系統使用回退模式進行選擇
3. **Given** 區域關鍵字含排除項（例如排除「輪椅」）且 area_auto_select.enable = true，**When** 選擇座位時，**Then** 系統過濾掉排除區域並從剩餘選項中選擇
4. **Given** date_auto_select.enable = false，**When** 日期選擇頁面載入時，**Then** 系統完全不執行任何自動選擇，即使有配置關鍵字或模式
5. **Given** 關鍵字不匹配且未設定 auto_select_mode，**When** date_auto_select.enable = true 時，**Then** 系統停止並等待手動介入

---

### 使用者故事 3 - 自動身份認證（優先度：P2）

身為購票者，我希望系統使用儲存的憑證或 Cookie 自動登入售票平台，讓我不會因登入延遲而錯過搶票機會。

**此優先度的原因**：登入通常是必需的，但這是一次性設定 - 不如核心購票流程關鍵。

**獨立測試**：可透過配置帳號憑證或 Cookie，然後驗證系統在購票前成功認證，來測試此功能。

**驗收場景**：

1. **Given** 已配置平台憑證，**When** 系統遇到登入頁面時，**Then** 系統自動填寫憑證並送出登入表單
2. **Given** 已配置平台 Cookie，**When** 系統啟動時，**Then** 系統注入 Cookie 並在整個會話期間維持登入狀態

---

### 使用者故事 4 - 驗證碼處理（優先度：P2）

身為購票者，我希望系統使用 OCR 自動辨識並輸入驗證碼，並在需要時回退到手動輸入，讓驗證碼挑戰不會阻止成功購票。

**此優先度的原因**：驗證碼處理很常見但並非所有平台都使用。

**獨立測試**：可透過遇到驗證碼挑戰並驗證系統辨識它或提示手動輸入，來測試此功能。

**驗收場景**：

1. **Given** 已啟用 OCR 且出現驗證碼，**When** 系統偵測到驗證碼圖片時，**Then** 系統使用 OCR 辨識文字並自動輸入驗證碼
2. **Given** OCR 失敗或已停用，**When** 出現驗證碼時，**Then** 系統等待手動輸入並提供視覺/聽覺通知
3. **Given** 多次驗證碼失敗，**When** 達到重試限制時，**Then** 系統切換到手動輸入模式

---

### 使用者故事 5 - 多平台支援（優先度：P3）

身為跨區域的購票者，我希望系統支援多個售票平台（TixCraft、KKTIX、TicketPlus、iBon、KHAM 等），讓我可以用一個工具滿足所有購票需求。

**此優先度的原因**：多平台支援擴展實用性，但對單一平台的核心價值交付並非必要。

**獨立測試**：可透過配置不同平台的活動並驗證每個平台上的成功購票，來測試此功能。

**驗收場景**：

1. **Given** TixCraft 活動 URL，**When** 執行自動化時，**Then** 系統使用 TixCraft 特定的選擇器與工作流程
2. **Given** KKTIX 活動 URL，**When** 執行自動化時，**Then** 系統使用 KKTIX 特定的選擇器與工作流程
3. **Given** 平台特定功能（例如 TicketPlus 的展開面板），**When** 遇到時，**Then** 系統正確處理它們

---

### 使用者故事 6 - 配置驅動行為（優先度：P2）

身為購票者，我希望透過設定檔配置所有自動化行為而無需修改程式碼，讓我可以輕鬆為不同活動自訂系統。

**此優先度的原因**：配置對可用性至關重要，但建立在核心購票流程之上。

**獨立測試**：可透過修改 settings.json 並驗證行為變化而無需修改程式碼，來測試此功能。

**驗收場景**：

1. **Given** 設定中票券數量設為 3，**When** 票券選擇頁面載入時，**Then** 系統選擇正好 3 張票
2. **Given** 已配置自動重載間隔，**When** 等待開賣時，**Then** 系統以配置的間隔重新整理
3. **Given** 已啟用聲音通知，**When** 搶到票或送出訂單時，**Then** 播放配置的音訊檔案

---

### 使用者故事 7 - 錯誤復原與重試（優先度：P1）

身為購票者，我希望系統自動重試失敗的操作並處理常見錯誤，讓暫時性問題不會阻止成功購票。

**此優先度的原因**：錯誤處理對高流量搶票時段的可靠性至關重要。

**獨立測試**：可透過模擬錯誤（網路失敗、找不到元素）並驗證重試行為，來測試此功能。

**驗收場景**：

1. **Given** 元素點擊因攔截而失敗，**When** 錯誤發生時，**Then** 系統使用 JavaScript 點擊作為回退進行重試
2. **Given** 頁面重新整理導致暫時性錯誤，**When** 偵測到錯誤時，**Then** 系統等待並重試操作
3. **Given** 票券售罄且已配置刷新間隔，**When** 偵測到售罄狀態時，**Then** 系統根據 auto_reload_page_interval 持續重試並監控直到票券可用
4. **Given** 啟用詳細模式（verbose = true），**When** 任何錯誤發生時，**Then** 系統記錄詳細錯誤資訊供除錯使用

---

### 邊緣案例

- 當票券開賣時間超過預期延遲時會發生什麼？
  - 系統繼續監控並自動重載，直到開賣或達到最大等待時間

- 系統如何處理排隊頁面（例如 Cityline 等候室）？
  - 系統偵測排隊狀態，耐心等待，並在排隊清除後自動繼續

- 當目標日期/區域售罄時會發生什麼？
  - 系統根據配置的模式回退到替代日期/區域，或在無有效選項時停止

- 系統如何處理多種付款或配送方式？
  - 系統使用第一個可用選項，或如果已指定則使用配置的偏好

- 當平台佈局變更時會發生什麼？
  - 系統包含多種選擇器策略（CSS、XPath、文字匹配）以提高韌性

- 系統如何處理來自多位使用者的同時購買？
  - 每個自動化實例使用自己的瀏覽器會話獨立運作

## 需求 *(必填)*

### 功能需求

#### 階段 1：環境初始化
- **FR-001**：系統必須支援透過設定檔配置的多種 WebDriver 類型（NoDriver、Chrome Driver、Selenium）
- **FR-002**：系統必須使用配置的選項初始化瀏覽器（無頭模式、視窗大小、代理設定）
- **FR-003**：系統必須在配置時載入瀏覽器擴充功能（廣告攔截器、隱私工具）
- **FR-004**：系統必須驗證 settings.json 結構，並為無效配置提供清楚的錯誤訊息

#### 階段 2：身份認證
- **FR-005**：系統必須支援透過 Cookie 注入（tixcraft_sid、ibonqware）作為主要方法進行自動登入
- **FR-006**：系統必須支援透過使用者名稱/密碼憑證作為回退方法進行自動登入
- **FR-007**：系統必須在繼續購票操作前驗證登入狀態
- **FR-008**：系統必須在整個購票工作流程中維持會話狀態

#### 階段 3：頁面監控與重載
- **FR-009**：系統必須在等待票券開賣時以配置的間隔自動重載頁面
- **FR-010**：系統必須實作過熱保護，在達到閾值計數後增加重載間隔
- **FR-011**：系統必須偵測並關閉彈出視窗（廣告、公告、Cookie 同意）
- **FR-012**：系統必須偵測「即將開賣」頁面並繼續監控直到開賣
- **FR-013**：系統必須偵測排隊/等候室頁面並適當等待而不激進重載

#### 階段 4：日期選擇
- **FR-014**：系統必須偵測日期選擇佈局類型（按鈕、下拉選單、日曆）
- **FR-015**：系統必須取得所有可用日期選項及其狀態（可用、售罄）
- **FR-016**：系統必須在配置時過濾掉售罄的日期（pass_date_is_sold_out）
- **FR-017**：系統必須在 date_auto_select.enable = true 時才執行自動日期選擇
- **FR-017-1**：當自動選擇啟用且有配置關鍵字時，系統必須優先使用關鍵字匹配日期（支援多個逗號分隔的關鍵字）
- **FR-017-2**：當關鍵字不匹配且有設定 auto_select_mode 時，系統必須回退到基於模式的選擇（從上/下/中間/隨機）
- **FR-017-3**：當關鍵字不匹配且未設定 auto_select_mode 時，系統必須停止選擇並等待手動介入
- **FR-018**：當 date_auto_select.enable = false 時，系統必須完全忽略所有自動選擇設定（包括關鍵字和模式），讓使用者手動選擇日期
- **FR-019**：系統必須在進入下一階段前驗證日期選擇成功

#### 階段 5：區域/座位選擇
- **FR-020**：系統必須偵測區域選擇佈局類型（按鈕、下拉選單、座位圖、展開面板）
- **FR-021**：系統必須取得所有可用區域選項及定價和可用性資訊
- **FR-022**：系統必須使用排除關鍵字過濾區域（例如排除「輪椅」、「視線受阻」）
- **FR-023**：系統必須在 area_auto_select.enable = true 時才執行自動區域選擇
- **FR-023-1**：當自動選擇啟用且有配置關鍵字時，系統必須優先使用關鍵字匹配區域（支援多個逗號分隔的關鍵字）
- **FR-023-2**：當關鍵字不匹配且有設定 auto_select_mode 時，系統必須回退到基於模式的選擇（從上/下/中間/隨機）
- **FR-023-3**：當關鍵字不匹配且未設定 auto_select_mode 時，系統必須停止選擇並等待手動介入
- **FR-024**：當 area_auto_select.enable = false 時，系統必須完全忽略所有自動選擇設定（包括關鍵字和模式），讓使用者手動選擇區域
- **FR-025**：系統必須使用自動座位選擇演算法處理座位圖佈局
- **FR-026**：系統必須在配置時支援「允許非相鄰座位」選項

#### 階段 6：票券數量
- **FR-027**：系統必須偵測票券數量輸入類型（下拉選單、文字框、加減按鈕、價格清單）
- **FR-028**：系統必須將票券數量設為 settings.json 配置的值
- **FR-029**：系統必須處理請求數量超過可用票券的情況（選擇最大可用數量）
- **FR-030**：系統必須在繼續前驗證票券數量設定正確

#### 階段 7：驗證碼處理
- **FR-031**：系統必須偵測驗證碼類型（圖片驗證碼、reCAPTCHA、hCaptcha）
- **FR-032**：系統必須從配置的來源提取驗證碼圖片（canvas 元素、img 標籤）
- **FR-033**：系統必須在啟用時使用 OCR（ddddocr）辨識驗證碼文字
- **FR-034**：系統必須支援 beta OCR 模型選項以提高準確性
- **FR-035**：系統必須自動輸入辨識的驗證碼
- **FR-036**：系統必須根據配置支援強制送出或等待手動確認
- **FR-037**：系統必須在 OCR 停用或失敗時支援手動驗證碼輸入作為回退
- **FR-038**：系統必須支援驗證碼重新整理/重載功能
- **FR-039**：系統必須以可配置的最大重試次數重試驗證碼辨識

#### 階段 8：表單填寫
- **FR-040**：系統必須偵測所有必填表單欄位（姓名、電話、電子郵件、身份證號、地址）
- **FR-041**：系統必須在資料可用時自動填寫個人資訊欄位
- **FR-042**：系統必須使用使用者提供的答案處理自訂問題（user_guess_string）
- **FR-043**：系統必須在配置時支援常見問題的自動答案猜測

#### 階段 9：同意條款處理
- **FR-044**：系統必須偵測所有同意核取方塊、單選按鈕和切換開關
- **FR-045**：系統必須自動勾選所有同意/服務條款方塊
- **FR-046**：系統必須處理平台特定的同意對話框（實名驗證、活動參與）
- **FR-047**：系統必須在送出前驗證所有必要同意都已勾選

#### 階段 10：訂單確認與送出
- **FR-048**：系統必須在最終送出前檢視訂單詳情（票券數量、總價）
- **FR-049**：系統必須使用多種偵測策略定位並點擊訂單送出按鈕
- **FR-050**：系統必須處理點擊送出後出現的確認對話框
- **FR-051**：系統必須在搶到票時播放音訊通知（如已配置）
- **FR-052**：系統必須在送出訂單時播放音訊通知（如已配置）
- **FR-053**：系統必須透過偵測確認頁面驗證訂單送出成功

#### 階段 11：排隊與付款
- **FR-054**：系統必須偵測排隊/等候室頁面並解析排隊位置資訊
- **FR-055**：系統必須在排隊中等待而不採取可能觸發反機器人偵測的激進動作
- **FR-056**：系統必須偵測排隊處理完成並自動繼續
- **FR-057**：系統必須支援排隊失敗的自動重試（如針對特定平台配置）

#### 階段 12：錯誤處理與重試
- **FR-058**：系統必須偵測並分類錯誤類型（售罄、逾時、網路錯誤、系統錯誤）
- **FR-059**：系統必須在啟用詳細模式（advanced.verbose = true）時記錄所有錯誤的詳細資訊
- **FR-060**：系統必須自動重試失敗的操作，**NoDriver 版本必須使用 CDP 原生方法重試，禁止回退到 JavaScript 執行**
  - ✅ 允許：CDP 點擊重試（`dispatch_mouse_event`）
  - ✅ 允許：CDP DOM 重新查詢（`perform_search`）
  - ❌ 禁止：JavaScript 點擊回退（`element.click()` 已被平台偵測）
- **FR-061**：系統必須有可配置的重試間隔（auto_reload_page_interval），使用者可自訂刷新時間
- **FR-062**：系統必須透過音訊/視覺警報通知使用者關鍵錯誤
- **FR-063**：當偵測到票券售罄狀態時，系統必須根據配置的刷新間隔持續重試並監控直到票券可用，而非停止嘗試
- **FR-064**：NoDriver 版本的所有元素互動必須使用 CDP 原生方法，避免被反機器人系統偵測

### 關鍵實體 *(系統管理的資料)*

- **票券活動**：代表一個售票活動，包含 URL、平台類型、日期/時間、可用日期、可用區域、票券類型和定價
- **使用者配置**：包含所有使用者偏好，包括票券數量、日期/區域關鍵字、選擇模式、憑證、通知設定和重試參數
- **購買會話**：追蹤進行中的購票狀態，包括目前階段、已選日期、已選區域、票券數量、驗證碼嘗試次數和重試計數
- **平台適配器**：封裝每個支援售票平台的平台特定選擇器、工作流程和特殊處理需求

### 非功能性需求

#### 效能
- **NFR-001**：Shadow DOM 元素查詢必須在 5 秒內完成（NoDriver 版本目標：2-5秒）
- **NFR-002**：Shadow DOM 穿透首次成功率必須達 90% 以上（NoDriver 版本目標：95%+）
- **NFR-003**：DOM 查詢記憶體消耗必須控制在 10MB 以內（目標：<5MB）

#### 反偵測 (Anti-Detection)
- **NFR-004**：NoDriver 版本必須 100% 避免 JavaScript 執行（`tab.evaluate()`、`executeScript()`）
- **NFR-005**：NoDriver 版本的所有元素互動必須使用 CDP 原生事件（`dispatch_mouse_event`、`scroll_into_view_if_needed`）
- **NFR-006**：系統必須能通過常見反機器人檢測（reCAPTCHA v2、Cloudflare Challenge）而不被標記

#### 可靠性
- **NFR-007**：系統必須實作 CDP 原生方法優先策略，無需回退到 JavaScript
  - NoDriver 版本：純 CDP 實作
  - Chrome Driver 版本（遺留）：可保留 JavaScript 方法

## 成功標準 *(必填)*

### 可測量結果

- **SC-001**：使用者僅使用 settings.json 配置即可成功購票而無需修改原始碼（目標：95% 的使用案例）
- **SC-002**：系統在可用時成功選擇使用者的第一選擇日期和區域（目標：基於關鍵字匹配的 90% 成功率）
- **SC-003**：系統在 10 秒內完成從頁面載入到訂單送出的整個購票工作流程（不包括排隊等待時間）
- **SC-004**：驗證碼辨識準確率使用自動 OCR（ddddocr 標準模型）達到 70% 或更高
- **SC-005**：系統透過回退策略（JavaScript 點擊、CDP）成功處理瀏覽器元素互動失敗，成功率達 95%
- **SC-006**：系統支援至少 8 個主要售票平台（TixCraft、KKTIX、TicketPlus、iBon、KHAM、FamiTicket、Cityline、Ticketmaster），具有完整功能的購票工作流程
- **SC-007**：使用者在搶到票或發生錯誤時收到清楚的音訊/視覺通知（100% 通知傳遞率）
- **SC-008**：系統偵測到票券售罄時，根據配置的刷新間隔持續監控並自動重試，直到票券可用（100% 持續監控不中斷）
- **SC-009**：配置錯誤在啟動時偵測並提供有用的錯誤訊息（100% 驗證涵蓋率）
- **SC-010**：系統在高流量期間維持穩定運作而不崩潰或掛起（目標：搶票時段 99% 運作時間）
- **SC-011**：當 auto_select 功能停用（enable = false）時，系統 100% 不執行任何自動選擇動作，確保使用者完全手動控制

## 核心設計原則 *(架構指導)*

### 配置驅動架構
所有面向使用者的行為必須透過 settings.json 控制。使用者永遠不需要修改 Python 原始碼來自訂：
- 目標活動和 URL
- 票券偏好（數量、日期、區域）
- 認證憑證
- 重試和時間參數
- 通知偏好

### 反偵測優先架構（Anti-Detection First）

**原則**：NoDriver 版本必須避免所有會被售票平台偵測的操作。

**強制規則**：
- **禁止 JavaScript 執行**：不得使用 `tab.evaluate()`、`page.evaluate()` 或任何 JavaScript 注入
  - ❌ 禁止：`await tab.evaluate('document.querySelector(".btn").click()')`
  - ✅ 正確：使用 CDP `dispatch_mouse_event()` 執行原生點擊

- **DOM 查詢標準**：必須使用 CDP `perform_search()` 穿透 Shadow DOM
  - ✅ 原生穿透：`cdp.dom.perform_search(query, include_user_agent_shadow_dom=True)`
  - ❌ 禁止：JavaScript `querySelectorAll()` 或 `tab.find()`（基於 JS）

- **元素互動標準**：必須使用 CDP 原生事件
  - ✅ 點擊：`cdp.input_.dispatch_mouse_event(type_='mousePressed', ...)`
  - ✅ 滾動：`cdp.dom.scroll_into_view_if_needed(node_id=...)`
  - ❌ 禁止：JavaScript 點擊回退（`element.click()` 已被偵測）

**版本差異**：
- **NoDriver 版本**：嚴格遵循以上規則（Chrome 90+ 支援完整 CDP）
- **Chrome Driver 版本**（維護模式）：可保留 JavaScript 方法，但標記為遺留實作

**檢查清單**：
- [ ] 所有 DOM 查詢使用 `perform_search()`
- [ ] 所有點擊使用 `dispatch_mouse_event()`
- [ ] 不存在 `tab.evaluate()` 或 `executeScript()` 調用
- [ ] Shadow DOM 穿透使用 `include_user_agent_shadow_dom=True`

### 三層回退策略
每個關鍵操作（日期選擇、區域選擇）必須遵循以下決策鏈：

**前置檢查（總開關）**：
- 檢查 `{operation}_auto_select.enable` 設定值
- 若為 `false`：完全停用自動選擇，讓使用者手動點選（相當於功能停用狀態）
- 若為 `true`：繼續執行以下三層回退邏輯

**第一層（關鍵字匹配）**：
- 條件：有設定關鍵字（`{operation}_keyword` 非空）
- 動作：嘗試使用關鍵字匹配選項
- 成功：完成選擇
- 失敗：進入第二層

**第二層（自動選擇模式）**：
- 條件：有設定 `auto_select_mode`（從上/下/中間/隨機）
- 動作：使用配置的模式自動選擇
- 成功：完成選擇
- 失敗或未設定模式：進入第三層

**第三層（停止並等待手動）**：
- 條件：前兩層都失敗或未設定 `auto_select_mode`
- 動作：停止自動選擇，等待手動使用者介入

**關鍵設計要點**：
- `enable = false` 時，即使有關鍵字或模式設定也完全不執行自動選擇
- 每一層失敗後才進入下一層，形成漸進式回退機制
- 第三層是安全網：確保系統不會在無明確指示時強制選擇

### 函數分解原則
函數必須遵守：
- **單一職責**：每個函數執行一個明確定義的任務
- **可組合性**：小函數組合成較大的工作流程
- **可測試性**：清楚的輸入/輸出使獨立測試成為可能
- **可重用性**：平台無關的邏輯提取為共享工具

### WebDriver 策略優先順序
系統必須支援多種 WebDriver 策略並提供清楚指導：
- **NoDriver**（推薦）：最佳反偵測能力，現代非同步架構
- **Undetected Chrome**（舊版）：良好相容性，較舊系統的回退
- **Selenium**（測試）：開發/測試環境的標準 WebDriver

## 配置設定參考 *(settings.json 結構)*

### 基本設定
- `homepage`（字串）：目標活動 URL
- `webdriver_type`（字串）：驅動類型 - "chrome"、"nodriver"、"selenium"
- `ticket_number`（整數）：購買的票券數量
- `language`（字串）：UI 語言偏好

### 日期選擇設定
- `date_auto_select.enable`（布林）：啟用自動日期選擇
- `date_auto_select.date_keyword`（字串）：逗號分隔的日期關鍵字（例如「10/03,10/04」）
- `date_auto_select.mode`（字串）：回退模式 - "from top to bottom"、"from bottom to top"、"center"、"random"

### 區域選擇設定
- `area_auto_select.enable`（布林）：啟用自動區域選擇
- `area_auto_select.area_keyword`（字串）：逗號分隔的區域關鍵字（例如「VIP,A Zone」）
- `area_auto_select.mode`（字串）：回退模式（與日期選擇相同選項）
- `keyword_exclude`（字串）：逗號分隔的排除關鍵字（例如「wheelchair,obstructed」）

### 驗證碼設定
- `ocr_captcha.enable`（布林）：啟用自動 OCR 辨識
- `ocr_captcha.beta`（布林）：使用 beta OCR 模型以提高準確性
- `ocr_captcha.force_submit`（布林）：OCR 後自動送出 vs. 等待手動確認
- `ocr_captcha.image_source`（字串）：圖片提取來源 - "canvas" 或 "img"

### 身份認證設定（每個平台）
- `advanced.{platform}_account`（字串）：平台帳號使用者名稱
- `advanced.{platform}_password_plaintext`（字串）：平台密碼（明文）
- `advanced.tixcraft_sid`（字串）：TixCraft Cookie SID 用於快速登入
- `advanced.ibonqware`（字串）：iBon Cookie qware 用於快速登入

### 進階設定
- `advanced.verbose`（布林）：啟用詳細除錯記錄
- `advanced.headless`（布林）：以無頭模式執行瀏覽器
- `advanced.auto_reload_page_interval`（浮點數）：頁面重載間隔（秒）
- `advanced.auto_reload_overheat_count`（整數）：冷卻前的重載計數閾值
- `advanced.play_sound.ticket`（布林）：搶到票時播放聲音
- `advanced.play_sound.order`（布林）：送出訂單時播放聲音
- `advanced.play_sound.filename`（字串）：通知播放的音訊檔案

## 平台特定考量 *(選填)*

### 通用技術規範（所有平台）

**NoDriver 版本實作標準**：

1. **DOM 查詢**：
   - 必須使用 `cdp.dom.perform_search(query, include_user_agent_shadow_dom=True)`
   - 適用場景：按鈕查找、日期選項、區域選項、表單元素
   - 效能要求：5 秒內完成，首次成功率 >= 90%

2. **元素互動**：
   - 點擊：`cdp.input_.dispatch_mouse_event()` 模擬真實滑鼠事件
   - 滾動：`cdp.dom.scroll_into_view_if_needed()`
   - 禁止：`tab.evaluate()` 執行 JavaScript

3. **智能等待**：
   - 使用輪詢檢查 `perform_search()` 判斷元素是否出現
   - 初始等待 1.2-1.8 秒（隨機），最多額外等待 5 秒
   - 檢查間隔 0.3 秒

4. **資源清理**：
   - 必須調用 `cdp.dom.discard_search_results(search_id)` 釋放資源
   - 使用防禦性 try-except 避免清理失敗影響主流程

**Chrome Driver 版本（遺留）**：
- 可保留 DOMSnapshot 和 JavaScript 方法
- 僅接受嚴重錯誤修復（憲法原則 I）

---

### TixCraft（台灣）
- ✅ NoDriver 版本：使用 `perform_search()` 查找日期/區域按鈕
- 支援透過 `tixcraft_sid` 進行基於 Cookie 的快速登入
- 可能顯示需要自動重載的「即將開賣」頁面
- 經常使用需要 OCR 的圖片驗證碼

### KKTIX（台灣）
- ✅ NoDriver 版本：使用 `perform_search()` 處理價格清單佈局
- 使用價格清單佈局進行票券數量選擇
- 支援 Facebook OAuth 登入
- 高需求期間可能有排隊/等候室

### iBon（台灣）
- ✅ NoDriver 版本：使用 `perform_search()` 原生穿透 closed Shadow DOM
  - 效能：2-5秒，首次成功率 95%+
  - 智能等待機制適應 Angular SPA 渲染時間
- 需要 qware Cookie 進行快速登入
- 同時具有現代 Angular SPA 和舊版 .aspx 頁面
- ⚠️ Chrome Driver 版本（遺留）：使用 DOMSnapshot 平坦化（10-15秒，僅維護模式）

### TicketPlus（台灣）
- ✅ NoDriver 版本：使用 `perform_search()` 處理展開面板佈局
- 使用展開面板佈局進行區域選擇
- 需要處理實名驗證對話框
- 可能顯示「其他活動」參與提示

### KHAM（台灣）
- ✅ NoDriver 版本：使用 `perform_search()` 處理座位選擇界面
- 支援自動 vs. 手動座位選擇切換
- 可能需要實名對話框接受
- 經常在最終送出時使用驗證碼

### FamiTicket 全家（台灣）
- ✅ NoDriver 版本：完整實作（v2025.11.24 新增）
- 支援帳號密碼登入（HTTP-Only Cookie）
- 日期選擇支援關鍵字匹配 + 條件回退（`date_auto_fallback`）
- 區域選擇支援 AND 邏輯（空格分隔）+ 條件回退（`area_auto_fallback`）
- 支援驗證問題（實名認證）自動填寫
- 票種選擇頁面自動處理票數與同意條款
- 頁面路由分派：登入頁 → 活動頁 → 銷售首頁 → 票種選擇

### Cityline（香港）
- ✅ NoDriver 版本：部分實作（購票流程）
- 支援排隊/等候室自動等待
- 需要處理 Cookie 同意對話框
- 支援自動重試存取機制

### Ticketmaster（國際）
- ✅ NoDriver 版本：使用 TixCraft 家族共用邏輯（整合在 `nodriver_tixcraft_main`）
- 支援 Singapore、Australia 等多個區域
- 日期/區域自動選擇使用 TixCraft 共用函數
- 驗證碼 OCR 自動辨識

## 假設 *(為清楚起見記錄)*

1. **瀏覽器可用性**：Chrome/Chromium 90+ 瀏覽器已安裝且可存取
   - NoDriver 版本需要 Chrome 90+ 以支援完整 CDP 協議（`perform_search()` Shadow DOM 穿透、`dispatch_mouse_event()` 等）
2. **反偵測容忍度**：售票平台使用反機器人系統偵測 JavaScript 執行
   - NoDriver 版本透過 CDP 原生方法繞過偵測
   - Chrome Driver 版本的 JavaScript 方法可能被標記（進入維護模式的原因）
3. **網路穩定性**：搶票時段期間有可靠的網際網路連線
   - Shadow DOM 智能等待機制最多延遲 6.2 秒（1.2-1.8 初始 + 5 秒輪詢）以適應不同網速
4. **活動結構**：售票平台遵循標準流程：日期 -> 區域 -> 數量 -> 確認 -> 送出
5. **配置有效性**：使用者提供有效的活動 URL 和配置值
6. **音訊支援**：系統具有音訊輸出功能以播放通知聲音
7. **Python 環境**：已安裝 Python 3.9+ 及必要依賴項（nodriver、selenium、ddddocr 等）
8. **檔案權限**：系統對配置檔案和記錄目錄具有讀/寫存取權限
9. **螢幕解析度**：瀏覽器視窗可以顯示售票介面（建議最低 600x1024）
10. **時鐘同步**：系統時鐘與售票平台伺服器同步

## 依賴關係 *(外部系統與約束)*

### 外部系統
- **售票平台**：TixCraft、KKTIX、TicketPlus、iBon、KHAM 和其他支援的平台必須可存取
- **OCR 服務**：用於驗證碼辨識的 ddddocr 程式庫
- **WebDriver 二進位檔**：與已安裝 Chrome 版本相容的 ChromeDriver 二進位檔

### 技術約束
- **瀏覽器相容性**：需要 Chrome/Chromium 90 版或更高版本
- **Python 版本**：NoDriver 支援需要 Python 3.9+，Chrome Driver 需要 Python 3.7+
- **記憶體需求**：建議最少 2GB RAM 以穩定執行瀏覽器自動化
- **磁碟空間**：瀏覽器自動化依賴項需要最少 500MB

### 法律與道德約束
- 系統必須僅用於符合平台服務條款的個人購票
- 系統不得用於商業黃牛或轉售
- 系統必須尊重售票平台實施的速率限制和反機器人措施
- 使用者必須對其使用自動化系統承擔全部責任

## 範圍外 *(明確排除)*

以下不屬於此功能規格的一部分：

1. **付款處理**：訂單送出後的實際付款/結帳為手動操作
2. **多帳號管理**：同時管理多個使用者帳號
3. **票券轉售/轉讓**：轉售或轉讓已購票券的功能
4. **價格監控**：追蹤票價隨時間的變化
5. **可用性警報**：票券可用時的推播通知
6. **行動支援**：行動瀏覽器或行動應用程式自動化
7. **票券配送追蹤**：購票後監控票券配送狀態
8. **跨平台分析**：比較多個平台的票價
9. **團體購買協調**：協調多位使用者的購買
10. **自動退款**：處理票券取消和退款請求
