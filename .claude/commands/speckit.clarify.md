---
description: "透過提出最多 5 個高度針對性的釐清問題，找出目前功能規格說明中規格不明確的區域，並將答案編碼回規格說明中。"
model: opus
handoffs:
  - label: Build Technical Plan
    agent: speckit.plan
    prompt: Create a plan for the spec. I am building with...
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 使用者輸入

```text
$ARGUMENTS
```

您 **必須** 在繼續之前考量使用者輸入（如非空白）。

## 大綱

目標：偵測並減少活躍功能規格中的模糊或缺失決策點，並將釐清內容直接記錄在規格檔案中。

注意：此釐清工作流程預期在呼叫 `/speckit.plan` **之前** 執行（並完成）。如果使用者明確表示他們要跳過釐清（例如，探索性原型），您可以繼續，但必須警告下游重工風險會增加。

執行步驟：

1. 從儲存庫根目錄執行 `.specify/scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly` **一次**（組合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選擇擷取 `IMPL_PLAN`、`TASKS` 用於未來的鏈接流程。）
   - 如果 JSON 解析失敗，中止並指示使用者重新執行 `/speckit.specify` 或驗證功能分支環境。
   - 對於參數中的單引號（如 "I'm Groot"），使用跳脫語法：例如 'I'\''m Groot'（或盡可能使用雙引號："I'm Groot"）。

2. 載入目前的規格檔案。使用此分類法執行結構化的模糊與覆蓋掃描。對於每個類別，標記狀態：清晰 / 部分 / 缺失。產生用於優先排序的內部覆蓋對應（除非不會提出問題，否則不輸出原始對應）。

   功能範圍與行為：
   - 核心使用者目標與成功標準
   - 明確的範圍外宣告
   - 使用者角色/人物誌區分

   領域與資料模型：
   - 實體、屬性、關係
   - 身分與唯一性規則
   - 生命週期/狀態轉換
   - 資料量/規模假設

   互動與 UX 流程：
   - 關鍵使用者旅程/序列
   - 錯誤/空白/載入狀態
   - 無障礙或本地化註記

   非功能品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（水平/垂直、限制）
   - 可靠性與可用性（正常運行時間、復原預期）
   - 可觀察性（日誌、指標、追蹤訊號）
   - 安全性與隱私（驗證/授權、資料保護、威脅假設）
   - 合規/法規限制（如有）

   整合與外部相依性：
   - 外部服務/API 及失敗模式
   - 資料匯入/匯出格式
   - 協定/版本假設

   邊界案例與失敗處理：
   - 負面情境
   - 速率限制/節流
   - 衝突解決（例如，並發編輯）

   限制與權衡：
   - 技術限制（語言、儲存、託管）
   - 明確的權衡或被拒絕的替代方案

   術語與一致性：
   - 標準術語表詞彙
   - 避免的同義詞/已棄用的術語

   完成訊號：
   - 驗收標準可測試性
   - 可衡量的完成定義風格指標

   雜項/佔位符：
   - TODO 標記/未解決的決策
   - 缺乏量化的模糊形容詞（「穩健」、「直覺」）

   對於每個狀態為部分或缺失的類別，新增候選問題機會，除非：
   - 釐清不會實質改變實作或驗證策略
   - 資訊較適合延後到規劃階段（內部註記）

3. 產生（內部）優先排序的候選釐清問題佇列（最多 5 個）。**不要** 一次輸出全部。套用這些限制：
    - 整個會話中最多 10 個問題。
    - 每個問題必須可用以下任一方式回答：
       - 簡短的多選選項（2-5 個明確、互斥的選項），或
       - 單字/簡短片語答案（明確限制：「以 <=5 個字回答」）。
    - 僅包含其答案會實質影響架構、資料建模、任務分解、測試設計、UX 行為、營運準備度或合規驗證的問題。
    - 確保類別覆蓋平衡：嘗試先涵蓋影響最高的未解決類別；當單一高影響領域（例如，安全態勢）未解決時，避免提出兩個低影響問題。
    - 排除已回答的問題、微不足道的風格偏好、或計畫層級執行細節（除非阻擋正確性）。
    - 偏好減少下游重工風險或防止驗收測試錯位的釐清。
    - 如果超過 5 個類別仍未解決，按（影響 * 不確定性）啟發式方法選擇前 5 個。

4. 循序提問迴圈（互動式）：
    - 一次只呈現 **正好一個** 問題。
    - 對於多選問題：
       - **分析所有選項** 並根據以下因素決定 **最適合的選項**：
          - 專案類型的最佳實務
          - 類似實作中的常見模式
          - 風險降低（安全性、效能、可維護性）
          - 與規格中可見的任何明確專案目標或限制對齊
       - 在頂部顯眼地呈現您的 **建議選項**，並附上清晰的理由（1-2 句解釋為什麼這是最佳選擇）。
       - 格式為：`**建議：** 選項 [X] - <理由>`
       - 然後將所有選項渲染為 Markdown 表格：

       | 選項 | 描述 |
       |------|------|
       | A | <選項 A 描述> |
       | B | <選項 B 描述> |
       | C | <選項 C 描述>（根據需要新增 D/E，最多 5 個）|
       | 簡短 | 提供不同的簡短答案（<=5 個字）（僅在自由形式替代方案適當時包含）|

       - 在表格後新增：`您可以回覆選項字母（例如，「A」）、透過說「是」或「建議」來接受建議、或提供您自己的簡短答案。`
    - 對於簡短答案風格（無有意義的離散選項）：
       - 根據最佳實務和環境提供您的 **建議答案**。
       - 格式為：`**建議：** <您提議的答案> - <簡短理由>`
       - 然後輸出：`格式：簡短答案（<=5 個字）。您可以透過說「是」或「建議」來接受建議，或提供您自己的答案。`
    - 使用者回答後：
       - 如果使用者回覆「是」、「建議」或「suggested」，使用您先前陳述的建議/提議作為答案。
       - 否則，驗證答案是否對應到某個選項或符合 <=5 個字的限制。
       - 如果模糊，要求快速釐清（計數仍屬於同一問題；不前進）。
       - 一旦滿意，將其記錄在工作記憶中（尚不寫入磁碟），然後移至下一個佇列中的問題。
    - 在以下情況下停止提出更多問題：
       - 所有關鍵模糊提前解決（剩餘佇列項目變得不必要），或
       - 使用者發出完成訊號（「完成」、「好」、「不再需要」），或
       - 您達到 5 個已提出的問題。
    - 永不提前揭露未來佇列中的問題。
    - 如果開始時沒有有效問題，立即報告無關鍵模糊。

5. 每個已接受答案後的整合（增量更新方法）：
    - 維護規格的記憶體中表示（開始時載入一次）加上原始檔案內容。
    - 對於此會話中整合的第一個答案：
       - 確保 `## 釐清` 區塊存在（如果缺失，根據規格模板在最高層級情境/概述區塊之後建立）。
       - 在其下建立（如果不存在）今天的 `### 會話 YYYY-MM-DD` 子標題。
    - 在接受後立即附加條目行：`- Q: <問題> → A: <最終答案>`。
    - 然後立即將釐清套用到最適當的區塊：
       - 功能模糊 → 更新或在功能需求中新增條目。
       - 使用者互動/角色區分 → 更新使用者故事或角色子區塊（如存在），加入釐清的角色、限制或情境。
       - 資料形狀/實體 → 更新資料模型（新增欄位、類型、關係）保留順序；簡潔地註記新增的限制。
       - 非功能限制 → 在非功能/品質屬性區塊中新增/修改可衡量的標準（將模糊形容詞轉換為指標或明確目標）。
       - 邊界案例/負面流程 → 在邊界案例/錯誤處理下新增條目（如果模板提供佔位符，則建立該子區塊）。
       - 術語衝突 → 在規格中標準化術語；僅在必要時透過新增 `（先前稱為「X」）` 一次來保留原始術語。
    - 如果釐清使先前的模糊陳述失效，取代該陳述而非重複；不留下過時的矛盾文字。
    - 每次整合後儲存規格檔案，以最小化環境遺失風險（原子覆寫）。
    - 保留格式：不重新排序不相關的區塊；保持標題層級完整。
    - 保持每個插入的釐清最小且可測試（避免敘述漂移）。

6. 驗證（每次寫入後執行加上最終流程）：
   - 釐清會話包含每個已接受答案正好一個條目（無重複）。
   - 總共提出（接受）的問題 ≤ 5。
   - 更新的區塊不包含新答案本應解決的殘留模糊佔位符。
   - 沒有矛盾的先前陳述殘留（掃描現在無效的替代選擇已移除）。
   - Markdown 結構有效；唯一允許的新標題：`## 釐清`、`### 會話 YYYY-MM-DD`。
   - 術語一致性：所有更新的區塊使用相同的標準術語。

7. 將更新的規格寫回 `FEATURE_SPEC`。

8. 報告完成（在提問迴圈結束或提前終止後）：
   - 提出並回答的問題數量。
   - 更新規格的路徑。
   - 修改的區塊（列出名稱）。
   - 覆蓋摘要表，列出每個分類法類別及狀態：已解決（原為部分/缺失且已處理）、延後（超出問題配額或更適合規劃階段）、清晰（已足夠）、未處理（仍為部分/缺失但低影響）。
   - 如果仍有未處理或延後的項目，建議是否繼續 `/speckit.plan` 或稍後在規劃後再執行 `/speckit.clarify`。
   - 建議的下一個指令。

行為規則：

- 如果未發現有意義的模糊（或所有潛在問題都是低影響），回應：「未偵測到值得正式釐清的關鍵模糊。」並建議繼續。
- 如果規格檔案缺失，指示使用者先執行 `/speckit.specify`（不要在此建立新規格）。
- 永不超過 5 個總共提出的問題（單一問題的釐清重試不計為新問題）。
- 除非缺失會阻擋功能清晰度，否則避免推測性的技術堆疊問題。
- 尊重使用者的提前終止訊號（「停止」、「完成」、「繼續」）。
- 如果因為完整覆蓋而未提出問題，輸出精簡的覆蓋摘要（所有類別清晰），然後建議前進。
- 如果達到配額但仍有未解決的高影響類別，在延後項目下明確標記並附上理由。

優先排序的環境：$ARGUMENTS
