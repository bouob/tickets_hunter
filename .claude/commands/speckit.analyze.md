---
description: "在任務產生後，對 spec.md、plan.md 及 tasks.md 進行非破壞性的跨產物一致性與品質分析。"
model: opus
context: fork
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## 使用者輸入

```text
$ARGUMENTS
```

您 **必須** 在繼續之前考量使用者輸入（如非空白）。

## 目標

在實作之前，識別三個核心產物（`spec.md`、`plan.md`、`tasks.md`）之間的不一致、重複、模糊和定義不足的項目。此指令 **必須** 在 `/speckit.tasks` 成功產生完整的 `tasks.md` 之後才能執行。

## 運作限制

**嚴格唯讀模式**：**不得** 修改任何檔案。輸出結構化分析報告。提供可選的修復計畫（使用者必須明確核准，任何後續編輯指令才能手動執行）。

**憲法權威**：專案憲法（`.specify/memory/constitution.md`）在此分析範圍內 **不可協商**。憲法衝突自動標記為「嚴重」，需要調整規格、計畫或任務——而非稀釋、重新詮釋或默默忽略原則。如果原則本身需要變更，必須在 `/speckit.analyze` 之外的獨立明確憲法更新中進行。

## 執行步驟

### 1. 初始化分析環境

從儲存庫根目錄執行 `.specify/scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks` 一次，並解析 JSON 以取得 FEATURE_DIR 和 AVAILABLE_DOCS。導出絕對路徑：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如果任何必要檔案遺失，則中止並顯示錯誤訊息（指示使用者執行遺失的先決條件指令）。
對於參數中的單引號（如 "I'm Groot"），使用跳脫語法：例如 'I'\''m Groot'（或盡可能使用雙引號："I'm Groot"）。

### 2. 載入產物（漸進式揭露）

僅從每個產物載入最少必要的環境：

**從 spec.md：**

- 概述/背景
- 功能需求
- 非功能需求
- 使用者故事
- 邊界案例（如有）

**從 plan.md：**

- 架構/技術堆疊選擇
- 資料模型參考
- 階段
- 技術限制

**從 tasks.md：**

- 任務 ID
- 描述
- 階段分組
- 平行標記 [P]
- 參考的檔案路徑

**從憲法：**

- 載入 `.specify/memory/constitution.md` 以進行原則驗證

### 3. 建構語意模型

建立內部表示（不在輸出中包含原始產物）：

- **需求清單**：每個功能性 + 非功能性需求，帶有穩定的鍵值（根據祈使句片語導出代稱；例如，"User can upload file" → `user-can-upload-file`）
- **使用者故事/動作清單**：具有驗收標準的離散使用者動作
- **任務覆蓋對應**：將每個任務對應到一或多個需求或故事（透過關鍵字/明確參考模式如 ID 或關鍵片語進行推論）
- **憲法規則集**：擷取原則名稱和 MUST/SHOULD 規範性陳述

### 4. 偵測流程（符記效率分析）

專注於高訊號發現。總計限制 50 項發現；其餘彙整於溢出摘要。

#### A. 重複偵測

- 識別近乎重複的需求
- 標記品質較差的措辭以供整合

#### B. 模糊偵測

- 標記缺乏可衡量標準的模糊形容詞（快速、可擴展、安全、直覺、穩健）
- 標記未解決的佔位符（TODO、TKTK、???、`<placeholder>` 等）

#### C. 定義不足

- 具有動詞但缺少受詞或可衡量結果的需求
- 缺少驗收標準對齊的使用者故事
- 參考未在規格/計畫中定義的檔案或元件的任務

#### D. 憲法對齊

- 任何與 MUST 原則衝突的需求或計畫元素
- 憲法要求的缺失章節或品質關卡

#### E. 覆蓋缺口

- 沒有關聯任務的需求
- 沒有對應需求/故事的任務
- 未反映在任務中的非功能需求（例如效能、安全性）

#### F. 不一致

- 術語漂移（同一概念在不同檔案中名稱不同）
- 在計畫中參考但在規格中不存在的資料實體（或反之）
- 任務排序矛盾（例如，在基礎設定任務之前的整合任務，且無依賴性註記）
- 衝突的需求（例如，一個要求 Next.js 而另一個指定 Vue）

### 5. 嚴重性分配

使用此啟發式方法來排定發現的優先順序：

- **嚴重（CRITICAL）**：違反憲法 MUST、缺少核心規格產物、或零覆蓋的需求阻擋基本功能
- **高（HIGH）**：重複或衝突的需求、模糊的安全性/效能屬性、無法測試的驗收標準
- **中（MEDIUM）**：術語漂移、缺少非功能任務覆蓋、定義不足的邊界案例
- **低（LOW）**：風格/措辭改進、不影響執行順序的輕微冗餘

### 6. 產生精簡分析報告

輸出 Markdown 報告（不寫入檔案），結構如下：

## 規格分析報告

| ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
|----|------|--------|------|------|------|
| A1 | 重複 | 高 | spec.md:L120-134 | 兩個相似需求... | 合併措辭；保留較清晰的版本 |

（每項發現新增一列；產生以類別首字母為前綴的穩定 ID。）

**覆蓋摘要表：**

| 需求鍵值 | 有任務？ | 任務 ID | 註記 |
|----------|----------|---------|------|

**憲法對齊問題：**（如有）

**未對應任務：**（如有）

**指標：**

- 總需求數
- 總任務數
- 覆蓋率 %（具有 >=1 任務的需求）
- 模糊數量
- 重複數量
- 嚴重問題數量

### 7. 提供後續行動

在報告結尾，輸出精簡的後續行動區塊：

- 如果存在嚴重問題：建議在 `/speckit.implement` 之前解決
- 如果僅有低/中問題：使用者可繼續，但提供改進建議
- 提供明確的指令建議：例如，"執行 /speckit.specify 進行細化"、"執行 /speckit.plan 調整架構"、"手動編輯 tasks.md 以新增 'performance-metrics' 的覆蓋"

### 8. 提供修復方案

詢問使用者："您是否希望我針對前 N 個問題建議具體的修復編輯？"（**不要** 自動套用。）

## 運作原則

### 環境效率

- **最少高訊號符記**：專注於可行動的發現，而非詳盡的文件
- **漸進式揭露**：增量載入產物；不要將所有內容傾倒到分析中
- **符記效率輸出**：發現表格限制 50 列；摘要溢出部分
- **確定性結果**：在無變更的情況下重新執行應產生一致的 ID 和數量

### 分析指南

- **永不修改檔案**（這是唯讀分析）
- **永不虛構缺失章節**（如果缺失，準確報告）
- **優先處理憲法違規**（這些始終是嚴重的）
- **使用範例而非詳盡規則**（引用具體實例，而非通用模式）
- **優雅地報告零問題**（發出成功報告並附上覆蓋統計）

## 環境

$ARGUMENTS
