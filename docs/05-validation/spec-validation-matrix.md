**文件說明**：功能需求（FR-001 至 FR-064）的完整追溯矩陣，涵蓋實作狀態、測試狀態、平台支援與對應函數位置，用於驗證規格實作完整性。

**最後更新**：2025-11-27

---

# 規格驗證矩陣 (Spec Validation Matrix)

## 概述

本文件是**功能需求（FR-001 至 FR-064）到程式碼實作的完整追溯矩陣**，用於：
- ✅ 驗證所有規格需求是否已實作
- 🔍 追蹤每個 FR 對應的函數位置
- 🧪 檢查測試覆蓋率
- 🌐 確認平台支援情況

**資料來源**：
- 規格：`specs/001-ticket-automation-system/spec.md`
- 實作：`src/nodriver_tixcraft.py` (NoDriver 版本)
- 函數索引：`docs/02-development/structure.md`

**更新頻率**：每次新增功能或修改規格時同步更新

---

## 圖例說明

### 實作狀態
- **✅ 已實作**：功能已完整實作並可正常運作
- **🔄 部分實作**：功能部分完成，或僅部分平台支援
- **⬜ 未實作**：功能尚未開發
- **❌ 不適用**：該平台不適用此功能

### 測試狀態
- **✅ 已測試**：功能已通過實際測試驗證
- **🔄 部分測試**：部分平台或場景已測試
- **⬜ 未測試**：尚未進行測試
- **🚫 無法測試**：功能特性無法直接測試

### 平台代號
- **T** = TixCraft
- **K** = KKTIX
- **I** = iBon
- **P** = TicketPlus
- **H** = KHAM

---

## 階段 1：環境初始化

### FR-001：多種 WebDriver 類型支援

**需求描述**：系統必須支援透過設定檔配置的多種 WebDriver 類型（NoDriver、Chrome Driver、Selenium）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_main()` |
| **檔案位置** | `src/nodriver_tixcraft.py:16775-16834` |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | ✅ 已測試（所有平台通過 NoDriver 啟動測試） |
| **設定來源** | `settings.json → webdriver_type` |
| **相關 SC** | SC-001（95% 使用案例成功） |
| **備註** | 支援 "nodriver"、"chrome"、"selenium" 三種驅動類型<br>NoDriver 為推薦選項（憲法第 I 條） |

---

### FR-002：瀏覽器選項初始化

**需求描述**：系統必須使用配置的選項初始化瀏覽器（無頭模式、視窗大小、代理設定）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_main()` |
| **檔案位置** | `src/nodriver_tixcraft.py:16775-16834` |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.headless`<br>`advanced.window_size` |
| **相關 SC** | SC-001 |
| **備註** | NoDriver 版本使用 `nodriver.start()` 啟動<br>支援無頭模式、自訂視窗大小 |

---

### FR-003：瀏覽器擴充功能載入

**需求描述**：系統必須在配置時載入瀏覽器擴充功能（廣告攔截器、隱私工具）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ⬜ 未實作 |
| **主要函數** | N/A |
| **檔案位置** | N/A |
| **平台支援** | ⬜ T / ⬜ K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | ⬜ 未測試 |
| **設定來源** | 未定義 |
| **相關 SC** | N/A |
| **備註** | **待開發**：需要擴展 NoDriver 啟動參數<br>考慮加入 `advanced.extensions` 設定 |

---

### FR-004：settings.json 結構驗證

**需求描述**：系統必須驗證 settings.json 結構，並為無效配置提供清楚的錯誤訊息

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `load_config_from_file()`<br>`check_settings_json()` |
| **檔案位置** | `util.py:1500-1650`（估計） |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | `settings.json` |
| **相關 SC** | SC-009（100% 驗證涵蓋率） |
| **備註** | **改進空間**：需要更完整的 JSON Schema 驗證<br>目前僅檢查基本欄位存在性 |

---

## 階段 2：身份認證

### FR-005：Cookie 注入登入（主要方法）

**需求描述**：系統必須支援透過 Cookie 注入（tixcraft_sid、ibonqware）作為主要方法進行自動登入

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_main()` (Cookie 注入邏輯) |
| **檔案位置** | `src/nodriver_tixcraft.py:1889-2050` |
| **平台支援** | ✅ T（tixcraft_sid）<br>✅ I（ibonqware）<br>❌ K（使用帳密或 OAuth）<br>❌ P<br>❌ H |
| **測試狀態** | ✅ 已測試（TixCraft、iBon 通過） |
| **設定來源** | `settings.json → advanced.tixcraft_sid`<br>`advanced.ibonqware` |
| **相關 SC** | SC-001 |
| **備註** | TixCraft、iBon 的推薦登入方式<br>速度快且穩定 |

---

### FR-006：使用者名稱/密碼登入（回退方法）

**需求描述**：系統必須支援透過使用者名稱/密碼憑證作為回退方法進行自動登入

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_kktix_signin()`<br>`nodriver_ibon_login()` |
| **檔案位置** | `src/nodriver_tixcraft.py:302-324`（KKTIX）<br>`Line 5500-5700`（iBon，估計） |
| **平台支援** | ✅ K（使用 Facebook OAuth 或帳密）<br>✅ I（回退方法）<br>⬜ T（僅 Cookie）<br>❌ P<br>❌ H |
| **測試狀態** | ✅ 已測試（KKTIX 通過） |
| **設定來源** | `settings.json → advanced.kktix_account`<br>`advanced.kktix_password` |
| **相關 SC** | SC-001 |
| **備註** | KKTIX 同時支援 Facebook OAuth 登入 |

---

### FR-007：驗證登入狀態

**需求描述**：系統必須在繼續購票操作前驗證登入狀態

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 各平台 `_main()` 函數中的登入檢查邏輯 |
| **檔案位置** | 分散在各平台主流程中 |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動檢測） |
| **相關 SC** | SC-010（99% 運作時間） |
| **備註** | **改進空間**：需要統一的登入狀態驗證函數<br>目前各平台實作不一致 |

---

### FR-008：維持會話狀態

**需求描述**：系統必須在整個購票工作流程中維持會話狀態

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | NoDriver 瀏覽器會話管理 |
| **檔案位置** | `src/nodriver_tixcraft.py:16775-16834` (browser 物件) |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動處理） |
| **相關 SC** | SC-010 |
| **備註** | NoDriver 自動維持會話<br>Cookie 在整個流程中有效 |

---

## 階段 3：頁面監控與重載

> **v2.0 新增功能**：版面自動偵測（TicketPlus）- 適配不同版面布局

### FR-009：自動重載頁面

**需求描述**：系統必須在等待票券開賣時以配置的間隔自動重載頁面

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | 各平台主流程中的自動重載邏輯 |
| **檔案位置** | `src/nodriver_tixcraft.py` (分散在各平台) |
| **平台支援** | ✅ T / ✅ K / ✅ I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.auto_reload_page_interval` |
| **相關 SC** | SC-003（10 秒內完成購票）<br>SC-008（持續監控不中斷） |
| **備註** | 支援可配置的重載間隔<br>預設 0.1 秒（100ms） |

---

### FR-010：過熱保護

**需求描述**：系統必須實作過熱保護，在達到閾值計數後增加重載間隔

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | 主流程中的重載計數器邏輯 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.auto_reload_overheat_count` |
| **相關 SC** | SC-010（穩定運作） |
| **備註** | 達到閾值後自動延長重載間隔<br>防止被平台偵測為異常流量 |

---

### FR-011：彈出視窗處理

**需求描述**：系統必須偵測並關閉彈出視窗（廣告、公告、Cookie 同意）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `close_popup_windows()` |
| **檔案位置** | `util.py`（估計）或各平台主流程 |
| **平台支援** | 🔄 T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-010 |
| **備註** | **改進空間**：需要更完整的彈窗選擇器列表<br>目前僅處理常見彈窗類型 |

---

### FR-012：即將開賣頁面偵測

**需求描述**：系統必須偵測「即將開賣」頁面並繼續監控直到開賣

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | TixCraft 主流程中的「即將開賣」偵測 |
| **檔案位置** | `src/nodriver_tixcraft.py:1889-2050` |
| **平台支援** | ✅ T（TixCraft 特有）<br>❌ K / ❌ I / ❌ P / ❌ H |
| **測試狀態** | ✅ 已測試（TixCraft 通過） |
| **設定來源** | N/A（自動偵測頁面文字） |
| **相關 SC** | SC-008（持續監控） |
| **備註** | TixCraft 專屬功能<br>偵測「即將開賣」文字並自動重載 |

---

### FR-013：排隊/等候室頁面處理

**需求描述**：系統必須偵測排隊/等候室頁面並適當等待而不激進重載

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `nodriver_kktix_paused_main()` |
| **檔案位置** | `src/nodriver_tixcraft.py:325-400` |
| **平台支援** | ✅ K（KKTIX 排隊機制）<br>⬜ T / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試（KKTIX 排隊場景） |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-008 |
| **備註** | KKTIX 特有的排隊機制<br>**待擴展**：Cityline 等候室（FR-054） |

---

## 階段 4：日期選擇

### FR-014：偵測日期選擇佈局類型

**需求描述**：系統必須偵測日期選擇佈局類型（按鈕、下拉選單、日曆）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1144-1326` |
| **平台支援** | ✅ T（按鈕）<br>🔄 K（價格列表模式）<br>🔄 I（下拉選單）<br>⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試（TixCraft 通過） |
| **設定來源** | N/A（自動偵測 DOM 結構） |
| **相關 SC** | SC-002（90% 成功率） |
| **備註** | 已完整文件化於 `docs/03-mechanisms/04-date-selection.md` |

---

### FR-015：取得所有可用日期選項

**需求描述**：系統必須取得所有可用日期選項及其狀態（可用、售罄）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()`<br>使用 `perform_search()` 查詢日期選項 |
| **檔案位置** | `src/nodriver_tixcraft.py:2660-2807` |
| **平台支援** | ✅ T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動查詢） |
| **相關 SC** | SC-002<br>NFR-001（5 秒內完成查詢） |
| **備註** | NoDriver 版本使用 CDP `perform_search()`<br>效能：2-5 秒（NFR-001） |

---

### FR-016：過濾售罄日期

**需求描述**：系統必須在配置時過濾掉售罄的日期（pass_date_is_sold_out）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` (售罄過濾邏輯) |
| **檔案位置** | `src/nodriver_tixcraft.py:2750-2807` |
| **平台支援** | ✅ T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → date_auto_select.pass_date_is_sold_out` |
| **相關 SC** | SC-002 |
| **備註** | 偵測「售罄」、「sold out」等關鍵字<br>自動跳過不可選擇的日期 |

---

### FR-017：自動日期選擇（總開關）

**需求描述**：系統必須在 date_auto_select.enable = true 時才執行自動日期選擇

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` |
| **檔案位置** | `src/nodriver_tixcraft.py:2660-2807` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → date_auto_select.enable` |
| **相關 SC** | SC-001<br>SC-011（100% 不執行） |
| **備註** | **三層回退策略**的前置檢查<br>false 時完全停用自動選擇 |

---

### FR-017-1：關鍵字匹配優先（Early Return）

**需求描述**：當自動選擇啟用且有配置關鍵字時，系統必須優先使用關鍵字匹配日期（支援多個逗號分隔的關鍵字）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` (Early Return Pattern) |
| **檔案位置** | `src/nodriver_tixcraft.py:2759-2807` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → date_auto_select.date_keyword` |
| **相關 SC** | SC-002（90% 成功率） |
| **備註** | **Feature 003: Keyword Priority Fallback**<br>早期返回模式：第一個匹配立即停止<br>詳細文件：`docs/03-mechanisms/04-date-selection.md` |

---

### FR-017-2：模式回退（Conditional Fallback）

**需求描述**：當關鍵字不匹配且有設定 auto_select_mode 時，系統必須回退到基於模式的選擇（從上/下/中間/隨機）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` (Conditional Fallback) |
| **檔案位置** | `src/nodriver_tixcraft.py:2863-2876` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → date_auto_select.mode`<br>`date_auto_fallback`（控制是否回退） |
| **相關 SC** | SC-002 |
| **備註** | **條件式回退機制**：<br>- `date_auto_fallback = false`（預設）：嚴格模式，停止執行<br>- `date_auto_fallback = true`：回退到 mode 自動選擇<br>詳細文件：`docs/03-mechanisms/04-date-selection.md` |

---

### FR-017-3：停止並等待手動

**需求描述**：當關鍵字不匹配且未設定 auto_select_mode 時，系統必須停止選擇並等待手動介入

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` (第三層回退) |
| **檔案位置** | `src/nodriver_tixcraft.py:2863-2876` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（預設行為） |
| **相關 SC** | SC-011（確保不誤購） |
| **備註** | **安全網設計**：<br>避免在無明確指示時強制選擇<br>保護使用者避免誤購不想要的日期 |

---

### FR-018：enable=false 時完全停用

**需求描述**：當 date_auto_select.enable = false 時，系統必須完全忽略所有自動選擇設定（包括關鍵字和模式），讓使用者手動選擇日期

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` (前置檢查) |
| **檔案位置** | `src/nodriver_tixcraft.py:2660-2670` |
| **平台支援** | ✅ T / ✅ K / ✅ I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → date_auto_select.enable = false` |
| **相關 SC** | SC-011（100% 不執行） |
| **備註** | **完全停用機制**：<br>即使有關鍵字或模式設定也不執行<br>確保使用者完全手動控制 |

---

### FR-019：驗證日期選擇成功

**需求描述**：系統必須在進入下一階段前驗證日期選擇成功

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `nodriver_tixcraft_date_auto_select()` (返回值檢查) |
| **檔案位置** | `src/nodriver_tixcraft.py:2660-2900` |
| **平台支援** | ✅ T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動驗證） |
| **相關 SC** | SC-010（穩定運作） |
| **備註** | **改進空間**：需要更完整的驗證機制<br>確認選擇確實生效並導航到下一頁 |

---

## 階段 5：區域/座位選擇

### FR-020：偵測區域選擇佈局類型

**需求描述**：系統必須偵測區域選擇佈局類型（按鈕、下拉選單、座位圖、展開面板）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_area_auto_select()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1327-1378` |
| **平台支援** | ✅ T（按鈕）<br>✅ K（價格列表）<br>🔄 I（Shadow DOM）<br>⬜ P（展開面板）<br>⬜ H（座位圖） |
| **測試狀態** | ✅ 已測試（TixCraft、KKTIX） |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-002 |
| **備註** | 已完整文件化於 `docs/03-mechanisms/05-area-selection.md` |

---

### FR-021：取得所有區域選項及定價

**需求描述**：系統必須取得所有可用區域選項及定價和可用性資訊

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_get_tixcraft_target_area()`<br>使用 `perform_search()` 查詢區域 |
| **檔案位置** | `src/nodriver_tixcraft.py:1379-1489` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動查詢） |
| **相關 SC** | SC-002<br>NFR-001（5 秒內完成） |
| **備註** | NoDriver 版本使用 CDP `perform_search()`<br>同時取得區域名稱、定價、可用性 |

---

### FR-022：排除關鍵字過濾

**需求描述**：系統必須使用排除關鍵字過濾區域（例如排除「輪椅」、「視線受阻」）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_get_tixcraft_target_area()` (keyword_exclude 邏輯) |
| **檔案位置** | `src/nodriver_tixcraft.py:3194-3197` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → keyword_exclude` |
| **相關 SC** | SC-002 |
| **備註** | 支援逗號分隔多個排除關鍵字<br>詳細文件：`docs/03-mechanisms/05-area-selection.md` |

---

### FR-023：自動區域選擇（總開關）

**需求描述**：系統必須在 area_auto_select.enable = true 時才執行自動區域選擇

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_area_auto_select()` |
| **檔案位置** | `src/nodriver_tixcraft.py:3000-3100` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → area_auto_select.enable` |
| **相關 SC** | SC-001<br>SC-011 |
| **備註** | 與日期選擇相同的總開關設計<br>false 時完全停用 |

---

### FR-023-1：關鍵字匹配優先（Early Return）

**需求描述**：當自動選擇啟用且有配置關鍵字時，系統必須優先使用關鍵字匹配區域（支援多個逗號分隔的關鍵字）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_get_tixcraft_target_area()` (Early Return Pattern) |
| **檔案位置** | `src/nodriver_tixcraft.py:3048-3061` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → area_auto_select.area_keyword` |
| **相關 SC** | SC-002 |
| **備註** | **支援 AND 邏輯**：使用 `+` 連接多個必須同時匹配的關鍵字<br>例：`"VIP+搖滾區"` 兩者都必須存在<br>詳細文件：`docs/03-mechanisms/05-area-selection.md` |

---

### FR-023-2：模式回退（Conditional Fallback）

**需求描述**：當關鍵字不匹配且有設定 auto_select_mode 時，系統必須回退到基於模式的選擇（從上/下/中間/隨機）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_area_auto_select()` (Conditional Fallback) |
| **檔案位置** | `src/nodriver_tixcraft.py:3079-3094` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → area_auto_select.mode`<br>`area_auto_fallback` |
| **相關 SC** | SC-002 |
| **備註** | 與日期選擇相同的條件回退機制<br>`area_auto_fallback = false`（預設）：嚴格模式<br>`area_auto_fallback = true`：自動回退 |

---

### FR-023-3：停止並等待手動

**需求描述**：當關鍵字不匹配且未設定 auto_select_mode 時，系統必須停止選擇並等待手動介入

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_area_auto_select()` (第三層回退) |
| **檔案位置** | `src/nodriver_tixcraft.py:3079-3094` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（預設行為） |
| **相關 SC** | SC-011 |
| **備註** | 與日期選擇相同的安全網設計<br>避免誤購不想要的區域 |

---

### FR-024：enable=false 時完全停用

**需求描述**：當 area_auto_select.enable = false 時，系統必須完全忽略所有自動選擇設定（包括關鍵字和模式），讓使用者手動選擇區域

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_area_auto_select()` (前置檢查) |
| **檔案位置** | `src/nodriver_tixcraft.py:3000-3010` |
| **平台支援** | ✅ T / ✅ K / ✅ I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → area_auto_select.enable = false` |
| **相關 SC** | SC-011 |
| **備註** | 完全停用機制，確保手動控制 |

---

### FR-025：座位圖處理

**需求描述**：系統必須使用自動座位選擇演算法處理座位圖佈局

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | KHAM 座位選擇邏輯（估計） |
| **檔案位置** | `src/nodriver_tixcraft.py` (KHAM 部分) |
| **平台支援** | ❌ T / ❌ K / ❌ I / ❌ P / 🔄 H（KHAM 座位圖） |
| **測試狀態** | ⬜ 未測試 |
| **設定來源** | 待定義 |
| **相關 SC** | SC-002 |
| **備註** | **待開發**：完整的座位圖選擇演算法<br>KHAM 平台有初步實作 |

---

### FR-026：允許非相鄰座位

**需求描述**：系統必須在配置時支援「允許非相鄰座位」選項

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ⬜ 未實作 |
| **主要函數** | N/A |
| **檔案位置** | N/A |
| **平台支援** | ⬜ T / ⬜ K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | ⬜ 未測試 |
| **設定來源** | 待定義（建議：`area_auto_select.allow_non_adjacent`） |
| **相關 SC** | SC-001 |
| **備註** | **待開發**：需要擴展座位選擇邏輯<br>支援非連續座位選擇 |

---

## 階段 6：票券數量

### FR-027：偵測票券數量輸入類型

**需求描述**：系統必須偵測票券數量輸入類型（下拉選單、文字框、加減按鈕、價格清單）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_assign_ticket_number()`<br>`nodriver_kktix_travel_price_list()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1490-1544`（TixCraft）<br>`Line 425-624`（KKTIX 價格列表） |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-001 |
| **備註** | TixCraft: 下拉選單模式<br>KKTIX: 價格列表模式（特殊） |

---

### FR-028：設定票券數量

**需求描述**：系統必須將票券數量設為 settings.json 配置的值

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_assign_ticket_number()`<br>`nodriver_kktix_assign_ticket_number()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1490-1544`（TixCraft）<br>`Line 625-683`（KKTIX） |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → ticket_number` |
| **相關 SC** | SC-001 |
| **備註** | 支援 1-10 張票券設定 |

---

### FR-029：處理超過可用數量

**需求描述**：系統必須處理請求數量超過可用票券的情況（選擇最大可用數量）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `nodriver_tixcraft_assign_ticket_number()` (最大值檢查) |
| **檔案位置** | `src/nodriver_tixcraft.py:1490-1544` |
| **平台支援** | ✅ T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動調整） |
| **相關 SC** | SC-001 |
| **備註** | **改進空間**：需要更完整的數量驗證邏輯<br>自動回退到最大可用數量 |

---

### FR-030：驗證票券數量設定

**需求描述**：系統必須在繼續前驗證票券數量設定正確

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `nodriver_tixcraft_assign_ticket_number()` (返回值檢查) |
| **檔案位置** | `src/nodriver_tixcraft.py:1490-1544` |
| **平台支援** | ✅ T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動驗證） |
| **相關 SC** | SC-010 |
| **備註** | **改進空間**：需要更完整的驗證機制 |

---

## 階段 7：驗證碼處理

> **v2.0 新增功能**：自動答題機制（KKTIX）- 智慧推測答案、人類化填寫

### FR-031：偵測驗證碼類型

**需求描述**：系統必須偵測驗證碼類型（圖片驗證碼、reCAPTCHA、hCaptcha）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_verify()`<br>`nodriver_kktix_reg_captcha()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1103-1143`（TixCraft）<br>`Line 684-747`（KKTIX 問答式） |
| **平台支援** | ✅ T（圖片 OCR）<br>✅ K（問答式）<br>🔄 I（Shadow DOM 圖片）<br>⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-004（70% OCR 準確率） |
| **備註** | 已完整文件化於 `docs/03-mechanisms/07-captcha-handling.md`<br>支援：圖片 OCR、問答式、reCAPTCHA（手動回退） |

---

### FR-032：提取驗證碼圖片

**需求描述**：系統必須從配置的來源提取驗證碼圖片（canvas 元素、img 標籤）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_ticket_main_ocr()` (Canvas 擷取)<br>iBon Shadow DOM 驗證碼擷取 |
| **檔案位置** | `src/nodriver_tixcraft.py:3737-3770`（TixCraft Canvas）<br>`Line 9643-9730`（iBon Shadow DOM） |
| **平台支援** | ✅ T（Canvas）<br>✅ K（img 標籤）<br>✅ I（Shadow DOM img）<br>⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → ocr_captcha.image_source` |
| **相關 SC** | SC-004 |
| **備註** | 支援多種圖片來源：<br>- Canvas 元素<br>- img 標籤<br>- Shadow DOM img<br>詳細文件：`docs/03-mechanisms/07-captcha-handling.md` |

---

### FR-033：OCR 辨識驗證碼

**需求描述**：系統必須在啟用時使用 OCR（ddddocr）辨識驗證碼文字

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `ddddocr.classification()` (在 OCR 處理函數中) |
| **檔案位置** | `util.py`（OCR 工具函數）<br>各平台整合於驗證碼處理流程 |
| **平台支援** | ✅ T / ✅ K / ✅ I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → ocr_captcha.enable` |
| **相關 SC** | SC-004（70% 準確率） |
| **備註** | 使用 ddddocr 引擎<br>詳細 API 參考：`docs/06-api-reference/ddddocr_api_guide.md` |

---

### FR-034：beta OCR 模型選項

**需求描述**：系統必須支援 beta OCR 模型選項以提高準確性

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | OCR 初始化邏輯（根據 beta 設定選擇模型） |
| **檔案位置** | `util.py`（OCR 模型載入） |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → ocr_captcha.beta` |
| **相關 SC** | SC-004（beta 模型可提升到 80%+） |
| **備註** | beta 模型體積較大但準確率更高<br>建議：難度高的驗證碼啟用 beta |

---

### FR-035：自動輸入驗證碼

**需求描述**：系統必須自動輸入辨識的驗證碼

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_keyin_captcha_code()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1609-1677` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動執行） |
| **相關 SC** | SC-004 |
| **備註** | 使用 CDP `dispatch_key_event()` 模擬真實打字<br>包含人類化延遲（0.3-1 秒隨機） |

---

### FR-036：強制送出或等待確認

**需求描述**：系統必須根據配置支援強制送出或等待手動確認

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_verify()` (force_submit 邏輯) |
| **檔案位置** | `src/nodriver_tixcraft.py:1103-1143` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → ocr_captcha.force_submit` |
| **相關 SC** | SC-003（快速完成購票） |
| **備註** | `force_submit = true`：自動送出<br>`force_submit = false`：等待手動確認（更安全） |

---

### FR-037：手動驗證碼回退

**需求描述**：系統必須在 OCR 停用或失敗時支援手動驗證碼輸入作為回退

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_keyin_captcha_code()` (手動輸入模式) |
| **檔案位置** | `src/nodriver_tixcraft.py:1609-1677` |
| **平台支援** | ✅ T / ✅ K / ✅ I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → ocr_captcha.enable = false` |
| **相關 SC** | SC-007（100% 通知傳遞） |
| **備註** | OCR 失敗或停用時播放音效提醒<br>等待使用者手動輸入 |

---

### FR-038：驗證碼重新整理

**需求描述**：系統必須支援驗證碼重新整理/重載功能

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | TixCraft 驗證碼處理中的重新整理邏輯（估計） |
| **檔案位置** | `src/nodriver_tixcraft.py` (驗證碼相關函數) |
| **平台支援** | 🔄 T / ⬜ K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | 待定義 |
| **相關 SC** | SC-004 |
| **備註** | **改進空間**：需要標準化的驗證碼重新整理機制<br>目前部分平台有實作 |

---

### FR-039：驗證碼重試機制

**需求描述**：系統必須以可配置的最大重試次數重試驗證碼辨識

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_kktix_reg_captcha()` (fail_list 機制) |
| **檔案位置** | `src/nodriver_tixcraft.py:1171-1330` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試（KKTIX fail_list 驗證通過） |
| **設定來源** | 程式碼中的 `max_retries` 常數（建議：移至 settings.json） |
| **相關 SC** | SC-004 |
| **備註** | **KKTIX fail_list 機制**：記錄錯誤答案避免重複嘗試<br>詳細文件：`docs/03-mechanisms/07-captcha-handling.md`<br>**改進空間**：將 max_retries 移至設定檔 |

---

## 階段 8：表單填寫

> **v2.0 新增功能**：實名認證處理（FamiTicket, iBon）- 處理實名制驗證流程

### FR-040：偵測必填欄位

**需求描述**：系統必須偵測所有必填表單欄位（姓名、電話、電子郵件、身份證號、地址）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 各平台的表單填寫函數 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | 🔄 T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-001 |
| **備註** | **改進空間**：需要統一的表單欄位偵測機制<br>目前各平台實作分散 |

---

### FR-041：自動填寫個人資訊

**需求描述**：系統必須在資料可用時自動填寫個人資訊欄位

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 各平台的表單填寫邏輯 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | 🔄 T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | `settings.json → personal_info.*`（待標準化） |
| **相關 SC** | SC-001<br>SC-003（快速完成） |
| **備註** | **改進空間**：需要標準化的個人資訊設定結構<br>建議：統一 `personal_info` 區塊 |

---

### FR-042：自訂問題答案處理

**需求描述**：系統必須使用使用者提供的答案處理自訂問題（user_guess_string）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 自訂問題處理邏輯（估計） |
| **檔案位置** | `util.py` 或各平台主流程 |
| **平台支援** | 🔄 T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | `settings.json → user_guess_string` |
| **相關 SC** | SC-001 |
| **備註** | **改進空間**：需要更完整的自訂問題處理機制 |

---

### FR-043：自動答案猜測

**需求描述**：系統必須在配置時支援常見問題的自動答案猜測

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ⬜ 未實作 |
| **主要函數** | N/A |
| **檔案位置** | N/A |
| **平台支援** | ⬜ T / ⬜ K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | ⬜ 未測試 |
| **設定來源** | 待定義 |
| **相關 SC** | SC-001 |
| **備註** | **待開發**：需要建立常見問題答案資料庫<br>例如：「您的興趣」自動填寫「音樂」 |

---

## 階段 9：同意條款處理

### FR-044：偵測同意元素

**需求描述**：系統必須偵測所有同意核取方塊、單選按鈕和切換開關

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_ticket_main_agree()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1545-1562` |
| **平台支援** | ✅ T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試（TixCraft） |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-001 |
| **備註** | 使用 `perform_search()` 查找同意核取方塊<br>支援多種元素類型 |

---

### FR-045：自動勾選同意

**需求描述**：系統必須自動勾選所有同意/服務條款方塊

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_tixcraft_ticket_main_agree()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1545-1562` |
| **平台支援** | ✅ T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動執行） |
| **相關 SC** | SC-001<br>SC-003 |
| **備註** | 使用 CDP `dispatch_mouse_event()` 點擊核取方塊<br>避免 JavaScript 執行（反偵測） |

---

### FR-046：平台特定同意對話框

**需求描述**：系統必須處理平台特定的同意對話框（實名驗證、活動參與）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | TicketPlus 實名對話框處理（估計）<br>KHAM 實名卡片接受 |
| **檔案位置** | `src/nodriver_tixcraft.py` (TicketPlus/KHAM 部分) |
| **平台支援** | ❌ T / ❌ K / ❌ I / 🔄 P（實名對話框）/ 🔄 H（實名卡片） |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動處理） |
| **相關 SC** | SC-006（5 平台支援） |
| **備註** | **TicketPlus**：實名驗證對話框<br>**KHAM**：實名卡片接受<br>需要更完整的測試與文件化 |

---

### FR-047：驗證同意完成

**需求描述**：系統必須在送出前驗證所有必要同意都已勾選

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `nodriver_tixcraft_ticket_main_agree()` (返回值檢查) |
| **檔案位置** | `src/nodriver_tixcraft.py:1545-1562` |
| **平台支援** | ✅ T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動驗證） |
| **相關 SC** | SC-010 |
| **備註** | **改進空間**：需要更完整的驗證機制<br>確保所有必要核取方塊都已勾選 |

---

## 階段 10：訂單確認與送出

### FR-048：檢視訂單詳情

**需求描述**：系統必須在最終送出前檢視訂單詳情（票券數量、總價）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 各平台訂單送出前的檢查邏輯 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | 🔄 T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動執行） |
| **相關 SC** | SC-010（穩定運作） |
| **備註** | **改進空間**：需要標準化的訂單驗證機制<br>記錄訂單詳情到日誌 |

---

### FR-049：定位送出按鈕

**需求描述**：系統必須使用多種偵測策略定位並點擊訂單送出按鈕

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_kktix_confirm_order_button()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1778-1812` |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-003（10 秒內完成）<br>SC-005（95% 成功率） |
| **備註** | 使用 `perform_search()` 多種選擇器策略<br>回退機制確保找到送出按鈕 |

---

### FR-050：處理確認對話框

**需求描述**：系統必須處理點擊送出後出現的確認對話框

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 各平台主流程中的對話框處理 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | 🔄 T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動處理） |
| **相關 SC** | SC-003 |
| **備註** | **改進空間**：需要統一的對話框處理機制<br>目前各平台實作不一致 |

---

### FR-051：搶到票音訊通知

**需求描述**：系統必須在搶到票時播放音訊通知（如已配置）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `play_sound()` (util.py) |
| **檔案位置** | `util.py`（音訊播放工具）<br>整合於各平台主流程 |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.play_sound.ticket` |
| **相關 SC** | SC-007（100% 通知傳遞） |
| **備註** | 支援自訂音訊檔案<br>跨平台音訊播放支援 |

---

### FR-052：送出訂單音訊通知

**需求描述**：系統必須在送出訂單時播放音訊通知（如已配置）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `play_sound()` (util.py) |
| **檔案位置** | `util.py`（音訊播放工具）<br>整合於各平台主流程 |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.play_sound.order` |
| **相關 SC** | SC-007 |
| **備註** | 與搶到票通知共用音訊播放機制 |

---

### FR-053：驗證訂單送出成功

**需求描述**：系統必須透過偵測確認頁面驗證訂單送出成功

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 各平台主流程中的確認頁面偵測 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | 🔄 T / 🔄 K / ⬜ I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-010 |
| **備註** | **改進空間**：需要標準化的確認頁面偵測機制<br>記錄成功訂單資訊 |

---

## 階段 11：排隊與付款

### FR-054：偵測排隊頁面

**需求描述**：系統必須偵測排隊/等候室頁面並解析排隊位置資訊

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `nodriver_kktix_paused_main()`<br>Cityline 排隊處理（估計） |
| **檔案位置** | `src/nodriver_tixcraft.py:325-400`（KKTIX）<br>Cityline 部分（待確認） |
| **平台支援** | ❌ T / ✅ K（KKTIX 排隊機制）<br>❌ I / ❌ P / ❌ H<br>🔄 Cityline（等候室） |
| **測試狀態** | ✅ 已測試（KKTIX） |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-008（持續監控） |
| **備註** | **KKTIX**：排隊頁面偵測與處理<br>**Cityline**：等候室機制（待完整文件化）<br>詳細文件：`docs/03-mechanisms/11-queue-payment.md`（待撰寫） |

---

### FR-055：排隊等待

**需求描述**：系統必須在排隊中等待而不採取可能觸發反機器人偵測的激進動作

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_kktix_paused_main()` |
| **檔案位置** | `src/nodriver_tixcraft.py:325-400` |
| **平台支援** | ❌ T / ✅ K / ❌ I / ❌ P / ❌ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動處理） |
| **相關 SC** | SC-008<br>NFR-006（通過反機器人檢測） |
| **備註** | KKTIX 專用排隊等待機制<br>避免頻繁重載觸發偵測 |

---

### FR-056：排隊完成偵測

**需求描述**：系統必須偵測排隊處理完成並自動繼續

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `nodriver_kktix_paused_main()` (排隊結束偵測) |
| **檔案位置** | `src/nodriver_tixcraft.py:325-400` |
| **平台支援** | ❌ T / ✅ K / ❌ I / ❌ P / ❌ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（自動偵測） |
| **相關 SC** | SC-008 |
| **備註** | 偵測排隊頁面消失或進入註冊頁面<br>自動繼續購票流程 |

---

### FR-057：排隊失敗重試

**需求描述**：系統必須支援排隊失敗的自動重試（如針對特定平台配置）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `nodriver_kktix_reg_auto_reload()` |
| **檔案位置** | `src/nodriver_tixcraft.py:1958-2050` |
| **平台支援** | ❌ T / ✅ K（自動重載機制）<br>❌ I / ❌ P / ❌ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | `settings.json → kktix.auto_reload_coming_soon_page_enable` |
| **相關 SC** | SC-008（持續監控不中斷） |
| **備註** | KKTIX 專用自動重載機制<br>**改進空間**：需要更完整的重試策略 |

---

## 階段 12：錯誤處理與重試

### FR-058：錯誤分類

**需求描述**：系統必須偵測並分類錯誤類型（售罄、逾時、網路錯誤、系統錯誤）

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | 全域錯誤處理邏輯（分散各函數） |
| **檔案位置** | 分散在各平台主流程和工具函數 |
| **平台支援** | 🔄 T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | N/A（自動分類） |
| **相關 SC** | SC-010（99% 運作時間） |
| **備註** | **改進空間**：需要統一的錯誤分類系統<br>建立標準錯誤代碼（E001-E999）<br>詳細文件：`docs/03-mechanisms/12-error-handling.md`（待撰寫） |

---

### FR-059：詳細錯誤記錄

**需求描述**：系統必須在啟用詳細模式（advanced.verbose = true）時記錄所有錯誤的詳細資訊

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | `print()` 和日誌系統（遍布全域） |
| **檔案位置** | 所有函數（使用 `show_debug_message` 條件日誌） |
| **平台支援** | ✅ T / ✅ K / ✅ I / ✅ P / ✅ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.verbose` |
| **相關 SC** | SC-009（100% 驗證涵蓋率） |
| **備註** | `show_debug_message` 控制詳細日誌輸出<br>包含函數名稱、參數、返回值 |

---

### FR-060：自動重試（NoDriver CDP 原生）

**需求描述**：系統必須自動重試失敗的操作，**NoDriver 版本必須使用 CDP 原生方法重試，禁止回退到 JavaScript 執行**

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | 所有 NoDriver 函數（使用 CDP 原生方法） |
| **檔案位置** | `src/nodriver_tixcraft.py`（全域） |
| **平台支援** | ✅ T / ✅ K / ✅ I / 🔄 P / 🔄 H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（架構設計） |
| **相關 SC** | SC-005（95% 成功率）<br>NFR-004（100% 避免 JavaScript）<br>NFR-005（CDP 原生事件） |
| **備註** | **反偵測優先架構**（憲法第 I 條）：<br>- ✅ 允許：CDP `dispatch_mouse_event()` 重試<br>- ✅ 允許：CDP `perform_search()` DOM 重新查詢<br>- ❌ 禁止：JavaScript `element.click()` 回退<br>詳細規範：`specs/001-ticket-automation-system/spec.md` (NFR-004, NFR-005) |

---

### FR-061：可配置重試間隔

**需求描述**：系統必須有可配置的重試間隔（auto_reload_page_interval），使用者可自訂刷新時間

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | 各平台主流程中的重載邏輯 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | ✅ T / ✅ K / ✅ I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.auto_reload_page_interval` |
| **相關 SC** | SC-008（持續監控不中斷） |
| **備註** | 預設 0.1 秒（100ms）<br>支援 0.01-10.0 秒範圍 |

---

### FR-062：錯誤通知

**需求描述**：系統必須透過音訊/視覺警報通知使用者關鍵錯誤

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | 🔄 部分實作 |
| **主要函數** | `play_sound()` (util.py)<br>錯誤處理中的通知邏輯 |
| **檔案位置** | `util.py`（音訊播放）<br>分散在錯誤處理邏輯 |
| **平台支援** | 🔄 T / 🔄 K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | 🔄 部分測試 |
| **設定來源** | `settings.json → advanced.play_sound.*` |
| **相關 SC** | SC-007（100% 通知傳遞） |
| **備註** | **改進空間**：需要統一的錯誤通知機制<br>目前僅驗證碼失敗有音效提醒 |

---

### FR-063：售罄持續監控

**需求描述**：當偵測到票券售罄狀態時，系統必須根據配置的刷新間隔持續重試並監控直到票券可用，而非停止嘗試

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | 各平台主流程中的售罄檢測與重載邏輯 |
| **檔案位置** | 分散在各平台主流程 |
| **平台支援** | ✅ T / ✅ K / 🔄 I / ⬜ P / ⬜ H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | `settings.json → advanced.auto_reload_page_interval` |
| **相關 SC** | SC-008（100% 持續監控不中斷） |
| **備註** | 偵測「售罄」、「sold out」等關鍵字<br>自動重載直到票券可用 |

---

### FR-064：NoDriver CDP 原生方法

**需求描述**：NoDriver 版本的所有元素互動必須使用 CDP 原生方法，避免被反機器人系統偵測

| 項目 | 內容 |
|-----|-----|
| **實作狀態** | ✅ 已實作 |
| **主要函數** | 所有 NoDriver 函數（使用 CDP API） |
| **檔案位置** | `src/nodriver_tixcraft.py`（全域） |
| **平台支援** | ✅ T / ✅ K / ✅ I / 🔄 P / 🔄 H |
| **測試狀態** | ✅ 已測試 |
| **設定來源** | N/A（架構設計） |
| **相關 SC** | NFR-004（100% 避免 JavaScript）<br>NFR-005（CDP 原生事件）<br>NFR-006（通過反機器人檢測） |
| **備註** | **核心架構原則**（憲法第 I 條）：<br>- DOM 查詢：`cdp.dom.perform_search()`<br>- 元素互動：`cdp.input_.dispatch_mouse_event()`<br>- 滾動：`cdp.dom.scroll_into_view_if_needed()`<br>- ❌ 禁止：所有 `tab.evaluate()` 或 JavaScript 注入<br>詳細 API 文件：`docs/06-api-reference/cdp_protocol_reference.md` |

---

## 統計摘要

### 實作狀態統計

| 狀態 | 數量 | 百分比 |
|-----|-----|--------|
| ✅ 已實作 | 38 | 59.4% |
| 🔄 部分實作 | 19 | 29.7% |
| ⬜ 未實作 | 7 | 10.9% |
| **總計** | **64** | **100%** |

### 階段完成度統計

| 階段 | FR 數量 | 已實作 | 部分實作 | 未實作 | 完成度 |
|-----|--------|--------|----------|--------|--------|
| 1. 環境初始化 | 4 | 2 | 1 | 1 | 50% |
| 2. 身份認證 | 4 | 3 | 1 | 0 | 75% |
| 3. 頁面監控與重載 | 5 | 3 | 2 | 0 | 60% |
| 4. 日期選擇 | 6 | 6 | 0 | 0 | **100%** ✅ |
| 5. 區域/座位選擇 | 7 | 6 | 1 | 0 | 86% |
| 6. 票券數量 | 4 | 2 | 2 | 0 | 50% |
| 7. 驗證碼處理 | 9 | 7 | 2 | 0 | 78% |
| 8. 表單填寫 | 4 | 0 | 3 | 1 | 0% |
| 9. 同意條款處理 | 4 | 2 | 2 | 0 | 50% |
| 10. 訂單確認與送出 | 6 | 3 | 3 | 0 | 50% |
| 11. 排隊與付款 | 4 | 3 | 1 | 0 | 75% |
| 12. 錯誤處理與重試 | 7 | 5 | 2 | 0 | 71% |
| **總計** | **64** | **38** | **19** | **7** | **59.4%** |

### 平台支援統計

| 平台 | 完整支援 FR | 部分支援 FR | 未支援 FR | 支援度 |
|-----|------------|------------|----------|--------|
| **TixCraft** | 42 | 12 | 10 | 66% |
| **KKTIX** | 38 | 15 | 11 | 59% |
| **iBon** | 24 | 28 | 12 | 38% |
| **TicketPlus** | 8 | 4 | 52 | 13% |
| **KHAM** | 8 | 6 | 50 | 13% |

### 優先度建議

#### 🔴 高優先度（待完成）

**階段 8：表單填寫** (0% 完成度)
- FR-040：偵測必填欄位
- FR-041：自動填寫個人資訊
- FR-042：自訂問題答案處理
- FR-043：自動答案猜測

**原因**：表單填寫是購票流程的關鍵步驟，目前完全依賴手動輸入，影響 SC-003（10 秒內完成購票）

---

#### 🟡 中優先度（待改進）

**階段 1：環境初始化** (50% 完成度)
- FR-003：瀏覽器擴充功能載入
- FR-004：settings.json 完整驗證（需要 JSON Schema）

**階段 6：票券數量** (50% 完成度)
- FR-029：處理超過可用數量（完整驗證邏輯）
- FR-030：驗證票券數量設定（完整驗證機制）

**階段 9：同意條款處理** (50% 完成度)
- FR-046：平台特定同意對話框（TicketPlus、KHAM 完整測試）
- FR-047：驗證同意完成（完整驗證機制）

**階段 10：訂單確認與送出** (50% 完成度)
- FR-048：檢視訂單詳情（標準化驗證）
- FR-050：處理確認對話框（統一機制）
- FR-053：驗證訂單送出成功（標準化偵測）

---

#### 🟢 低優先度（優化項目）

**階段 5：區域/座位選擇** (86% 完成度)
- FR-025：座位圖處理（KHAM 座位圖演算法）
- FR-026：允許非相鄰座位

**階段 12：錯誤處理與重試** (71% 完成度)
- FR-058：錯誤分類（統一錯誤代碼系統）
- FR-062：錯誤通知（統一通知機制）

---

## 測試覆蓋率分析

### 已測試功能（✅ 測試狀態 = 已測試）

**核心功能**（優先度 P1）：
- ✅ FR-017 系列：日期選擇完整流程（Early Return + Conditional Fallback）
- ✅ FR-023 系列：區域選擇完整流程（Early Return + Conditional Fallback）
- ✅ FR-031-039：驗證碼處理（OCR + 問答式 + 手動回退）
- ✅ FR-051-052：音訊通知（搶到票 + 送出訂單）
- ✅ FR-060、FR-064：NoDriver CDP 原生方法（反偵測核心）

**支援功能**（優先度 P2-P3）：
- ✅ FR-005-006：Cookie + 帳密登入
- ✅ FR-009-010：自動重載 + 過熱保護
- ✅ FR-027-028：票券數量設定
- ✅ FR-054-056：KKTIX 排隊機制

### 待測試功能（⬜ 測試狀態 = 未測試）

**高風險未測試**：
- ⬜ FR-003：瀏覽器擴充功能載入（功能未實作）
- ⬜ FR-025：座位圖處理（部分實作）
- ⬜ FR-026：允許非相鄰座位（功能未實作）
- ⬜ FR-043：自動答案猜測（功能未實作）

---

## 相關文件

### 規格與設計
- 📋 [功能規格](../../specs/001-ticket-automation-system/spec.md) - 完整 FR-001 至 FR-064 定義
- 📋 [實作計畫](../../specs/001-ticket-automation-system/plan.md) - 設計決策與架構
- 📋 [成功標準](../../specs/001-ticket-automation-system/spec.md#成功標準) - SC-001 至 SC-011

### 程式碼結構
- 🏗️ [程式碼結構分析](../02-development/structure.md) - 函數索引與行號
- 📋 [12-Stage 標準](../02-development/ticket_automation_standard.md) - 完整流程定義

### 機制文件（已完成）
- ✅ [Stage 4: 日期選擇](../02-mechanisms/04-date-selection.md) - FR-014 至 FR-019
- ✅ [Stage 5: 區域選擇](../02-mechanisms/05-area-selection.md) - FR-020 至 FR-026
- ✅ [Stage 7: 驗證碼處理](../02-mechanisms/07-captcha-handling.md) - FR-031 至 FR-039

### 平台參考實作
- ✅ [KKTIX 參考實作](../03-implementation/platform-examples/kktix-reference.md)
- ✅ [iBon 參考實作](../03-implementation/platform-examples/ibon-reference.md)

### API 參考
- 📋 [NoDriver API 指南](../03-api-reference/nodriver_api_guide.md) - NoDriver 完整參考
- 📋 [CDP 協議參考](../03-api-reference/cdp_protocol_reference.md) - FR-060、FR-064 技術細節
- 📋 [ddddocr API 指南](../03-api-reference/ddddocr_api_guide.md) - FR-033、FR-034

---

## 版本歷史

| 版本 | 日期 | 變更內容 |
|------|------|----------|
| v1.0 | 2025-11 | 初版：建立完整規格驗證矩陣 |
| | | ✅ 所有 FR-001 至 FR-064 追溯 |
| | | ✅ 實作狀態、測試狀態、平台支援標記 |
| | | ✅ 統計摘要與優先度建議 |
| v2.0 | 2025-11-27 | 新增 v2.0 功能說明 |
| | | 🆕 Stage 3: 版面自動偵測（TicketPlus）|
| | | 🆕 Stage 7: 自動答題機制（KKTIX）|
| | | 🆕 Stage 8: 實名認證處理（FamiTicket, iBon）|

**未來更新**：
- 每次新增功能時同步更新實作狀態
- 每次修改規格時更新 FR 描述
- 每次完成測試時更新測試狀態
- 季度性檢查：確保矩陣與實際程式碼同步

---

**最後更新**：2025-11-27（v2.0）
**維護者**：Tickets Hunter 開發團隊
**相關工具**：[平台實作檢查清單](./platform-checklist.md)、[FR 到程式碼對照表](./fr-to-code-mapping.md)
