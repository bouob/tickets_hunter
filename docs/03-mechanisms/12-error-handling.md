# æ©Ÿåˆ¶ 12ï¼šéŒ¯èª¤è™•ç† (Stage 12)

**æ–‡ä»¶èªªæ˜**ï¼šèªªæ˜æ¶ç¥¨ç³»çµ±çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ã€å¤±æ•—è¨ºæ–·èˆ‡è‡ªå‹•é‡è©¦ç­–ç•¥
**æœ€å¾Œæ›´æ–°**ï¼š2025-11-12

---

## æ¦‚è¿°

éŒ¯èª¤è™•ç†æ˜¯è‡ªå‹•åŒ–ç³»çµ±å¿…ä¸å¯å°‘çš„æ©Ÿåˆ¶ã€‚åœ¨æ•´å€‹è³¼ç¥¨æµç¨‹ä¸­å¯èƒ½ç™¼ç”Ÿå„ç¨®éŒ¯èª¤ï¼Œç³»çµ±éœ€è¦èƒ½å¤ è­˜åˆ¥ã€åˆ†é¡ã€è¨˜éŒ„é€™äº›éŒ¯èª¤ï¼Œä¸¦æ ¹æ“šéŒ¯èª¤é¡å‹æ¡å–ç›¸æ‡‰çš„æªæ–½ï¼ˆé‡è©¦ã€å›é€€ã€åœæ­¢ç­‰ï¼‰ã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼šè­˜åˆ¥å’Œè™•ç†å„é¡éŒ¯èª¤ï¼Œç¢ºä¿ç³»çµ±çš„ç©©å®šæ€§å’Œå¯æ¢å¾©æ€§ã€‚

**å„ªå…ˆåº¦**ï¼šğŸ”´ P1 - ç³»çµ±ç©©å®šæ€§åŸºç¤

---

## éŒ¯èª¤åˆ†é¡èˆ‡è™•ç†

### 1. éŒ¯èª¤é¡å‹è­˜åˆ¥

#### 1.1 ç¶²è·¯éŒ¯èª¤
ç”±æ–¼ç¶²è·¯é€£æ¥å•é¡Œå°è‡´çš„éŒ¯èª¤ã€‚

**å¸¸è¦‹çš„ç¶²è·¯éŒ¯èª¤**ï¼š
1. **é€£æ¥è¶…æ™‚**
   - ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨
   - é€£æ¥ä¸­æ–·

2. **è«‹æ±‚è¶…æ™‚**
   - ä¼ºæœå™¨æœªåœ¨è¦å®šæ™‚é–“å…§éŸ¿æ‡‰
   - é é¢åŠ è¼‰è¶…æ™‚

3. **DNS è§£æå¤±æ•—**
   - ç„¡æ³•è§£æåŸŸå
   - ç¶²è·¯é…ç½®å•é¡Œ

4. **SSL/TLS éŒ¯èª¤**
   - è­‰æ›¸é©—è­‰å¤±æ•—
   - å®‰å…¨é€£æ¥å•é¡Œ

**è™•ç†ç­–ç•¥**ï¼š
```python
async def handle_network_error(error: Exception) -> str:
    """è™•ç†ç¶²è·¯éŒ¯èª¤"""
    if isinstance(error, asyncio.TimeoutError):
        return 'RETRY'  # å¯é‡è©¦
    elif 'Connection refused' in str(error):
        return 'RETRY'  # å¯é‡è©¦
    elif 'SSL' in str(error):
        return 'SKIP'   # è·³éï¼Œç„¡æ³•ä¿®æ­£
    else:
        return 'RETRY'  # é»˜èªé‡è©¦
```

#### 1.2 é é¢éŒ¯èª¤
ç”±æ–¼é é¢çµæ§‹æ”¹è®Šæˆ–ç„¡æ³•æ‰¾åˆ°å…ƒç´ å°è‡´çš„éŒ¯èª¤ã€‚

**å¸¸è¦‹çš„é é¢éŒ¯èª¤**ï¼š
1. **é¸æ“‡å™¨å¤±æ•ˆ**
   - HTML çµæ§‹æ”¹è®Š
   - å…ƒç´  ID/Class æ”¹è®Š

2. **å…ƒç´ ä¸å­˜åœ¨**
   - æŒ‡å®šçš„æ¬„ä½æœªæ‰¾åˆ°
   - é é¢å°šæœªåŠ è¼‰

3. **å…ƒç´ ä¸å¯äº’å‹•**
   - å…ƒç´ è¢«ç¦ç”¨
   - å…ƒç´ è¢«éš±è—
   - å…ƒç´ è¢«å…¶ä»–å…ƒç´ é®æ“‹

**è™•ç†ç­–ç•¥**ï¼š
```python
async def handle_page_error(error: Exception, selector: str) -> str:
    """è™•ç†é é¢éŒ¯èª¤"""
    if 'not found' in str(error).lower():
        print(f"[ERROR] é¸æ“‡å™¨å¤±æ•ˆ: {selector}")
        return 'UPDATE_REQUIRED'  # éœ€è¦æ›´æ–°é¸æ“‡å™¨
    elif 'disabled' in str(error).lower():
        return 'WAIT'  # ç­‰å¾…å…ƒç´ å•Ÿç”¨
    else:
        return 'RETRY'
```

#### 1.3 æ¥­å‹™é‚è¼¯éŒ¯èª¤
ç”±æ–¼æ¥­å‹™é‚è¼¯å•é¡Œå°è‡´çš„éŒ¯èª¤ã€‚

**å¸¸è¦‹çš„æ¥­å‹™é‚è¼¯éŒ¯èª¤**ï¼š
1. **é©—è­‰å¤±æ•—**
   - é›»éƒµæ ¼å¼ä¸æ­£ç¢º
   - å¿…å¡«æ¬„ä½æœªå¡«
   - æ•¸å€¼è¶…å‡ºç¯„åœ

2. **åº«å­˜å•é¡Œ**
   - æ‰€é¸åº§ä½å·²å”®å‡º
   - æ‰€é¸æ—¥æœŸç„¡ç¥¨
   - æ‰€é¸æ•¸é‡è¶…éé™åˆ¶

3. **è³¬æˆ¶å•é¡Œ**
   - å¸³è™Ÿä¸å­˜åœ¨
   - å¯†ç¢¼éŒ¯èª¤
   - å¸³è™Ÿè¢«é–å®š

4. **æ¥­å‹™è¦å‰‡é•å**
   - ä¸ç¬¦åˆè³¼ç¥¨æ¢ä»¶
   - è¶…éè³¼ç¥¨é™é¡
   - æ™‚é–“é™åˆ¶

**è™•ç†ç­–ç•¥**ï¼š
```python
async def handle_business_error(error_message: str) -> str:
    """è™•ç†æ¥­å‹™é‚è¼¯éŒ¯èª¤"""
    if 'å·²å”®å®Œ' in error_message or 'åº«å­˜ä¸è¶³' in error_message:
        return 'STOP'  # åœæ­¢ï¼Œç„¡ç¥¨å¯è²·
    elif 'é©—è­‰å¤±æ•—' in error_message or 'æ ¼å¼ä¸æ­£ç¢º' in error_message:
        return 'MANUAL'  # éœ€è¦æ‰‹å‹•ä¿®æ­£
    elif 'å¸³è™Ÿä¸å­˜åœ¨' in error_message or 'å¯†ç¢¼éŒ¯èª¤' in error_message:
        return 'STOP'  # åœæ­¢ï¼Œå¸³è™Ÿå•é¡Œ
    else:
        return 'RETRY'
```

#### 1.4 ä¼ºæœå™¨éŒ¯èª¤
å¹³å°ä¼ºæœå™¨ç™¼ç”Ÿçš„éŒ¯èª¤ã€‚

**å¸¸è¦‹çš„ä¼ºæœå™¨éŒ¯èª¤**ï¼š
1. **HTTP 5xx éŒ¯èª¤**
   - 500 Internal Server Error
   - 502 Bad Gateway
   - 503 Service Unavailable

2. **å¹³å°ç‰¹å®šéŒ¯èª¤**
   - å¹³å°è‡ªå®šç¾©çš„éŒ¯èª¤è¨Šæ¯
   - API éŒ¯èª¤éŸ¿æ‡‰

**è™•ç†ç­–ç•¥**ï¼š
```python
async def handle_server_error(status_code: int) -> str:
    """è™•ç†ä¼ºæœå™¨éŒ¯èª¤"""
    if status_code >= 500:
        return 'RETRY'  # ä¼ºæœå™¨éŒ¯èª¤ï¼Œå¯é‡è©¦
    elif status_code == 429:
        return 'WAIT'   # é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…å¾Œé‡è©¦
    else:
        return 'RETRY'
```

### 2. éŒ¯èª¤ç›£æ§èˆ‡è¨˜éŒ„

#### 2.1 è©³ç´°çš„éŒ¯èª¤è¨˜éŒ„
è¨˜éŒ„æ‰€æœ‰éŒ¯èª¤ä¿¡æ¯ä»¥ä¾¿é™¤éŒ¯ã€‚

**è¨˜éŒ„å…§å®¹**ï¼š
1. **æ™‚é–“æˆ³**
   - éŒ¯èª¤ç™¼ç”Ÿæ™‚é–“

2. **éŒ¯èª¤ä½ç½®**
   - ç™¼ç”ŸéŒ¯èª¤çš„å‡½æ•¸ã€è¡Œè™Ÿ

3. **éŒ¯èª¤ä¿¡æ¯**
   - å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯
   - å †æ£§è¿½è¹¤

4. **ä¸Šä¸‹æ–‡ä¿¡æ¯**
   - ç•¶å‰ URL
   - ç•¶å‰é é¢æ¨™é¡Œ
   - ç›¸é—œçš„è®Šæ•¸å€¼

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3700-3750

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
import traceback

async def log_error(error: Exception, context: dict):
    """è¨˜éŒ„éŒ¯èª¤ä¿¡æ¯"""
    error_log = {
        'timestamp': datetime.now().isoformat(),
        'error_type': type(error).__name__,
        'error_message': str(error),
        'traceback': traceback.format_exc(),
        'context': context
    }

    # å¯«å…¥æ—¥èªŒæ–‡ä»¶
    with open('.temp/error.log', 'a', encoding='utf-8') as f:
        f.write(json.dumps(error_log, ensure_ascii=False) + '\n')

    print(f"[ERROR] {error_log['error_message']}")
```

#### 2.2 éŒ¯èª¤åˆ†é¡èˆ‡çµ±è¨ˆ
çµ±è¨ˆå„é¡éŒ¯èª¤çš„ç™¼ç”Ÿé »ç‡ã€‚

**çµ±è¨ˆé …ç›®**ï¼š
- ç¶²è·¯éŒ¯èª¤ç™¼ç”Ÿæ¬¡æ•¸
- é é¢éŒ¯èª¤ç™¼ç”Ÿæ¬¡æ•¸
- æ¥­å‹™é‚è¼¯éŒ¯èª¤ç™¼ç”Ÿæ¬¡æ•¸
- ä¼ºæœå™¨éŒ¯èª¤ç™¼ç”Ÿæ¬¡æ•¸

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3750-3800

### 3. éŒ¯èª¤æ¢å¾©ç­–ç•¥

#### 3.1 è‡ªå‹•é‡è©¦
å°å¯é‡è©¦çš„éŒ¯èª¤è‡ªå‹•é€²è¡Œé‡è©¦ã€‚

**é‡è©¦æ¢ä»¶**ï¼š
- ç¶²è·¯éŒ¯èª¤ â†’ é‡è©¦
- æš«æ™‚æ€§ä¼ºæœå™¨éŒ¯èª¤ (5xx) â†’ é‡è©¦
- é¸æ“‡å™¨å¤±æ•ˆ â†’ ä¸é‡è©¦ï¼ˆéœ€è¦ä»£ç¢¼æ›´æ–°ï¼‰

**é‡è©¦é‚è¼¯**ï¼š
```python
async def retry_with_exponential_backoff(
    func, max_retries: int = 3, initial_delay: int = 1
) -> bool:
    """æŒ‡æ•¸é€€é¿é‡è©¦"""
    for attempt in range(max_retries):
        try:
            return await func()
        except Exception as e:
            if attempt < max_retries - 1:
                delay = initial_delay * (2 ** attempt)
                print(f"[RETRY] ç­‰å¾… {delay} ç§’å¾Œé€²è¡Œç¬¬ {attempt + 2} æ¬¡å˜—è©¦")
                await asyncio.sleep(delay)
            else:
                print(f"[ERROR] å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸")
                return False
```

#### 3.2 éŒ¯èª¤å›é€€
å¯¦ç¾å¾éŒ¯èª¤æ¢å¾©çš„å›é€€æ©Ÿåˆ¶ã€‚

**å›é€€ç­–ç•¥**ï¼š
1. **ä½¿ç”¨å‚™é¸æ–¹æ³•**
   - æŸå€‹å…ƒç´ ç„¡æ³•æ‰¾åˆ° â†’ ä½¿ç”¨å‚™é¸é¸æ“‡å™¨
   - æŸå€‹ API å¤±æ•— â†’ ä½¿ç”¨å‚™é¸ API

2. **é™ç´šè™•ç†**
   - æŸåŠŸèƒ½å¤±æ•— â†’ è·³éè©²åŠŸèƒ½ç¹¼çºŒ
   - ç‰¹å®šå„ªåŒ–å¤±æ•— â†’ ä½¿ç”¨é è¨­æ–¹å¼

3. **ç”¨æˆ¶äº¤äº’**
   - è‡ªå‹•åŒ–å¤±æ•— â†’ æç¤ºç”¨æˆ¶é€²è¡Œæ‰‹å‹•æ“ä½œ
   - é©—è­‰ç¢¼è­˜åˆ¥å¤±æ•— â†’ è¦æ±‚æ‰‹å‹•è¼¸å…¥

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3800-3850

#### 3.3 å„ªé›…åœæ­¢
ç•¶éŒ¯èª¤ç„¡æ³•ä¿®å¾©æ™‚ï¼Œå„ªé›…åœ°åœæ­¢ç¨‹å¼ã€‚

**åœæ­¢æµç¨‹**ï¼š
1. è¨˜éŒ„ç•¶å‰ç‹€æ…‹
2. æ¸…ç†è³‡æºï¼ˆé—œé–‰ç€è¦½å™¨ç­‰ï¼‰
3. è¼¸å‡ºæœ€çµ‚å ±å‘Š
4. è¿”å›éé›¶é€€å‡ºç¢¼

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def graceful_shutdown(browser, error_message: str):
    """å„ªé›…åœ°åœæ­¢ç¨‹å¼"""
    print(f"[FATAL] {error_message}")

    # è¨˜éŒ„æœ€çµ‚ç‹€æ…‹
    with open('.temp/final_status.json', 'w', encoding='utf-8') as f:
        json.dump({
            'status': 'FAILED',
            'error': error_message,
            'timestamp': datetime.now().isoformat()
        }, f, ensure_ascii=False)

    # é—œé–‰ç€è¦½å™¨
    if browser:
        try:
            await browser.close()
        except:
            pass

    # è¿”å›å¤±æ•—
    exit(1)
```

### 4. ä½¿ç”¨è€…é€šçŸ¥

#### 4.1 éŒ¯èª¤è¨Šæ¯æç¤º
å‘ä½¿ç”¨è€…æ¸…æ™°åœ°èªªæ˜ç™¼ç”Ÿçš„éŒ¯èª¤ã€‚

**è¨Šæ¯å…§å®¹**ï¼š
1. **ç°¡çŸ­æè¿°**
   - ä½¿ç”¨è€…èƒ½ç†è§£çš„èªè¨€
   - ä¾‹ï¼šã€Œç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ã€

2. **å¯èƒ½çš„åŸå› **
   - ç¶²è·¯é€£æ¥å•é¡Œ
   - å¹³å°æš«æ™‚æ•…éšœ

3. **å»ºè­°çš„æ“ä½œ**
   - æª¢æŸ¥ç¶²è·¯é€£æ¥
   - é‡è©¦æˆ–æ‰‹å‹•æ“ä½œ

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3850-3900

#### 4.2 è²éŸ³èˆ‡è¦–è¦ºæç¤º
ç•¶éœ€è¦æ‰‹å‹•ä»‹å…¥æ™‚æç¤ºä½¿ç”¨è€…ã€‚

**æç¤ºæ–¹å¼**ï¼š
- æ’­æ”¾èœ‚é³´è²æˆ–æç¤ºéŸ³
- æ¨™é¡Œæ¬„é–ƒçˆ
- ç³»çµ±é€šçŸ¥

---

## å¹³å°ç‰¹å®šéŒ¯èª¤

### TixCraft
**å¸¸è¦‹éŒ¯èª¤**ï¼š
- Cookie éæœŸ
- JavaScript åŸ·è¡Œå¤±æ•—
- æ’éšŠè¶…æ™‚

### KKTIX
**å¸¸è¦‹éŒ¯èª¤**ï¼š
- å‹•æ…‹åŠ è¼‰å¤±æ•—
- è¡¨å–®é©—è­‰éŒ¯èª¤
- åº«å­˜ç«¶çˆ­

### iBon
**å¸¸è¦‹éŒ¯èª¤**ï¼š
- Shadow DOM çµæ§‹è¤‡é›œ
- Angular æ‡‰ç”¨åŠ è¼‰ç·©æ…¢
- é¸æ“‡å™¨é »ç¹æ”¹è®Š

### TicketPlus
**å¸¸è¦‹éŒ¯èª¤**ï¼š
- å±•é–‹é¢æ¿æ“ä½œè¤‡é›œ
- å¤šæ­¥é©Ÿæµç¨‹ä¸­çš„ç‹€æ…‹ç®¡ç†
- å¯¦åé©—è­‰å¤±æ•—

---

## æˆåŠŸæ¨™æº–

**SC-009: éŒ¯èª¤æ¢å¾©èƒ½åŠ›** â‰¥ 90%
- ç³»çµ±é­é‡éŒ¯èª¤æ™‚çš„æ¢å¾©æˆåŠŸç‡

---

## ç›¸é—œåŠŸèƒ½éœ€æ±‚

| FR ç·¨è™Ÿ | åŠŸèƒ½åç¨± | ç‹€æ…‹ |
|---------|---------|------|
| FR-058 | éŒ¯èª¤åˆ†é¡èˆ‡è­˜åˆ¥ | âœ… å¯¦ä½œ |
| FR-059 | è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ | âœ… å¯¦ä½œ |
| FR-060 | å„ªé›…åœæ­¢ | âœ… å¯¦ä½œ |

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1: ç„¡é™é‡è©¦è¿´åœˆ
**ç—‡ç‹€**ï¼šç¨‹å¼ä¸æ–·é‡è©¦å»ç„¡é€²å±•

**å¯èƒ½åŸå› **ï¼š
- éŒ¯èª¤é¡å‹åˆ¤æ–·ä¸æ­£ç¢º
- é‡è©¦æ¢ä»¶è¨­å®šä¸ç•¶
- æ²’æœ‰æœ€å¤§é‡è©¦é™åˆ¶

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥éŒ¯èª¤åˆ†é¡é‚è¼¯
2. è¨­å®šåˆç†çš„æœ€å¤§é‡è©¦æ¬¡æ•¸
3. æ·»åŠ è¶…æ™‚æ©Ÿåˆ¶

### å•é¡Œ 2: é‡è¦éŒ¯èª¤è¢«å¿½ç•¥
**ç—‡ç‹€**ï¼šç¨‹å¼ç¹¼çºŒåŸ·è¡Œä½†å¯¦éš›å·²å¤±æ•—

**å¯èƒ½åŸå› **ï¼š
- éŒ¯èª¤è™•ç†éæ–¼å¯¬é¬†
- æŸäº›ç•°å¸¸æœªè¢«æ•ç²
- å‚™é¸æ–¹æ³•ä¹Ÿå¤±æ•—ä½†æœªæª¢æ¸¬

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„ç•°å¸¸
2. æ”¹é€²éŒ¯èª¤æª¢æ¸¬é‚è¼¯
3. æ·»åŠ è©³ç´°çš„æ—¥èªŒè¨˜éŒ„

---

## æœ€ä½³å¯¦è¸

### âœ… æ¨è–¦åšæ³•

1. **ç«‹å³æ•ç²ç•°å¸¸**
   - åœ¨é—œéµæ“ä½œå‘¨åœä½¿ç”¨ try-except
   - æ•ç²ç‰¹å®šçš„ç•°å¸¸é¡å‹

2. **åˆ†é¡éŒ¯èª¤**
   - å€åˆ†å¯é‡è©¦å’Œä¸å¯é‡è©¦çš„éŒ¯èª¤
   - ç‚ºä¸åŒé¡å‹çš„éŒ¯èª¤å¯¦æ–½ä¸åŒç­–ç•¥

3. **è©³ç´°è¨˜éŒ„**
   - è¨˜éŒ„æ‰€æœ‰éŒ¯èª¤ç´°ç¯€
   - ä¾¿æ–¼å¾ŒçºŒåˆ†æå’Œæ”¹é€²

4. **è¨­å®šè¶…æ™‚**
   - é¿å…ç„¡é™ç­‰å¾…
   - åŠæ™‚ç™¼ç¾ä¸¦å ±å‘ŠéŒ¯èª¤

### âŒ é¿å…åšæ³•

1. âŒ ä½¿ç”¨éæ–¼å¯¬é¬†çš„ç•°å¸¸æ•ç²
   ```python
   # âŒ ä¸å¥½
   try:
       ...
   except:
       pass
   ```

2. âŒ å¿½ç•¥ç•°å¸¸
   ```python
   # âŒ ä¸å¥½
   result = perform_action()  # å¯èƒ½æ‹‹å‡ºç•°å¸¸ä½†æœªè™•ç†
   ```

3. âŒ ç„¡é™é‡è©¦
   ```python
   # âŒ ä¸å¥½
   while True:
       try:
           ...
       except:
           pass  # ç„¡é™è¿´åœˆ
   ```

---

## é–‹ç™¼æª¢æŸ¥æ¸…å–®

- [ ] ç¶²è·¯éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] é é¢éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] æ¥­å‹™é‚è¼¯éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] ä¼ºæœå™¨éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] éŒ¯èª¤è¨˜éŒ„è©³ç´°
- [ ] é‡è©¦é‚è¼¯æ­£ç¢º
- [ ] æ‰€æœ‰å¹³å°æ¸¬è©¦é€šé

---

## æ›´æ–°æ—¥æœŸ

- **2025-11**: åˆå§‹æ–‡ä»¶å»ºç«‹
- **ç›¸é—œè¦æ ¼**: `specs/001-ticket-automation-system/spec.md`
- **é©—è­‰ç‹€æ…‹**: âœ… Phase 3 æ©Ÿåˆ¶æ–‡ä»¶å®Œæˆ

