# Stage 0: 設定檔 Hot Reload 機制

**文件說明**：搶票執行中即時修改設定，無需重新啟動程式
**最後更新**：2026-02-03
**版本**：v1.0

---

## 概述

Hot Reload 機制允許使用者在搶票過程中修改設定，程式會自動偵測 `settings.json` 的變更並即時套用，無需重新啟動。

**適用場景**：
- 搶票中臨時調整關鍵字、票數、刷新間隔
- 切換日期/區域遞補策略
- 開啟/關閉除錯訊息
- 修改折扣碼或優惠代碼

**運作原理**：
1. 程式每 50ms 檢查 `settings.json` 的修改時間
2. 偵測到變更後等待 100ms（確保檔案寫入完成）
3. 讀取整個檔案並更新白名單內的設定項目
4. 非白名單的設定不受影響（需重啟才會生效）

---

## 支援即時修改的設定

以下設定可以在搶票中修改，程式會**自動套用**，不需要重新啟動。

### 基本設定

| 設定名稱（UI） | 說明 |
|---------------|------|
| 張數 | 要購買的票券數量 |
| 日期關鍵字 | 指定日期的關鍵字（含排序方式） |
| 區域關鍵字 | 指定區域的關鍵字（含排序方式） |
| 排除關鍵字 | 排除不想要的日期/區域 |
| 日期自動遞補 | 關鍵字未匹配時自動選擇 |
| 區域自動遞補 | 關鍵字未匹配時自動選擇 |
| 刷新在指定時間 | 自動開始搶票的時間 |
| 聯絡人資訊 | 姓名、電話、信用卡前碼 |

### 進階設定

| 設定名稱（UI） | 說明 |
|---------------|------|
| 自動刷新頁面間隔(秒) | 頁面重新載入間隔 |
| 輸出除錯訊息 | 顯示詳細執行日誌 |
| 有票時播放音效 | 偵測到票時播放提示音 |
| 訂購時播放音效 | 訂單成功時播放提示音 |
| 音效檔 | 音效檔案路徑 |
| 允許不連續座位 | 允許選擇不相鄰的座位 |
| 隱藏部份圖片 | 加速頁面載入 |
| 自動猜測驗證問題 | 自動嘗試回答驗證問題 |
| 使用者自定字典 | 預設答案清單 |
| 優惠代碼 | 折扣碼/會員碼 |
| Discord Webhook URL | Discord 通知網址 |
| 自動刷新過熱次數 | 連續刷新上限 |
| 自動刷新過熱冷卻(秒) | 過熱冷卻時間 |
| 系統時間 - 暫停關鍵字 | 觸發暫停的時間 |
| 系統時間 - 繼續關鍵字 | 觸發繼續的時間 |
| 秒數 - 暫停關鍵字 | 觸發暫停的秒數 |
| 秒數 - 繼續關鍵字 | 觸發繼續的秒數 |

### 驗證碼設定

| 設定名稱（UI） | 說明 |
|---------------|------|
| OCR（啟用） | 啟用 OCR 自動辨識 |
| OCR圖片取得方式 | canvas/element |
| 自動送出 | OCR 辨識後自動提交 |
| 自訂 OCR 模型 | OCR 模型路徑 |

### 平台專用設定

| 設定名稱（UI） | 平台 | 說明 |
|---------------|------|------|
| 跳過已售完日期 | 拓元 | 自動略過售完場次 |
| 自動刷新即將開賣頁面 | 拓元 | 開賣前自動刷新 |
| KKTIX點選下一步按鈕 | KKTIX | 自動點擊下一步 |
| 自動填入張數 | KKTIX | 自動選擇票數 |
| KKTIX購票最長停留(秒) | KKTIX | 最大等待時間 |

---

## 不支援即時修改的設定（需重啟）

以下設定修改後**必須重新啟動程式**才能生效。

### 瀏覽器與執行環境

| 設定名稱（UI） | 原因 |
|---------------|------|
| 網址 | 影響瀏覽器導航目標 |
| 瀏覽器 | 需要重新初始化瀏覽器 |
| WebDriver類別 | 需要重新初始化驅動程式 |
| Chrome 瀏覽器擴充功能 | 需要瀏覽器重啟載入 |
| 無圖形界面模式 | 需要瀏覽器重啟 |
| 瀏覽器視窗大小 | 需要瀏覽器重啟 |
| 設定介面 Port | 需要重啟 Web Server |
| Proxy IP:PORT | 需要重新初始化網路連線 |
| 重新啟動瀏覽器間隔(秒) | 影響瀏覽器生命週期 |

### 帳號登入資訊

| 設定名稱（UI） | 原因 |
|---------------|------|
| 拓元家族 cookie TIXUISID | 需要重新設定 Cookie |
| ibon cookie ibonqware | 需要重新設定 Cookie |
| 所有平台帳號/密碼 | 需要重新執行登入流程 |

---

## 使用方式

### 方法一：透過設定介面修改

1. 搶票程式執行中，開啟設定介面（瀏覽器連接 `http://127.0.0.1:16888`）
2. 修改需要調整的設定
3. 點選「儲存」按鈕
4. 程式會在 1 秒內自動套用新設定

### 方法二：直接編輯 settings.json

1. 用文字編輯器開啟 `settings.json`
2. 修改需要調整的欄位
3. 儲存檔案
4. 程式會在 1 秒內自動套用新設定

**注意**：直接編輯 JSON 檔案時，請確保格式正確，否則程式會忽略此次變更。

---

## 常見使用場景

### 搶票中調整關鍵字

如果發現目標區域名稱與預設關鍵字不符：
1. 在設定介面修改「區域關鍵字」
2. 點選儲存
3. 程式立即使用新關鍵字匹配

### 搶票中調整票數

如果原本想買 4 張但只剩 2 張：
1. 在設定介面將「張數」改為 2
2. 點選儲存
3. 程式立即使用新票數

### 搶票中開啟除錯訊息

如果需要排查問題：
1. 在設定介面勾選「輸出除錯訊息」
2. 點選儲存
3. 程式立即開始輸出詳細日誌

---

## 技術限制

1. **偵測間隔**：約 50ms 偵測一次檔案變更，實際套用時間約 150ms
2. **原子更新**：整個設定物件一次替換，不會出現半更新狀態
3. **錯誤容錯**：如果 JSON 格式錯誤，程式會沿用上一次的有效設定
4. **物件替換**：巢狀設定（如日期關鍵字）會整個替換，不是部分合併

---

## 相關文件

- [設定術語對照表](../11-reference/settings-terminology.md)
- [12-Stage 標準](../02-development/ticket_automation_standard.md)
- [Stage 1: 環境初始化](./01-environment-init.md)

---

## 版本歷史

| 版本 | 日期 | 變更內容 |
|------|------|---------|
| v1.0 | 2026-02-03 | 初版：Hot Reload 機制文件 (PR #231 by @Yurains) |
