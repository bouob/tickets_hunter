# æ©Ÿåˆ¶ 10ï¼šè¨‚å–®é€å‡º (Stage 10)

## æ¦‚è¿°

è¨‚å–®é€å‡ºæ˜¯è³¼ç¥¨æµç¨‹ä¸­çš„æœ€å¾Œé—œéµæ­¥é©Ÿã€‚ç³»çµ±éœ€è¦å®šä½æäº¤æŒ‰éˆ•ã€é©—è­‰è¡¨å–®å®Œæ•´æ€§ã€é»æ“Šæäº¤æŒ‰éˆ•ï¼Œä¸¦ç¢ºèªè¨‚å–®å·²æˆåŠŸé€å‡ºã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼šæˆåŠŸé€å‡ºè¨‚å–®ï¼Œé€²å…¥ä»˜æ¬¾æˆ–ç¢ºèªéšæ®µã€‚

**å„ªå…ˆåº¦**ï¼šğŸ”´ P1 - æ ¸å¿ƒæµç¨‹ï¼Œç›´æ¥æ±ºå®šè³¼ç¥¨æˆåŠŸ

---

## è¨‚å–®é€å‡ºæµç¨‹

### 1. æäº¤æŒ‰éˆ•å®šä½

#### 1.1 å°‹æ‰¾æäº¤æŒ‰éˆ•
ç³»çµ±è­˜åˆ¥è³¼ç¥¨è¡¨å–®çš„æäº¤æŒ‰éˆ•ã€‚

**å¸¸è¦‹çš„æäº¤æŒ‰éˆ•**ï¼š
- æ–‡å­—ï¼šã€Œæäº¤ã€ã€ã€Œé€å‡ºè¨‚å–®ã€ã€ã€Œè³¼è²·ã€ã€ã€Œç¢ºèªã€
- è‹±æ–‡ï¼šã€ŒSubmitã€ã€ã€ŒBuyã€ã€ã€ŒPurchaseã€ã€ã€ŒCheckoutã€
- ID/Classï¼š`submit`, `btn-submit`, `purchase-btn`

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 2700-2800

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def find_submit_button(page):
    """å°‹æ‰¾è¨‚å–®æäº¤æŒ‰éˆ•"""
    selectors = [
        'button[type="submit"]',
        'button:has-text("æäº¤")',
        'button:has-text("é€å‡ºè¨‚å–®")',
        'button:has-text("è³¼è²·")',
        'button[id*="submit"]',
        'button[class*="submit"]',
        'a.btn-submit'
    ]

    for selector in selectors:
        try:
            button = await page.query_selector(selector)
            if button and await button.is_visible():
                print(f"[SUBMIT] æ‰¾åˆ°æäº¤æŒ‰éˆ•: {selector}")
                return button
        except:
            pass

    print("[WARNING] ç„¡æ³•æ‰¾åˆ°æäº¤æŒ‰éˆ•")
    return None
```

#### 1.2 æŒ‰éˆ•ç‹€æ…‹æª¢æŸ¥
é©—è­‰æäº¤æŒ‰éˆ•æ˜¯å¦å¯ç”¨ï¼ˆæœªç¦ç”¨ï¼‰ã€‚

**æª¢æŸ¥é …ç›®**ï¼š
1. æŒ‰éˆ•æ˜¯å¦ `disabled`
2. æŒ‰éˆ•æ˜¯å¦å¯è¦‹
3. æŒ‰éˆ•æ˜¯å¦å¯äº’å‹•

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 2800-2850

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def check_submit_button_enabled(page, button) -> bool:
    """æª¢æŸ¥æäº¤æŒ‰éˆ•æ˜¯å¦å¯ç”¨"""
    try:
        # æª¢æŸ¥æ˜¯å¦ç¦ç”¨
        is_disabled = await button.get_attribute('disabled')
        if is_disabled is not None:
            print("[ERROR] æäº¤æŒ‰éˆ•å·²ç¦ç”¨ï¼Œå¯èƒ½è¡¨å–®æœ‰èª¤")
            return False

        # æª¢æŸ¥æ˜¯å¦å¯è¦‹
        if not await button.is_visible():
            print("[ERROR] æäº¤æŒ‰éˆ•ä¸å¯è¦‹")
            return False

        print("[SUBMIT] æäº¤æŒ‰éˆ•å¯ç”¨")
        return True

    except Exception as e:
        print(f"[ERROR] æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹å¤±æ•—: {e}")
        return False
```

### 2. è¡¨å–®é©—è­‰å‰æª¢æŸ¥

#### 2.1 å®¢æˆ¶ç«¯é©—è­‰æª¢æŸ¥
åœ¨æäº¤å‰æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•é©—è­‰éŒ¯èª¤ã€‚

**æª¢æŸ¥é …ç›®**ï¼š
1. æŸ¥çœ‹æ˜¯å¦æœ‰ç´…è‰²çš„éŒ¯èª¤è¨Šæ¯
2. å¿…å¡«æ¬„ä½æ˜¯å¦éƒ½å·²å¡«å¯«
3. æ˜¯å¦æœ‰è­¦å‘Šè¨Šæ¯

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 2850-2900

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def check_form_errors(page) -> bool:
    """æª¢æŸ¥è¡¨å–®æ˜¯å¦æœ‰é©—è­‰éŒ¯èª¤"""
    # å°‹æ‰¾éŒ¯èª¤è¨Šæ¯
    error_elements = await page.query_selector_all(
        '.error, .error-message, [role="alert"], .invalid-feedback'
    )

    if error_elements and len(error_elements) > 0:
        print(f"[WARNING] ç™¼ç¾ {len(error_elements)} å€‹è¡¨å–®éŒ¯èª¤")
        for error in error_elements:
            text = await error.get_text()
            print(f"[ERROR MESSAGE] {text}")
        return False

    print("[SUBMIT] è¡¨å–®é©—è­‰é€šéï¼Œç„¡éŒ¯èª¤")
    return True
```

#### 2.2 æœ€å¾Œç¢ºèª
æœ€å¾Œæª¢æŸ¥æ‰€æœ‰é—œéµä¿¡æ¯æ˜¯å¦æ­£ç¢ºã€‚

**ç¢ºèªé …ç›®**ï¼š
- ç¥¨æ•¸æ˜¯å¦æ­£ç¢º
- æ—¥æœŸæ˜¯å¦æ­£ç¢º
- åº§ä½å€åŸŸæ˜¯å¦æ­£ç¢º
- åƒ¹æ ¼æ˜¯å¦åˆç†

### 3. è¨‚å–®æäº¤

#### 3.1 é»æ“Šæäº¤æŒ‰éˆ•
é»æ“Šæäº¤æŒ‰éˆ•æäº¤è¨‚å–®ã€‚

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 2900-2950

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def submit_order(page, button):
    """æäº¤è¨‚å–®"""
    try:
        print("[SUBMIT] æ­£åœ¨æäº¤è¨‚å–®...")

        # é»æ“Šæäº¤æŒ‰éˆ•
        await button.click()
        print("[SUBMIT] å·²é»æ“Šæäº¤æŒ‰éˆ•")

        # ç­‰å¾…é é¢éŸ¿æ‡‰
        await page.wait_for_load_state('networkidle2', timeout=10000)
        print("[SUBMIT] é é¢å·²åŠ è¼‰")

        return True

    except asyncio.TimeoutError:
        print("[WARNING] æäº¤å¾Œé é¢åŠ è¼‰è¶…æ™‚ï¼Œä½†å¯èƒ½å·²æäº¤")
        return True

    except Exception as e:
        print(f"[ERROR] æäº¤è¨‚å–®å¤±æ•—: {e}")
        return False
```

#### 3.2 é‡è¤‡æäº¤é˜²è­·
æŸäº›å¹³å°å¯èƒ½ç¦ç”¨æŒ‰éˆ•ä»¥é˜²æ­¢é‡è¤‡æäº¤ã€‚

**é˜²è­·æ©Ÿåˆ¶**ï¼š
1. é»æ“Šå¾Œç«‹å³ç¦ç”¨æŒ‰éˆ•ï¼ˆæŸäº›å¹³å°è‡ªå‹•ï¼‰
2. ç­‰å¾…ä¸€æ®µæ™‚é–“é¿å…é‡è¤‡é»æ“Š
3. ç›£æ§é é¢è®ŠåŒ–ä»¥ç¢ºèªå·²æäº¤

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 2950-3000

### 4. æäº¤æˆåŠŸé©—è­‰

#### 4.1 æª¢æŸ¥è¨‚å–®ç¢ºèªé é¢
é©—è­‰æ˜¯å¦é€²å…¥è¨‚å–®ç¢ºèªé é¢ã€‚

**ç¢ºèªé é¢æŒ‡æ¨™**ï¼š
1. **URL è®ŠåŒ–**
   - é€šå¸¸é€²å…¥ `/order/confirmation` æˆ– `/checkout/success` é é¢
   - URL å¯èƒ½åŒ…å«è¨‚å–®è™Ÿ

2. **é é¢å…§å®¹**
   - å‡ºç¾ã€Œè¨‚å–®å·²æˆåŠŸé€å‡ºã€è¨Šæ¯
   - é¡¯ç¤ºè¨‚å–®è™Ÿ
   - é¡¯ç¤ºè¨‚å–®è©³æƒ…

3. **é é¢å…ƒç´ **
   - å‡ºç¾ã€Œç¹¼çºŒä»˜æ¬¾ã€ã€ã€Œè¿”å›ä¸»é ã€æŒ‰éˆ•
   - é¡¯ç¤ºè¨‚å–®æ‘˜è¦

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3000-3050

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def verify_order_submission(page) -> bool:
    """é©—è­‰è¨‚å–®æ˜¯å¦æˆåŠŸé€å‡º"""
    try:
        # æ–¹æ³• 1: æª¢æŸ¥ URL
        if 'confirmation' in page.url or 'success' in page.url or 'order' in page.url:
            print("[SUCCESS] è¨‚å–®å·²æˆåŠŸé€å‡ºï¼ˆURL è®ŠåŒ–ï¼‰")
            return True

        # æ–¹æ³• 2: æª¢æŸ¥æˆåŠŸè¨Šæ¯
        success_message = await page.query_selector(
            'text=æˆåŠŸ, text=Success, text=ç¢ºèª, text=Confirmation'
        )
        if success_message:
            print("[SUCCESS] è¨‚å–®å·²æˆåŠŸé€å‡ºï¼ˆæˆåŠŸè¨Šæ¯ï¼‰")
            return True

        # æ–¹æ³• 3: æª¢æŸ¥è¨‚å–®è™Ÿ
        order_id = await page.query_selector(
            '[data-testid*="order"], .order-id, .order-number'
        )
        if order_id:
            id_text = await order_id.get_text()
            print(f"[SUCCESS] è¨‚å–®å·²æˆåŠŸé€å‡ºï¼Œè¨‚å–®è™Ÿ: {id_text}")
            return True

        return False

    except Exception as e:
        print(f"[ERROR] é©—è­‰è¨‚å–®å¤±æ•—: {e}")
        return False
```

#### 4.2 æå–è¨‚å–®è™Ÿ
æå–ä¸¦è¨˜éŒ„è¨‚å–®è™Ÿä»¥ä¾›å¾ŒçºŒè¿½è¹¤ã€‚

**è¨‚å–®è™Ÿä¾†æº**ï¼š
1. é é¢é¡¯ç¤ºçš„è¨‚å–®è™Ÿ
2. URL ä¸­çš„è¨‚å–® ID
3. é›»å­éƒµä»¶ç¢ºèªè¨Šæ¯

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3050-3100

### 5. éŒ¯èª¤è™•ç†

#### 5.1 æäº¤å¤±æ•—çš„å¸¸è¦‹åŸå› 
è­˜åˆ¥ä¸¦è™•ç†å¸¸è¦‹çš„æäº¤å¤±æ•—æƒ…æ³ã€‚

**å¸¸è¦‹éŒ¯èª¤**ï¼š
1. **è¡¨å–®é©—è­‰å¤±æ•—** - æŸäº›æ¬„ä½æ ¼å¼ä¸æ­£ç¢º
2. **ä¼ºæœå™¨éŒ¯èª¤** - å¹³å°ä¼ºæœå™¨å‡ºç¾å•é¡Œ
3. **æ”¯ä»˜å¤±æ•—** - ä¿¡ç”¨å¡æˆ–æ”¯ä»˜æ–¹å¼æœ‰å•é¡Œ
4. **åº«å­˜å·²å”®å®Œ** - å…¶ä»–ç”¨æˆ¶åœ¨åŒæ™‚è³¼ç¥¨

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3100-3150

#### 5.2 é‡è©¦é‚è¼¯
å¯¦ç¾é©ç•¶çš„é‡è©¦æ©Ÿåˆ¶ã€‚

**é‡è©¦æ¢ä»¶**ï¼š
- æš«æ™‚æ€§ä¼ºæœå™¨éŒ¯èª¤ â†’ å¯é‡è©¦
- è¡¨å–®é©—è­‰å¤±æ•— â†’ ä¿®æ­£å¾Œé‡è©¦
- åº«å­˜å·²å”®å®Œ â†’ ä¸é‡è©¦ï¼Œå ±éŒ¯

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def submit_with_retry(page, button, max_retries: int = 3) -> bool:
    """å¸¶é‡è©¦çš„è¨‚å–®æäº¤"""
    for attempt in range(max_retries):
        try:
            if await submit_order(page, button):
                if await verify_order_submission(page):
                    return True
        except Exception as e:
            print(f"[RETRY] ç¬¬ {attempt + 1} æ¬¡å˜—è©¦å¤±æ•—: {e}")

            if attempt < max_retries - 1:
                await asyncio.sleep(2)  # ç­‰å¾…å¾Œé‡è©¦
            else:
                print("[ERROR] è¨‚å–®æäº¤å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸")
                return False

    return False
```

---

## å¹³å°ç‰¹å®šè€ƒé‡

### TixCraft
- æäº¤å¾Œé€šå¸¸é€²å…¥ä»˜æ¬¾é é¢
- è¨‚å–®è™Ÿåœ¨ç¢ºèªé é¢é¡¯ç¤º

### KKTIX
- æäº¤å¾Œå¯èƒ½éœ€è¦é¡å¤–çš„ç¢ºèªæ­¥é©Ÿ
- å¯èƒ½æœ‰æ’éšŠç­‰å¾…

### iBon
- æäº¤æµç¨‹ç›¸å°ç°¡å–®
- ç¢ºèªå¾Œé€²å…¥æ”¯ä»˜

### TicketPlus
- å¯èƒ½æœ‰å¤šæ­¥é©Ÿçš„æäº¤æµç¨‹
- éœ€è¦é©—è­‰æ¯ä¸€æ­¥

---

## æˆåŠŸæ¨™æº–

**SC-010: è¨‚å–®é€å‡ºæˆåŠŸç‡** â‰¥ 95%
- ç³»çµ±æˆåŠŸé€å‡ºè¨‚å–®çš„æ¬¡æ•¸ / ç¸½å˜—è©¦æ¬¡æ•¸

**SC-011: è¨‚å–®ç¢ºèªæ™‚é–“** â‰¤ 10 ç§’
- å¾é»æ“Šæäº¤åˆ°ç¢ºèªé é¢çš„æ™‚é–“

---

## ç›¸é—œåŠŸèƒ½éœ€æ±‚

| FR ç·¨è™Ÿ | åŠŸèƒ½åç¨± | ç‹€æ…‹ |
|---------|---------|------|
| FR-043 | è¨‚å–®æäº¤ | âœ… å¯¦ä½œ |
| FR-044 | æäº¤é©—è­‰ | âœ… å¯¦ä½œ |

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1: æäº¤æŒ‰éˆ•è¢«ç¦ç”¨
**ç—‡ç‹€**ï¼šæäº¤æŒ‰éˆ•ç„¡æ³•é»æ“Šæˆ–å·²ç¦ç”¨

**å¯èƒ½åŸå› **ï¼š
- è¡¨å–®é©—è­‰å¤±æ•—
- å¿…å¡«æ¬„ä½æœªå¡«
- ç¶²è·¯é€£æ¥å•é¡Œ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥æ‰€æœ‰è¡¨å–®éŒ¯èª¤è¨Šæ¯
2. ç¢ºä¿æ‰€æœ‰å¿…å¡«æ¬„ä½å·²å¡«
3. æª¢æŸ¥ç¶²è·¯é€£æ¥

### å•é¡Œ 2: æäº¤å¾Œç„¡åæ‡‰
**ç—‡ç‹€**ï¼šé»æ“Šæäº¤å¾Œé é¢ç„¡è®ŠåŒ–

**å¯èƒ½åŸå› **ï¼š
- ç¶²è·¯è«‹æ±‚æœªç™¼é€
- ä¼ºæœå™¨æœªéŸ¿æ‡‰
- JavaScript åŸ·è¡Œå‡ºéŒ¯

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ç¶²è·¯è«‹æ±‚ï¼ˆé–‹ç™¼è€…å·¥å…·ï¼‰
2. ç­‰å¾…æ›´ä¹…æ™‚é–“ï¼ˆæŸäº›å¹³å°éŸ¿æ‡‰æ…¢ï¼‰
3. å˜—è©¦åˆ·æ–°é é¢

### å•é¡Œ 3: è¨‚å–®æäº¤æˆåŠŸä½†é©—è­‰å¤±æ•—
**ç—‡ç‹€**ï¼šè¨‚å–®å¯¦éš›å·²é€å‡ºä½†é©—è­‰é‚è¼¯æœªæª¢æ¸¬åˆ°

**å¯èƒ½åŸå› **ï¼š
- é©—è­‰é‚è¼¯ä¸æ­£ç¢º
- ç¢ºèªé é¢çµæ§‹æ”¹è®Š
- è¨‚å–®è™Ÿæ ¼å¼ä¸åŒ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥è¨‚å–®æ˜¯å¦å¯¦éš›å·²é€å‡ºï¼ˆéƒµä»¶ç¢ºèªï¼‰
2. æ›´æ–°é©—è­‰é‚è¼¯
3. æ·»åŠ å¤šé‡é©—è­‰æ–¹å¼

---

## æœ€ä½³å¯¦è¸

### âœ… æ¨è–¦åšæ³•

1. **å¤šé‡é©—è­‰ç¢ºèª**
   - ä¸è¦åªä¾è³´ä¸€ç¨®é©—è­‰æ–¹å¼
   - çµåˆ URLã€è¨Šæ¯ã€å…ƒç´ ç­‰å¤šå€‹æŒ‡æ¨™

2. **å¯¦ç¾é©ç•¶çš„é‡è©¦**
   - æš«æ™‚æ€§éŒ¯èª¤æ‡‰é‡è©¦
   - è¨­å®šåˆç†çš„æœ€å¤§é‡è©¦æ¬¡æ•¸

3. **è¨˜éŒ„è¨‚å–®è©³æƒ…**
   - ä¿å­˜è¨‚å–®è™Ÿã€æ™‚é–“æˆ³ç­‰ä¿¡æ¯
   - ä¾¿æ–¼å¾ŒçºŒè¿½è¹¤å’Œé™¤éŒ¯

### âŒ é¿å…åšæ³•

1. âŒ ç„¡è¦–è¡¨å–®é©—è­‰éŒ¯èª¤
   - æ‡‰ä¿®æ­£å¾Œå†æäº¤

2. âŒ ç›²ç›®é‡è©¦
   - æ‡‰åˆ¤æ–·éŒ¯èª¤é¡å‹å†æ±ºå®šæ˜¯å¦é‡è©¦

3. âŒ æäº¤å¾Œç«‹å³é—œé–‰é é¢
   - æ‡‰ç­‰å¾…ç¢ºèªè¨Šæ¯å‡ºç¾

---

## é–‹ç™¼æª¢æŸ¥æ¸…å–®

- [ ] æäº¤æŒ‰éˆ•å®šä½æ­£ç¢º
- [ ] æŒ‰éˆ•ç‹€æ…‹æª¢æŸ¥æ­£ç¢º
- [ ] è¡¨å–®é©—è­‰æª¢æŸ¥å®Œæ•´
- [ ] æäº¤é»æ“ŠæˆåŠŸ
- [ ] æˆåŠŸé é¢é©—è­‰æº–ç¢º
- [ ] è¨‚å–®è™Ÿæå–æ­£ç¢º
- [ ] æ‰€æœ‰å¹³å°æ¸¬è©¦é€šé

---

## æ›´æ–°æ—¥æœŸ

- **2025-11**: åˆå§‹æ–‡ä»¶å»ºç«‹
- **ç›¸é—œè¦æ ¼**: `specs/001-ticket-automation-system/spec.md`
- **é©—è­‰ç‹€æ…‹**: ğŸ”„ Phase 3 é€²è¡Œä¸­

