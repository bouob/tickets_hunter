# æ©Ÿåˆ¶ 11ï¼šæ’éšŠèˆ‡ä»˜æ¬¾ (Stage 11)

## æ¦‚è¿°

åœ¨è¨‚å–®é€å‡ºå¾Œï¼ŒæŸäº›å¹³å°ï¼ˆç‰¹åˆ¥æ˜¯é«˜äººæ°£æ´»å‹•ï¼‰å¯èƒ½éœ€è¦æ’éšŠç­‰å¾…æˆ–é€²è¡Œæ”¯ä»˜æµç¨‹ã€‚ç³»çµ±éœ€è¦è™•ç†æ’éšŠç‹€æ…‹ã€è‡ªå‹•é€²è¡Œæ”¯ä»˜ï¼Œä¸¦ç¢ºèªè³¼ç¥¨æˆåŠŸã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼šå®Œæˆæ’éšŠç­‰å¾…å’Œæ”¯ä»˜æµç¨‹ï¼Œæœ€çµ‚ç¢ºèªè³¼ç¥¨æˆåŠŸã€‚

**å„ªå…ˆåº¦**ï¼šğŸ”´ P1 - æ ¸å¿ƒæµç¨‹

---

## æ’éšŠèˆ‡ä»˜æ¬¾æµç¨‹

### 1. æ’éšŠç‹€æ…‹è™•ç†

#### 1.1 æ’éšŠé é¢æª¢æ¸¬
æª¢æ¸¬æ˜¯å¦é€²å…¥æ’éšŠç‹€æ…‹ã€‚

**æ’éšŠé é¢æŒ‡æ¨™**ï¼š
1. **URL è®ŠåŒ–**
   - åŒ…å« `queue`ã€`waiting` ç­‰é—œéµå­—
   - ä¾‹ï¼š`/queue`ã€`/waiting-room`

2. **é é¢å…§å®¹**
   - ã€Œæ’éšŠä¸­ã€ã€ã€Œæº–å‚™é€²å…¥ã€è¨Šæ¯
   - é¡¯ç¤ºç•¶å‰æ’éšŠä½ç½®æˆ–é è¨ˆç­‰å¾…æ™‚é–“
   - å€’æ•¸è¨ˆæ™‚å™¨

3. **é é¢å…ƒç´ **
   - é€²åº¦æ¢æˆ–å€’æ•¸è¨ˆæ™‚å™¨
   - æ’éšŠè™Ÿç¢¼æˆ–ä½ç½®é¡¯ç¤º

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3200-3300

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def detect_queue_status(page) -> dict:
    """æª¢æ¸¬æ’éšŠç‹€æ…‹"""
    result = {
        'in_queue': False,
        'position': None,
        'estimated_wait': None
    }

    # æª¢æŸ¥ URL
    if 'queue' in page.url or 'waiting' in page.url:
        result['in_queue'] = True
        print("[QUEUE] æª¢æ¸¬åˆ°æ’éšŠç‹€æ…‹")

    # æŸ¥è©¢æ’éšŠä½ç½®
    position_elem = await page.query_selector('.queue-position, [data-position]')
    if position_elem:
        text = await position_elem.get_text()
        # è§£æä½ç½®ï¼ˆä¾‹å¦‚ã€Œå‰é¢é‚„æœ‰ 50 äººã€ï¼‰
        result['position'] = text

    return result
```

#### 1.2 æ’éšŠç­‰å¾…
ç­‰å¾…æ’éšŠå®Œæˆæˆ–é€²å…¥è³¼ç¥¨ç‹€æ…‹ã€‚

**ç­‰å¾…æ–¹æ³•**ï¼š
1. **ç›£æ§é é¢è®ŠåŒ–**
   - å®šæœŸæª¢æŸ¥æ’éšŠç‹€æ…‹
   - ç•¶é é¢è®ŠåŒ–æ™‚é€²å…¥ä¸‹ä¸€éšæ®µ

2. **ç›£æ§é‡å®šå‘**
   - æ’éšŠå®Œæˆæ™‚é é¢é€šå¸¸æœƒé‡å®šå‘
   - ç›£æ§ URL è®ŠåŒ–

3. **ç›£æ§è¨ªå•å…ƒç´ å‡ºç¾**
   - æ’éšŠå®Œæˆå¾Œæœƒå‡ºç¾è¨ªå•é é¢æˆ–è³¼ç¥¨ä»‹é¢

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3300-3400

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def wait_for_queue_completion(page, timeout: int = 3600000):
    """ç­‰å¾…æ’éšŠå®Œæˆ"""
    start_time = time.time()
    check_interval = 5000  # æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡

    while time.time() - start_time < timeout / 1000:
        try:
            # æª¢æŸ¥æ˜¯å¦ä»åœ¨æ’éšŠé é¢
            if 'queue' not in page.url and 'waiting' not in page.url:
                print("[QUEUE] å·²é›¢é–‹æ’éšŠé é¢ï¼Œæ’éšŠå®Œæˆ")
                return True

            # æª¢æŸ¥æ˜¯å¦å‡ºç¾ã€Œé€²å…¥ã€æˆ–ã€Œè¨ªå•ã€æŒ‰éˆ•
            enter_button = await page.query_selector(
                'button:has-text("é€²å…¥"), button:has-text("è¨ªå•")'
            )
            if enter_button:
                await enter_button.click()
                print("[QUEUE] å·²é»æ“Šé€²å…¥æŒ‰éˆ•")
                return True

            # ç­‰å¾…å¾Œå†æª¢æŸ¥
            await asyncio.sleep(check_interval / 1000)

        except Exception as e:
            print(f"[WARNING] æ’éšŠç›£æ§å‡ºç¾éŒ¯èª¤: {e}")

    print("[TIMEOUT] æ’éšŠè¶…æ™‚")
    return False
```

### 2. è‡ªå‹•é€²å…¥æ’éšŠ

#### 2.1 æ’éšŠé©—è­‰ç¢¼ï¼ˆå¦‚æœ‰ï¼‰
æŸäº›å¹³å°å¯èƒ½åœ¨æ’éšŠé é¢é¡¯ç¤ºé©—è­‰ç¢¼ã€‚

**è™•ç†æ–¹æ³•**ï¼š
- ä½¿ç”¨ OCR è­˜åˆ¥é©—è­‰ç¢¼ï¼ˆåƒè€ƒ Stage 7ï¼‰
- è¼¸å…¥é©—è­‰ç¢¼ä¸¦é»æ“Šç¢ºèª
- é€²å…¥æ’éšŠæµç¨‹

### 3. æ”¯ä»˜æµç¨‹

#### 3.1 æ”¯ä»˜é é¢æª¢æ¸¬
æª¢æ¸¬æ˜¯å¦é€²å…¥æ”¯ä»˜é é¢ã€‚

**æ”¯ä»˜é é¢æŒ‡æ¨™**ï¼š
1. **URL è®ŠåŒ–**
   - åŒ…å« `payment`ã€`checkout`ã€`pay` ç­‰é—œéµå­—

2. **é é¢å…§å®¹**
   - é¡¯ç¤ºè¨‚å–®æ‘˜è¦
   - é¡¯ç¤ºæ‡‰ä»˜é‡‘é¡
   - æ”¯ä»˜æ–¹å¼é¸æ“‡

3. **æ”¯ä»˜è¡¨å–®**
   - ä¿¡ç”¨å¡ä¿¡æ¯æ¬„ä½
   - æ”¯ä»˜å¯¶/å¾®ä¿¡æ”¯ä»˜é¸é …
   - éŠ€è¡Œè½‰å¸³é¸é …

#### 3.2 æ”¯ä»˜æ–¹å¼é¸æ“‡
ç³»çµ±é¸æ“‡é…ç½®ä¸­æŒ‡å®šçš„æ”¯ä»˜æ–¹å¼ã€‚

**æ”¯æ´çš„æ”¯ä»˜æ–¹å¼**ï¼š
1. **ä¿¡ç”¨å¡** (Credit Card)
   - é€šå¸¸éœ€è¦å¡è™Ÿã€æœ‰æ•ˆæœŸã€CVV

2. **é›»å­éŒ¢åŒ…**
   - æ”¯ä»˜å¯¶ã€å¾®ä¿¡æ”¯ä»˜ã€Apple Pay ç­‰
   - é€šå¸¸éœ€è¦é‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹æœå‹™

3. **éŠ€è¡Œè½‰å¸³**
   - é¡¯ç¤ºéŠ€è¡Œä¿¡æ¯ä¾›ç”¨æˆ¶æ“ä½œ

4. **å…¶ä»–**
   - ç™¼ç¥¨è²¼ç¾ã€ç¦®å“å¡ç­‰

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3400-3500

**ä»£ç¢¼ç¯„ä¾‹**ï¼š
```python
async def select_payment_method(page, payment_method: str):
    """é¸æ“‡æ”¯ä»˜æ–¹å¼"""
    payment_selectors = {
        'credit_card': 'input[value="credit_card"], label:has-text("ä¿¡ç”¨å¡")',
        'alipay': 'input[value="alipay"], label:has-text("æ”¯ä»˜å¯¶")',
        'wechat': 'input[value="wechat"], label:has-text("å¾®ä¿¡æ”¯ä»˜")',
    }

    selector = payment_selectors.get(payment_method)
    if not selector:
        print(f"[WARNING] ä¸æ”¯æ´çš„æ”¯ä»˜æ–¹å¼: {payment_method}")
        return False

    try:
        element = await page.query_selector(selector)
        if element:
            await element.click()
            print(f"[PAYMENT] å·²é¸æ“‡æ”¯ä»˜æ–¹å¼: {payment_method}")
            return True
    except Exception as e:
        print(f"[ERROR] é¸æ“‡æ”¯ä»˜æ–¹å¼å¤±æ•—: {e}")

    return False
```

#### 3.3 ä¿¡ç”¨å¡å¡«å¯«
å¦‚æœé¸æ“‡ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œå¡«å¯«å¡ä¿¡æ¯ã€‚

**æ³¨æ„**ï¼š
- âš ï¸ ä¸å»ºè­°å°‡ä¿¡ç”¨å¡ä¿¡æ¯ä¿å­˜åœ¨ `settings.json` ä¸­
- æ‡‰ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼ˆåŠ å¯†ã€ç’°å¢ƒè®Šæ•¸ç­‰ï¼‰
- æŸäº›æ¸¬è©¦ç’°å¢ƒå¯èƒ½ç¦æ­¢è‡ªå‹•å¡«å¯«ä¿¡ç”¨å¡

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3500-3550

#### 3.4 ç¬¬ä¸‰æ–¹æ”¯ä»˜é‡å®šå‘
æŸäº›æ”¯ä»˜æ–¹å¼æœƒé‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹æœå‹™ï¼ˆæ”¯ä»˜å¯¶ã€PayPal ç­‰ï¼‰ã€‚

**ç‰¹é»**ï¼š
- æœƒæ‰“é–‹æ–°çš„æ”¯ä»˜é é¢æˆ–æ¨¡æ…‹çª—å£
- éœ€è¦ç­‰å¾…é‡å®šå‘å®Œæˆ
- å¯èƒ½éœ€è¦è™•ç†é¡å¤–çš„èªè­‰

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3550-3600

### 4. æ”¯ä»˜å®Œæˆé©—è­‰

#### 4.1 æ”¯ä»˜æˆåŠŸé é¢
é©—è­‰æ”¯ä»˜æ˜¯å¦æˆåŠŸã€‚

**æˆåŠŸæŒ‡æ¨™**ï¼š
1. **URL è®ŠåŒ–**
   - é€²å…¥ç¢ºèªæˆ–æ„Ÿè¬é é¢
   - URL åŒ…å« `success`ã€`complete` ç­‰

2. **é é¢è¨Šæ¯**
   - ã€Œæ”¯ä»˜æˆåŠŸã€ã€ã€Œè³¼ç¥¨æˆåŠŸã€è¨Šæ¯
   - é¡¯ç¤ºè¨‚å–®è™Ÿå’Œç¥¨åˆ¸ä¿¡æ¯

3. **é é¢å…ƒç´ **
   - å‡ºç¾ã€Œä¸‹è¼‰ç¥¨åˆ¸ã€æŒ‰éˆ•
   - å‡ºç¾ã€ŒæŸ¥çœ‹è¨‚å–®ã€é€£çµ

**å¯¦ä½œä½ç½®**ï¼š
- `src/nodriver_tixcraft.py`: è¡Œ 3600-3650

#### 4.2 ç¥¨åˆ¸ç¢ºèª
ç¢ºèªæ˜¯å¦æ”¶åˆ°é›»å­ç¥¨åˆ¸ã€‚

**ç¢ºèªæ–¹æ³•**ï¼š
1. æª¢æŸ¥é é¢æ˜¯å¦é¡¯ç¤ºç¥¨åˆ¸ä¿¡æ¯
2. æª¢æŸ¥é›»å­éƒµä»¶æ˜¯å¦æ”¶åˆ°ç¥¨åˆ¸
3. æª¢æŸ¥å¸³è™Ÿçš„ã€Œæˆ‘çš„è¨‚å–®ã€ä¸­æ˜¯å¦å‡ºç¾æ–°è¨‚å–®

---

## å¹³å°ç‰¹å®šè€ƒé‡

### TixCraft
- æŸäº›æ´»å‹•æœ‰æ’éšŠæ©Ÿåˆ¶
- æ”¯ä»˜é€šå¸¸ä½¿ç”¨ç¬¬ä¸‰æ–¹æœå‹™ï¼ˆå¦‚ç¶ ç•Œï¼‰

### KKTIX
- å¯èƒ½æ²’æœ‰æ’éšŠï¼Œç›´æ¥é€²å…¥æ”¯ä»˜
- æ”¯ä»˜æ–¹å¼è¼ƒå¤š

### iBon
- æ’éšŠæ©Ÿåˆ¶è¼ƒç°¡å–®
- æ”¯ä»˜é€šå¸¸ç«‹å³é€²è¡Œ

### TicketPlus
- å¯èƒ½æœ‰è¤‡é›œçš„æ’éšŠå’Œæ”¯ä»˜æµç¨‹
- éœ€è¦è©³ç´°æ¸¬è©¦

---

## æˆåŠŸæ¨™æº–

**SC-011: æ’éšŠèˆ‡æ”¯ä»˜æˆåŠŸç‡** â‰¥ 90%
- ç³»çµ±æˆåŠŸå®Œæˆæ’éšŠå’Œæ”¯ä»˜çš„æ¬¡æ•¸ / ç¸½å˜—è©¦æ¬¡æ•¸

---

## ç›¸é—œåŠŸèƒ½éœ€æ±‚

| FR ç·¨è™Ÿ | åŠŸèƒ½åç¨± | ç‹€æ…‹ |
|---------|---------|------|
| FR-045 | æ’éšŠè™•ç† | ğŸ”„ éƒ¨åˆ†å¯¦ä½œ |
| FR-046 | æ”¯ä»˜æµç¨‹ | ğŸ”„ éƒ¨åˆ†å¯¦ä½œ |

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1: æ’éšŠè¶…æ™‚
**ç—‡ç‹€**ï¼šé•·æ™‚é–“ç­‰å¾…æ’éšŠä½†ç„¡é€²å±•

**å¯èƒ½åŸå› **ï¼š
- æ’éšŠäººæ•¸æ¥µå¤š
- å¹³å°ä¼ºæœå™¨å•é¡Œ
- æ´»å‹•å·²çµæŸ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥å¹³å°å…¬å‘Š
2. æ‰‹å‹•é€²å…¥å¹³å°ç¢ºèªæ´»å‹•ç‹€æ…‹
3. å¢åŠ è¶…æ™‚æ™‚é–“

### å•é¡Œ 2: æ”¯ä»˜å¤±æ•—
**ç—‡ç‹€**ï¼šæ”¯ä»˜ä¸è¢«æ¥å—

**å¯èƒ½åŸå› **ï¼š
- æ”¯ä»˜æ–¹å¼ä¸æ”¯æ´
- å¸³æˆ¶é¤˜é¡ä¸è¶³
- åœ°å€é™åˆ¶

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. é©—è­‰æ”¯ä»˜æ–¹å¼æ˜¯å¦æ­£ç¢º
2. æª¢æŸ¥å¸³æˆ¶
3. å˜—è©¦å…¶ä»–æ”¯ä»˜æ–¹å¼

---

## æœ€ä½³å¯¦è¸

### âœ… æ¨è–¦åšæ³•

1. **å®‰å…¨è™•ç†æ”¯ä»˜ä¿¡æ¯**
   - çµ•ä¸åœ¨ä»£ç¢¼ä¸­ç¡¬ç·¨ç¢¼æ”¯ä»˜ä¿¡æ¯
   - ä½¿ç”¨åŠ å¯†æˆ–ç’°å¢ƒè®Šæ•¸

2. **å¯¦ç¾å¤šç¨®æ”¯ä»˜æ–¹å¼æ”¯æŒ**
   - å¢åŠ æˆåŠŸç‡
   - æä¾›ç”¨æˆ¶é¸æ“‡

3. **è¨˜éŒ„æ”¯ä»˜ç‹€æ…‹**
   - ä¾¿æ–¼è¿½è¹¤å’Œé™¤éŒ¯

### âŒ é¿å…åšæ³•

1. âŒ åœ¨ Git ä¸­æäº¤ä¿¡ç”¨å¡ä¿¡æ¯
2. âŒ è‡ªå‹•å¡«å¯«æ‰€æœ‰æ”¯ä»˜ä¿¡æ¯
3. âŒ å¿½ç•¥æ”¯ä»˜éŒ¯èª¤è¨Šæ¯

---

## é–‹ç™¼æª¢æŸ¥æ¸…å–®

- [ ] æ’éšŠç‹€æ…‹æª¢æ¸¬æ­£ç¢º
- [ ] æ’éšŠç­‰å¾…é‚è¼¯æ­£ç¢º
- [ ] æ”¯ä»˜é é¢æª¢æ¸¬æº–ç¢º
- [ ] æ”¯ä»˜æ–¹å¼é¸æ“‡æˆåŠŸ
- [ ] æ”¯ä»˜å®Œæˆé©—è­‰æ­£ç¢º
- [ ] æ‰€æœ‰å¹³å°æ¸¬è©¦é€šé

---

## æ›´æ–°æ—¥æœŸ

- **2025-11**: åˆå§‹æ–‡ä»¶å»ºç«‹
- **ç›¸é—œè¦æ ¼**: `specs/001-ticket-automation-system/spec.md`
- **é©—è­‰ç‹€æ…‹**: ğŸ”„ Phase 3 é€²è¡Œä¸­

