**文件說明**：ibon P0 修復任務的規格一致性分析報告，涵蓋任務清單、優先度規劃與實作指導。

**最後更新**：2025-11-12

---

# 規格一致性分析報告：ibon P0 修復任務清單

**分析日期**：2025-10-18
**分析工具**：/speckit.analyze
**相關產物**：
- `specs/001-ticket-automation-system/spec.md` (規格)
- `specs/001-ticket-automation-system/plan.md` (計劃)
- `specs/001-ticket-automation-system/tasks-p0-ibon-fix.md` (任務清單)
- `.specify/memory/constitution.md` (憲法)

**分析目標**：驗證 P0 修復任務清單與規格、計劃的一致性，確保無遺漏、重複或模糊性。

---

## 執行摘要

✅ **分析結果**：**通過** - 整體一致性良好

| 指標 | 數值 |
|------|------|
| **總需求數** (相關) | 4 項 (FR-027, FR-028, FR-030, FR-060) |
| **總任務數** | 34 項 |
| **任務涵蓋率** | 100% (4/4 需求有任務) |
| **發現關鍵問題** | 0 項 |
| **發現高優先問題** | 2 項 |
| **發現中優先問題** | 0 項 |
| **發現低優先問題** | 3 項 |
| **憲法合規** | ✅ 全部通過 |

---

## 一、需求與任務涵蓋範圍

### A. 功能需求對應表

| 需求 ID | 需求內容 | 驗收標準 | 對應任務 | 涵蓋狀態 |
|---------|---------|---------|---------|---------|
| **FR-027** | 偵測票券數量輸入類型 | 系統能識別下拉選單/文字框/加減按鈕 | T009, T010, T011 | ✅ 完整 |
| **FR-028** | 票券數量設為配置值 | `ticket_number` 與結帳頁相符 | T006, T007, T019, T020 | ✅ 完整 |
| **FR-030** | 驗證票券數量設定正確 | 設定後立即讀回驗證 | T006, T007, T008 | ✅ 完整 |
| **FR-060** | 重試策略（指數退避） | 失敗時自動重試最多 N 次 | T012, T013, T014, T015, T016, T021 | ✅ 完整 |

### B. 成功標準對應表

| 標準 ID | 標準內容 | 目標 | 對應任務 | 驗證方式 |
|---------|---------|------|---------|---------|
| **SC-006** | 票券數量設定 90% 成功率 | ≥ 90% | T019, T020, T022 | 基準測試 + 驗證邏輯測試 |

---

## 二、發現的問題

### 🔴 **關鍵問題** (0 項)

無關鍵問題。所有核心需求均有完整的任務涵蓋。

---

### 🟡 **高優先問題** (2 項)

#### **H1: 缺少 FR-029 的處理（優先級降級邏輯）**

| 項目 | 詳情 |
|------|------|
| **位置** | spec.md:184 vs tasks-p0-ibon-fix.md |
| **問題** | FR-029 (「系統必須處理請求數量超過可用票券的情況」) 未在任務中提及 |
| **現狀** | tasks.md 中的備選邏輯僅支援 「無可用選項時返回 1」，未測試「可用數量 < 請求數量」情景 |
| **風險** | 若 config_dict["ticket_number"] = 3，但只有 2 張可用，系統會失敗（無降級邏輯） |
| **嚴重性** | **高**：違反規格中的 FR-029 原則 |
| **建議** | 在 T009-T011 階段新增容量檢查邏輯，實現降級選擇（選擇最大可用數量） |

**補救計劃**：
```
新增任務 T009.5:
- [ ] T009.5 在 nodriver_ibon_ticket_number_auto_select 中新增容量驗證
  - 讀取 SELECT 元素的所有可用 option
  - 若 configured_quantity > max_available，選擇 max_available
  - 記錄警告日誌：`[TICKET CAPACITY] Requested 3 but only 2 available, selecting 2`
  - 驗證標準：T020 測試中驗證此情景
```

---

#### **H2: 第一次失敗後無加速重試機制**

| 項目 | 詳情 |
|------|------|
| **位置** | spec.md:227 (FR-060 "指數退避策略") vs tasks.md Phase 4 |
| **問題** | FR-060 明確要求「指數退避策略」，但 T012-T016 使用固定延遲 (500ms) |
| **現狀** | 程式碼：`await asyncio_sleep_with_pause_check(config_dict, 0.5)` (固定 500ms) |
| **差異** | 指數退避應為：500ms → 1000ms → 2000ms；而非 500ms → 500ms → 500ms |
| **嚴重性** | **高**：違反規格中的指數退避要求（效能和反機器人策略） |
| **建議** | 修改 T012-T016 的重試邏輯，實現真實的指數退避 |

**補救計劃**：
```
修改 T012 描述為：
- [ ] T012 在 `src/nodriver_tixcraft.py:11189` 實裝指數退避重試邏輯
  - 改為 3 次重試迴圈，延遲序列：0.5s → 1.0s → 2.0s
  - 計算公式：delay = 0.5 * (2 ^ attempt)
  - 每次失敗時記錄：`[TICKET RETRY] Attempt N/3, waiting Xs (exponential backoff)`

同步更新 T013, T014, T015
```

---

### 🟢 **中優先問題** (0 項)

無中優先問題。

---

### 🔵 **低優先問題** (3 項)

#### **L1: Phase 1 任務描述需要補充**

| 項目 | 詳情 |
|------|------|
| **位置** | tasks.md Phase 1 |
| **問題** | T001-T005 描述過於簡潔，執行時可能需要指導 |
| **範例** | T001: "讀取核心函數...理解邏輯" - 缺少「檢查哪些地方」 |
| **建議** | 補充具體檢查清單（非強制，屬改進建議） |
| **嚴重性** | **低**：不影響執行，僅影響執行效率 |

---

#### **L2: 測試任務中缺少"失敗情景"測試**

| 項目 | 詳情 |
|------|------|
| **位置** | tasks.md Phase 5 (T019-T022) |
| **問題** | 測試僅涵蓋成功情景，無測試失敗恢復 |
| **範例** | T019: "執行基準測試" - 所有設定都預期成功 |
| **缺失情景** | - SELECT 元素查詢超時 - 驗證失敗情景 - 重試耗盡後的處理 |
| **建議** | 在 Phase 5 新增失敗情景測試 (可選) |
| **嚴重性** | **低**：基準測試已涵蓋快樂路徑，失敗情景可後續補充 |

---

#### **L3: 文件更新任務缺少"API 文件"**

| 項目 | 詳情 |
|------|------|
| **位置** | tasks.md Phase 6 (T026-T030) |
| **問題** | 無任務更新函數簽名或 API 文件 |
| **缺失項** | - 函數簽名文件 (如 `docs/06-api-reference/`) - 函數參數變更記錄 |
| **建議** | 在 T026-T030 新增 API 文件更新任務 (可選) |
| **嚴重性** | **低**：不影響功能交付，屬文件完整性改進 |

---

## 三、憲法合規性檢查

### A. 核心原則對應

| 原則 | 要求 | 任務涵蓋 | 狀態 |
|------|------|---------|------|
| **I. NoDriver First** | 優先 NoDriver 實作 | T006-T016 全部使用 NoDriver 版本 | ✅ **通過** |
| **II. 資料結構優先** | 配置驅動 (config_dict) | T006 讀取 `config_dict["ticket_number"]` | ✅ **通過** |
| **III. 三問法則** | 核心問題？簡單方法？相容性？ | 修復涉及 FR-028/030，無破壞現有功能 | ✅ **通過** |
| **IV. 單一職責** | 函數行數 <50，巢狀 <3 層 | T009-T011 均為小型函數 | ✅ **通過** |
| **V. 設定驅動** | settings.json 控制行為 | T006-T007 讀取並驗證 `ticket_number` | ✅ **通過** |
| **VI. 測試驅動** | NoDriver 平台必須實測 | T017-T022 包含完整測試驗證 | ✅ **通過** |
| **VII. MVP 原則** | 核心流程優先 | P0 修復聚焦 FR-028（票券數量設定） | ✅ **通過** |
| **VIII. 文件同步** | 文件與代碼同步 | T026-T030 包含文件更新 | ✅ **通過** |
| **IX. Git 規範** | 提交訊息規範 | T030 包含 git commit 準備 | ✅ **通過** |

### B. NON-NEGOTIABLE 原則

| 原則 | 檢查項 | 狀態 |
|------|--------|------|
| **VII. MVP 原則** | 核心場景必須完整可用 | ✅ 票券數量設定完整流程涵蓋 |
| **IX. Git 規範** | 提交訊息規範、描述清晰 | ✅ T030 任務已規劃 |

✅ **結論**：所有憲法原則均通過，無衝突。

---

## 四、跨產物一致性檢查

### A. 術語一致性

| 術語 | spec.md | plan.md | tasks.md | 狀態 |
|------|---------|---------|----------|------|
| 票券數量 | `ticket_number` | `config_dict["ticket_number"]` | 同上 | ✅ 一致 |
| 驗證 | "驗證票券數量設定正確" | 無提及 | "設定驗證邏輯" | ⚠️ 術語略有差異但含義一致 |
| 重試 | "重試失敗的操作" (FR-060) | "重試機制" | "重試邏輯" | ✅ 一致 |
| 平台 | iBon NoDriver | NoDriver 版本 | NoDriver 版本 | ✅ 一致 |

### B. 檔案路徑一致性

| 路徑 | spec.md | plan.md | tasks.md | 狀態 |
|------|---------|---------|----------|------|
| 核心函數 | 無明確 | 無明確 | `src/nodriver_tixcraft.py:10587` | ✅ 明確 |
| 設定檔 | `settings.json` | `settings.json` | `settings.json` | ✅ 一致 |
| 日誌位置 | 無明確 | 無明確 | `.temp/manual_logs.txt` | ✅ 合理 |

### C. 設計決策對應

| 決策 | spec.md | plan.md | tasks.md | 追蹤 |
|------|---------|---------|----------|------|
| 配置驅動 | ✅ 核心原則 | ✅ 體現 | ✅ T006 體現 | 一致 |
| NoDriver 優先 | ✅ P1 平台 | ✅ 優先版本 | ✅ 所有任務 | 一致 |
| 三層回退 | ✅ 核心策略 | ✅ 記錄 | ⚠️ 無明確 | 缺失(見 H1) |

---

## 五、涵蓋範圍分析

### A. 需求到任務映射

```
FR-027 (偵測) → T009, T010, T011 ✅
FR-028 (設定) → T006, T007, T019, T020 ✅
FR-030 (驗證) → T006, T007, T008 ✅
FR-060 (重試) → T012-T016, T021 ✅
SC-006 (成功率) → T019, T020, T022 ✅
```

**結論**：所有核心需求均有任務對應。

### B. 任務到需求反向映射

| 任務組 | 對應需求 | 備註 |
|--------|---------|------|
| T001-T005 | 無直接需求 | 分析準備工作（必要） |
| T006-T008 | FR-028, FR-030 | ✅ 設定驗證邏輯 |
| T009-T011 | FR-027 | ✅ DOM 穩定性（需求後退） |
| T012-T016 | FR-060 | ✅ 重試機制 |
| T017-T022 | SC-006 | ✅ 成功率驗證 |
| T023-T030 | 無直接需求 | 代碼審查 & 文件（必要） |
| T031-T034 | 無直接需求 | 交付流程（必要） |

**結論**：所有任務均有正當理由，無孤立任務。

---

## 六、模糊性偵測

### A. 模糊形容詞檢查

| 形容詞 | 位置 | 可測量性 | 狀態 |
|--------|------|---------|------|
| "穩定" | tasks.md Phase 5 | ❌ 模糊 | ⚠️ 應改為「95% 查詢成功率」 |
| "完整" | tasks.md Phase 1 | ⚠️ 部分 | ⚠️ 已定義為「列出 4 個呼叫位置」 |
| "快速" | 無出現 | - | ✅ 良好 |

### B. 未解決的佔位符

| 佔位符 | 位置 | 狀態 |
|--------|------|------|
| `<placeholder>` | 無 | ✅ 無 |
| TODO | 無 | ✅ 無 |
| TKTK | 無 | ✅ 無 |
| ??? | 無 | ✅ 無 |

**結論**：無嚴重模糊性。

---

## 七、重複偵測

### A. 相似需求檢查

| 需求 A | 需求 B | 相似度 | 狀態 |
|--------|--------|--------|------|
| FR-028 (設定) | FR-030 (驗證) | 50% | ⚠️ 互補關係，非重複 |
| FR-027 (偵測) | FR-060 (重試中的偵測) | 10% | ✅ 不同層級，無重複 |

### B. 重複任務檢查

| 任務 A | 任務 B | 相似度 | 狀態 |
|--------|--------|--------|------|
| T019 (基準) | T020 (驗證) | 40% | ✅ 不同測試場景 |
| T013 (重試) | T014 (重試) | 95% | ✅ 同邏輯不同位置（必要） |

**結論**：無有害重複。

---

## 八、不一致偵測

### A. 術語漂移

| 術語 | 使用方式 | 影響 |
|------|---------|------|
| "驗證" | spec: 動詞 / tasks: 名詞 | 無影響（含義一致） |
| "重試" | spec: 指數退避 / tasks: 固定延遲 | **有影響**（見 H2） |

### B. 設計衝突

| 衝突 | spec 要求 | tasks 實作 | 狀態 |
|------|----------|----------|------|
| 重試策略 | "指數退避" | "固定 500ms" | ❌ 衝突（高優先 H2） |
| 容量檢查 | "選擇最大可用" | 無明確實作 | ❌ 缺失（高優先 H1） |

---

## 九、指標統計

| 指標 | 數值 | 備註 |
|------|------|------|
| **總需求數** | 4 | FR-027, FR-028, FR-030, FR-060 |
| **總任務數** | 34 | Phase 1-7 |
| **覆蓋需求** | 4/4 | 100% |
| **覆蓋成功標準** | 1/1 | 100% (SC-006) |
| **關鍵問題** | 0 | ✅ 無 |
| **高優先問題** | 2 | H1, H2 |
| **中優先問題** | 0 | ✅ 無 |
| **低優先問題** | 3 | L1, L2, L3 |
| **總問題** | 5 | 其中 2 項需修復 |
| **憲法衝突** | 0 | ✅ 全部通過 |

---

## 十、建議下一步

### 🟢 可以執行的狀態

✅ **目前狀態**：**可執行，但建議先解決 2 個高優先問題**

| 優先度 | 行動 | 時間 |
|--------|------|------|
| **立即** | 修復 H1 + H2（2 個高優先問題） | ~30 分鐘 |
| **執行前** | 完成上述修復 | - |
| **執行後** | 參考 L1-L3 進行改進（可選） | ~1 小時 |

### 補救計劃

#### **步驟 1：修復 H1（FR-029 容量檢查）**

```markdown
新增任務 T009.5 (在 T009 之後)：
- [ ] T009.5 在 nodriver_ibon_ticket_number_auto_select 增加容量驗證
  - 檢查所有 SELECT options 的最大值
  - 若 configured > max_available，降級選擇
  - 記錄警告訊息
```

**影響**：確保 FR-029 覆蓋，避免超量購票失敗

#### **步驟 2：修復 H2（FR-060 指數退避）**

```markdown
修改 T012 描述為：
- [ ] T012 實裝指數退避重試邏輯 (not 固定延遲)
  - 重試延遲：0.5s → 1.0s → 2.0s (2^n 增長)
  - 同步修改 T013, T014, T015
```

**影響**：符合 FR-060 規格要求，提高系統穩定性

---

## 十一、詳細建議

### 給使用者的建議

✅ **整體評估**：任務清單質量良好，結構清晰

**可以執行，但建議**：

1. **必須先解決**（執行前）：
   - 🟡 H1：新增 T009.5 處理超量情景（FR-029）
   - 🟡 H2：修改 T012-T015 使用指數退避（FR-060）

2. **可選改進**（執行中/後）：
   - 🔵 L1：補充 Phase 1 檢查清單
   - 🔵 L2：新增失敗情景測試
   - 🔵 L3：新增 API 文件更新任務

### 修改建議

**最小修改**（必須）：
```
新增 1 個任務（T009.5）
修改 4 個任務描述（T012-T015）
```

**完整改進**（可選）：
```
+ 新增 3 個任務（L1-L3 相關）
+ 補充 5 個任務的詳細檢查清單
```

---

## 十二、合規簽核

| 檢查項 | 結果 | 簽核 |
|--------|------|------|
| 規格完整覆蓋 | ✅ 4/4 需求 | **通過** |
| 成功標準可測 | ✅ SC-006 可測 | **通過** |
| 憲法遵守 | ✅ 9/9 原則 | **通過** |
| 任務格式規範 | ✅ 34/34 遵守 | **通過** |
| 無害重複 | ✅ 0 項衝突 | **通過** |
| 無關鍵缺口 | ⚠️ 2 項需修復 | **條件通過** |

**最終狀態**：🟡 **可執行，條件通過（需修復 2 項高優先問題）**

---

## 附錄 A：需求清單詳解

### A1. FR-027 需求詳解

**規格原文**：「系統必須偵測票券數量輸入類型（下拉選單、文字框、加減按鈕、價格清單）」

**任務涵蓋**：
- T009：等待 SELECT 元素
- T010：查詢最優選擇器
- T011：頁面狀態檢查

**驗證方式**：T019 基準測試確認選擇成功

---

### A2. FR-028 需求詳解

**規格原文**：「系統必須將票券數量設為 settings.json 配置的值」

**任務涵蓋**：
- T006：設定 SELECT 值
- T007：解析返回值
- T019：基準測試驗證
- T020：不同數量驗證

**驗證方式**：結帳頁面票券數量與 config 一致

---

### A3. FR-030 需求詳解

**規格原文**：「系統必須在繼續前驗證票券數量設定正確」

**任務涵蓋**：
- T006：設定後讀回驗證
- T007：驗證失敗處理
- T008：錯誤處理

**驗證方式**：日誌中顯示「Verified: true」或「Verification failed」

---

### A4. FR-060 需求詳解

**規格原文**：「系統必須使用指數退避策略重試失敗的操作」

**任務涵蓋**：
- T012-T015：實裝重試邏輯（**注意**：當前為固定延遲，需修復為指數退避）
- T016：日誌輸出
- T021：重試測試

**驗證方式**：日誌顯示延遲序列 0.5s → 1.0s → 2.0s（見 H2）

---

## 附錄 B：命令參考

### 執行修復的建議命令

```bash
# 1. 查看當前 tasks.md
cat specs/001-ticket-automation-system/tasks-p0-ibon-fix.md

# 2. 編輯 tasks.md 以新增 T009.5 和修改 T012-T015
# (使用文本編輯器或下列命令)

# 3. 驗證修改（重新執行分析）
# /speckit.analyze
```

### 手動修復步驟

如需我幫助編輯任務檔案以納入上述補救，您可以回答：

**「您希望我修復上述 2 個高優先問題嗎？」**

選項：
- [ ] 是，修復 H1 + H2
- [ ] 否，保留現狀
- [ ] 部分，只修復 H1 或只修復 H2

---

## 結論

✅ **任務清單品質評定**：**B+ 級**

- ✅ 結構清晰、格式規範
- ✅ 涵蓋所有核心需求
- ✅ 憲法原則均遵守
- ⚠️ 缺失 2 個重要實作細節（H1, H2）

**建議**：建議先修復 H1 + H2 後再執行任務清單。預計修復時間 30 分鐘。

---

**分析完成時間**：2025-10-18
**分析者**：/speckit.analyze
**報告版本**：1.0
