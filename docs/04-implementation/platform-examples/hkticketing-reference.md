**æ–‡ä»¶èªªæ˜**ï¼šHKTicketing (é¦™æ¸¯å¿«é”ç¥¨) å¹³å°çš„å®Œæ•´å¯¦ä½œåƒè€ƒï¼Œæ¶µè“‹é›™æ¶æ§‹æ”¯æ´ï¼ˆASP.NET + SPAï¼‰ã€æ’éšŠè™•ç†ã€æµé‡éè¼‰åµæ¸¬ç­‰æŠ€è¡“å¯¦ä½œæŒ‡å—ã€‚

**æœ€å¾Œæ›´æ–°**ï¼š2025-12-02

---

# å¹³å°å¯¦ä½œåƒè€ƒï¼šHKTicketing

## å¹³å°æ¦‚è¿°

**å¹³å°åç¨±**ï¼šHKTicketing (é¦™æ¸¯å¿«é”ç¥¨)
**ç¶²ç«™**ï¼š
- `hkticketing.com` - Type 01 å‚³çµ±æ¶æ§‹ï¼ˆASP.NETï¼‰
- `hkt.hkticketing.com` - Type 02 æ–°æ¶æ§‹ï¼ˆVue/React SPAï¼‰

**å¸‚å ´åœ°ä½**ï¼šé¦™æ¸¯ä¸»è¦ç¥¨å‹™å¹³å°
**ä¸»è¦æ¥­å‹™**ï¼šæ¼”å”±æœƒã€éŸ³æ¨‚æœƒã€æˆ²åŠ‡ã€é«”è‚²è³½äº‹
**å®Œæˆåº¦**ï¼š90% âœ…
**é›£åº¦ç´šåˆ¥**ï¼šâ­â­â­â­ (æ¥µé«˜)

---

## å¹³å°ç‰¹æ€§

### æ ¸å¿ƒç‰¹é»
âœ… **å„ªå‹¢**ï¼š
- å®Œæ•´æ”¯æ´å…©ç¨®æ¶æ§‹ï¼ˆType 01 + Type 02ï¼‰
- æ’éšŠé é¢è‡ªå‹•é‡å°å‘
- æµé‡éè¼‰è‡ªå‹•åˆ·æ–°
- è©³ç´°çš„è³¼ç¥¨æµç¨‹æ§åˆ¶

âš ï¸ **æŒ‘æˆ°**ï¼š
- é›™æ¶æ§‹ç¶­è­·è¤‡é›œåº¦é«˜
- Type 02 SPA ç‹€æ…‹ç®¡ç†
- å¤šç¨®æ’éšŠ/éŒ¯èª¤é é¢è™•ç†
- ç™»å…¥ç‹€æ…‹è·¨é é¢ç¶­è­·

### æ¶æ§‹èªªæ˜

#### Type 01: å‚³çµ± ASP.NET æ¶æ§‹
- **URL ç‰¹å¾µ**ï¼š`hkticketing.com/shows/show.aspx?`
- **é é¢çµæ§‹**ï¼šä¼ºæœå™¨ç«¯æ¸²æŸ“
- **ç™»å…¥æ–¹å¼**ï¼šè¡¨å–®ç™»å…¥

#### Type 02: æ–°ç‰ˆ SPA æ¶æ§‹
- **URL ç‰¹å¾µ**ï¼š`hkt.hkticketing.com/hant/#/`
- **é é¢çµæ§‹**ï¼šVue/React SPA
- **ç™»å…¥æ–¹å¼**ï¼šlocalStorage Token
- **ç‰¹æ®Šè™•ç†**ï¼šæµé‡éè¼‰åµæ¸¬

### ç‰¹æ®Šæ©Ÿåˆ¶

1. **æ’éšŠé é¢è™•ç†**
   - `queue.hkticketing.com` - æ’éšŠé é¢
   - è‡ªå‹•åµæ¸¬ä¸¦ç­‰å¾…
   - æ’éšŠçµæŸå¾Œè‡ªå‹•é‡å°å‘

2. **æµé‡éè¼‰åµæ¸¬**ï¼ˆType 02ï¼‰
   - è‡ªå‹•åµæ¸¬éè¼‰é é¢
   - è‡ªå‹•é»æ“Šåˆ·æ–°æŒ‰éˆ•
   - ç­‰å¾…å¾Œé‡æ–°å˜—è©¦

3. **éŒ¯èª¤é é¢è™•ç†**
   - `hotshow.html` - ç†±é–€æ´»å‹•éŒ¯èª¤é 
   - è‡ªå‹•é‡å°å‘å›ç›®æ¨™é é¢

4. **iframe éŒ¯èª¤è™•ç†**
   - åµæ¸¬ iframe å…§çš„éŒ¯èª¤è¨Šæ¯
   - è‡ªå‹•è·³å‡ºéŒ¯èª¤ç‹€æ…‹

---

## æ ¸å¿ƒå‡½æ•¸ç´¢å¼•

### Type 01 (å‚³çµ±æ¶æ§‹) å‡½æ•¸

| éšæ®µ | å‡½æ•¸åç¨± | è¡Œæ•¸ | èªªæ˜ |
|------|---------|------|------|
| Stage 2 | `nodriver_hkticketing_login()` | 21052 | å¸³è™Ÿç™»å…¥ |
| Stage 3 | `nodriver_hkticketing_accept_cookie()` | 21212 | Cookie æ¥å— |
| Stage 4 | `nodriver_hkticketing_date_auto_select()` | 21518 | æ—¥æœŸè‡ªå‹•é¸æ“‡ |
| Stage 4 | `nodriver_hkticketing_date_assign()` | 21305 | æ—¥æœŸæŒ‡å®š |
| Stage 4 | `nodriver_hkticketing_date_buy_button_press()` | 21225 | è³¼è²·æŒ‰éˆ•é»æ“Š |
| Stage 5 | `nodriver_hkticketing_area_auto_select()` | 21561 | å€åŸŸè‡ªå‹•é¸æ“‡ |
| Stage 6 | `nodriver_hkticketing_ticket_number_auto_select()` | 21812 | ç¥¨æ•¸è‡ªå‹•è¨­å®š |
| Stage 9 | `nodriver_hkticketing_ticket_delivery_option()` | 21876 | é…é€æ–¹å¼é¸æ“‡ |
| Stage 10 | `nodriver_hkticketing_next_button_press()` | 21920 | ä¸‹ä¸€æ­¥æŒ‰éˆ• |
| Stage 10 | `nodriver_hkticketing_go_to_payment()` | 21997 | å‰å¾€ä»˜æ¬¾ |
| Stage 11 | `nodriver_hkticketing_performance()` | 23309 | æ•´åˆè™•ç† |

### Type 02 (SPA æ¶æ§‹) å‡½æ•¸

| éšæ®µ | å‡½æ•¸åç¨± | è¡Œæ•¸ | èªªæ˜ |
|------|---------|------|------|
| Stage 2 | `nodriver_hkticketing_type02_login()` | 22266 | SPA ç™»å…¥ |
| Stage 2 | `nodriver_hkticketing_type02_check_login_status()` | 22205 | ç™»å…¥ç‹€æ…‹æª¢æŸ¥ |
| Stage 3 | `nodriver_hkticketing_type02_check_traffic_overload()` | 22142 | æµé‡éè¼‰åµæ¸¬ |
| Stage 3 | `nodriver_hkticketing_type02_clear_session()` | 22079 | æ¸…é™¤ Session |
| Stage 4 | `nodriver_hkticketing_type02_event_page()` | 22546 | æ´»å‹•é é¢è™•ç† |
| Stage 4 | `nodriver_hkticketing_type02_date_assign()` | 22578 | æ—¥æœŸæŒ‡å®š |
| Stage 5 | `nodriver_hkticketing_type02_area_auto_select()` | 22716 | å€åŸŸè‡ªå‹•é¸æ“‡ |
| Stage 6 | `nodriver_hkticketing_type02_ticket_number_select()` | 22863 | ç¥¨æ•¸é¸æ“‡ |
| Stage 8 | `nodriver_hkticketing_type02_performance()` | 22978 | æ•´åˆè™•ç† |
| Stage 10 | `nodriver_hkticketing_type02_next_button_press()` | 22937 | ä¸‹ä¸€æ­¥æŒ‰éˆ• |
| Stage 10 | `nodriver_hkticketing_type02_confirm_order()` | 23029 | ç¢ºèªè¨‚å–® |
| Util | `nodriver_hkticketing_type02_dismiss_modal()` | 22425 | é—œé–‰æ¨¡æ…‹å°è©±æ¡† |
| Util | `nodriver_hkticketing_type02_event_page_buy_button()` | 22480 | æ´»å‹•é è³¼è²·æŒ‰éˆ• |

### å…±ç”¨å‡½æ•¸

| éšæ®µ | å‡½æ•¸åç¨± | è¡Œæ•¸ | èªªæ˜ |
|------|---------|------|------|
| Main | `nodriver_hkticketing_main()` | 23524 | ä¸»æ§åˆ¶æµç¨‹ |
| Util | `nodriver_hkticketing_url_redirect()` | 23362 | URL é‡å°å‘è™•ç† |
| Util | `nodriver_hkticketing_content_refresh()` | 23423 | å…§å®¹åˆ·æ–°è™•ç† |
| Util | `nodriver_hkticketing_travel_iframe()` | 23472 | iframe éŒ¯èª¤è™•ç† |
| Util | `nodriver_hkticketing_escape_robot_detection()` | 23344 | æ©Ÿå™¨äººåµæ¸¬è¦é¿ |
| Util | `nodriver_hkticketing_hide_tickets_blocks()` | 22052 | éš±è—ç¥¨å€å¡Š |

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š`src/nodriver_tixcraft.py`

---

## URL è·¯ç”±è¡¨

### Type 01 (å‚³çµ±æ¶æ§‹)

| URL æ¨¡å¼ | é é¢é¡å‹ | è™•ç†å‡½æ•¸ |
|---------|---------|---------|
| `/Secure/ShowLogin.aspx` | ç™»å…¥é é¢ | `nodriver_hkticketing_login()` |
| `/Membership/Login.aspx` | ç™»å…¥é é¢ | `nodriver_hkticketing_login()` |
| `/shows/show.aspx?` | æ—¥æœŸé¸æ“‡ | `nodriver_hkticketing_date_auto_select()` |
| `/events/.../performances/` | å€åŸŸé¸æ“‡ | `nodriver_hkticketing_area_auto_select()` |

### Type 02 (SPA æ¶æ§‹)

| URL æ¨¡å¼ | é é¢é¡å‹ | è™•ç†å‡½æ•¸ |
|---------|---------|---------|
| `#/login` | ç™»å…¥é é¢ | `nodriver_hkticketing_type02_login()` |
| `#/allEvents/detail/{id}` | æ´»å‹•é é¢ | `nodriver_hkticketing_type02_event_page()` |
| `#/allEvents/detail/selectTicket?activityId=` | ç¥¨åˆ¸é¸æ“‡ | `nodriver_hkticketing_type02_performance()` |
| `#/confirmOrder` | ç¢ºèªè¨‚å–® | `nodriver_hkticketing_type02_confirm_order()` |
| `#/generateSeat/{id}` | çµå¸³é é¢ | æˆåŠŸåµæ¸¬ |

---

## ç‰¹æ®Šè¨­è¨ˆ 1: æµé‡éè¼‰åµæ¸¬ï¼ˆType 02ï¼‰

### æŒ‘æˆ°

Type 02 æ¶æ§‹åœ¨é«˜æµé‡æ™‚æœƒé¡¯ç¤ºéè¼‰é é¢ï¼Œéœ€è¦è‡ªå‹•åµæ¸¬ä¸¦åˆ·æ–°ã€‚

### è§£æ±ºæ–¹æ¡ˆ

```python
async def nodriver_hkticketing_type02_check_traffic_overload(tab, config_dict=None):
    """æª¢æŸ¥æµé‡éè¼‰é é¢"""

    result = await tab.evaluate('''
        (function() {
            // æª¢æŸ¥éè¼‰è¨Šæ¯
            const bodyText = document.body.textContent || '';
            const overloadKeywords = [
                'Traffic Overload',
                'æµé‡éå¤§',
                'Please try again',
                'è«‹ç¨å¾Œå†è©¦'
            ];

            const hasOverload = overloadKeywords.some(kw => bodyText.includes(kw));

            if (hasOverload) {
                // æŸ¥æ‰¾åˆ·æ–°æŒ‰éˆ•
                const refreshBtn = document.querySelector('button.refresh, .btn-refresh, button[onclick*="refresh"]');
                if (refreshBtn) {
                    refreshBtn.click();
                    return { overload: true, refreshed: true };
                }
                return { overload: true, refreshed: false };
            }

            return { overload: false };
        })();
    ''')

    return result.get('overload', False)
```

---

## ç‰¹æ®Šè¨­è¨ˆ 2: æ’éšŠé é¢è™•ç†

### æŒ‘æˆ°

HKTicketing æœ‰å¤šç¨®æ’éšŠ/ç­‰å¾…é é¢ï¼š
- `queue.hkticketing.com` - æ’éšŠç³»çµ±
- `hotshow.html` - ç†±é–€æ´»å‹•é é¢

### è§£æ±ºæ–¹æ¡ˆ

```python
# æ’éšŠé é¢ URL æ¸…å–®
QUEUE_URL_PATTERNS = [
    "Hi fans, you're in the queue to",
    'queue.hkticketing.com/hotshow.html',
]

# ç†±é–€æ’éšŠ URLï¼ˆhot0 åˆ° hot19ï¼‰
for i in range(20):
    QUEUE_URL_PATTERNS.append(f'queue.hkticketing.com/hot{i}.html')

async def nodriver_hkticketing_url_redirect(tab, url, config_dict):
    """è™•ç† URL é‡å°å‘ï¼ˆæ’éšŠé é¢ã€éŒ¯èª¤é é¢ï¼‰"""

    # æª¢æŸ¥æ˜¯å¦åœ¨æ’éšŠé é¢
    for pattern in QUEUE_URL_PATTERNS:
        if pattern in url.lower():
            print("[HKTICKETING] Queue page detected, waiting...")
            await asyncio.sleep(5)  # ç­‰å¾… 5 ç§’å¾Œé‡æ–°æª¢æŸ¥

            # å˜—è©¦é‡å°å‘å›ç›®æ¨™é é¢
            homepage = config_dict.get("homepage", "")
            if homepage:
                await tab.get(homepage)
                return True

    return False
```

---

## ç‰¹æ®Šè¨­è¨ˆ 3: Type 02 ç™»å…¥æµç¨‹

### æŒ‘æˆ°

Type 02 ä½¿ç”¨ localStorage å„²å­˜ç™»å…¥ç‹€æ…‹ï¼Œéœ€è¦ç‰¹æ®Šè™•ç†ã€‚

### è§£æ±ºæ–¹æ¡ˆ

```python
async def nodriver_hkticketing_type02_login(tab, config_dict):
    """Type 02 SPA ç™»å…¥æµç¨‹"""
    show_debug_message = config_dict["advanced"].get("verbose", False)

    print("[HKTICKETING TYPE02] Waiting for login to complete (max 180 seconds)...")

    timeout = 180
    start_time = time.time()

    while True:
        elapsed = time.time() - start_time
        if elapsed > timeout:
            print("[HKTICKETING TYPE02] Login timeout")
            return False

        # æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        login_status = await nodriver_hkticketing_type02_check_login_status(tab, config_dict)

        if login_status:
            print("[HKTICKETING TYPE02] Login successful")
            return True

        if elapsed % 30 == 0:
            print(f"[HKTICKETING TYPE02] Waiting for login... ({elapsed}s / {timeout}s)")

        await asyncio.sleep(2)
```

---

## ç‰¹æ®Šè¨­è¨ˆ 4: ç¢ºèªè¨‚å–®é é¢

### æµç¨‹

1. **é…é€æ–¹å¼é¸æ“‡**ï¼šé¸æ“‡å–ç¥¨æ–¹å¼
2. **åŒæ„æ¢æ¬¾**ï¼šå‹¾é¸åŒæ„è¤‡é¸æ¡†
3. **é»æ“Šæäº¤**ï¼šé»æ“Šæäº¤è¨‚å–®æŒ‰éˆ•

### æ ¸å¿ƒç¨‹å¼ç¢¼ç‰‡æ®µ

```python
async def nodriver_hkticketing_type02_confirm_order(tab, config_dict):
    """Type 02 ç¢ºèªè¨‚å–®é é¢è™•ç†"""

    # é…é€æ–¹å¼é¸æ“‡
    await tab.evaluate('''
        (function() {
            // é¸æ“‡ã€Œéƒµå¯„ã€æˆ–ã€Œè‡ªå–ã€
            const deliveryOptions = document.querySelectorAll('input[name="delivery"]');
            if (deliveryOptions.length > 0) {
                deliveryOptions[0].click();  // é¸æ“‡ç¬¬ä¸€å€‹é¸é …
            }
        })();
    ''')

    # å‹¾é¸åŒæ„æ¢æ¬¾
    await tab.evaluate('''
        (function() {
            const agreeCheckbox = document.querySelector('input[type="checkbox"].agree, #agreeTerms');
            if (agreeCheckbox && !agreeCheckbox.checked) {
                agreeCheckbox.click();
            }
        })();
    ''')

    # é»æ“Šæäº¤æŒ‰éˆ•
    submit_btn = await tab.query_selector('button.submit-btn, .btn-submit')
    if submit_btn:
        await submit_btn.click()
```

---

## é…ç½®ç¯„ä¾‹

```json
{
  "homepage": "https://hkt.hkticketing.com/hant/#/allEvents/detail/xxx",
  "webdriver_type": "nodriver",
  "date_auto_select": {
    "enable": true,
    "date_keyword": "12/25",
    "mode": "random"
  },
  "area_auto_select": {
    "enable": true,
    "area_keyword": "\"Aå€\",\"Bå€\"",
    "mode": "random"
  },
  "ticket_number": 2,
  "advanced": {
    "verbose": true,
    "hkticketing_account": "your_email@example.com",
    "hkticketing_password": "encrypted_password",
    "play_sound": {
      "ticket": true,
      "order": true
    }
  }
}
```

---

## å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### Q1: Type 02 ä¸€ç›´é¡¯ç¤ºæµé‡éè¼‰ï¼Ÿ

**A**: é€™æ˜¯æ­£å¸¸çš„é«˜æµé‡ä¿è­·æ©Ÿåˆ¶ã€‚

**è™•ç†æ–¹å¼**ï¼š
- ç¨‹å¼æœƒè‡ªå‹•åµæ¸¬ä¸¦åˆ·æ–°
- ç­‰å¾…ç³»çµ±æ¢å¾©å¾Œç¹¼çºŒ

### Q2: ç™»å…¥ç‹€æ…‹ç„¡æ³•ç¶­æŒï¼Ÿ

**A**: å¯èƒ½æ˜¯ Cookie æˆ– localStorage å•é¡Œã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªå¸³è™Ÿå¯†ç¢¼æ­£ç¢º
2. æ‰‹å‹•å®Œæˆä¸€æ¬¡ç™»å…¥å¾Œå†å•Ÿå‹•
3. æª¢æŸ¥æ˜¯å¦æœ‰é©—è­‰ç¢¼é˜»æ“‹

### Q3: å¦‚ä½•åˆ¤æ–·ä½¿ç”¨å“ªç¨®æ¶æ§‹ï¼Ÿ

**A**: æ ¹æ“š URL è‡ªå‹•åˆ¤æ–·ï¼š
- `hkticketing.com` â†’ Type 01
- `hkt.hkticketing.com` â†’ Type 02

---

## é¸æ“‡å™¨å¿«é€Ÿåƒè€ƒ

### Type 01 é¸æ“‡å™¨

| åŠŸèƒ½ | é¸æ“‡å™¨ | å‚™è¨» |
|------|--------|------|
| ç™»å…¥è¡¨å–® | `form#loginForm` | ç™»å…¥é é¢ |
| æ—¥æœŸé¸é … | `.show-date`, `.performance-date` | æ—¥æœŸé¸æ“‡ |
| å€åŸŸé¸é … | `.seat-area`, `.area-option` | å€åŸŸé¸æ“‡ |
| ç¥¨æ•¸è¼¸å…¥ | `select.ticket-qty` | ç¥¨æ•¸è¨­å®š |
| è³¼è²·æŒ‰éˆ• | `button.buy-btn`, `.btn-buy` | å„é é¢ |

### Type 02 é¸æ“‡å™¨

| åŠŸèƒ½ | é¸æ“‡å™¨ | å‚™è¨» |
|------|--------|------|
| ç™»å…¥è¼¸å…¥ | `input[type="email"]`, `input[type="password"]` | SPA ç™»å…¥ |
| æ´»å‹•æŒ‰éˆ• | `.event-buy-btn`, `.btn-ticket` | æ´»å‹•é é¢ |
| æ—¥æœŸé¸é … | `.date-item`, `.session-item` | ç¥¨åˆ¸é¸æ“‡ |
| å€åŸŸé¸é … | `.area-btn`, `.ticket-area` | ç¥¨åˆ¸é¸æ“‡ |
| ç¥¨æ•¸é¸æ“‡ | `select.qty-select`, `.v-select` | ç¥¨åˆ¸é¸æ“‡ |
| ä¸‹ä¸€æ­¥æŒ‰éˆ• | `.btn-next`, `button.primary` | å„é é¢ |
| æäº¤æŒ‰éˆ• | `.btn-submit`, `button[type="submit"]` | ç¢ºèªé é¢ |

---

## ç›¸é—œæ–‡ä»¶

- ğŸ“‹ [Stage 11: æ’éšŠè™•ç†æ©Ÿåˆ¶](../../03-mechanisms/11-queue-handling.md) - æ’éšŠåµæ¸¬è©³è§£
- ğŸ“‹ [Stage 4: æ—¥æœŸé¸æ“‡æ©Ÿåˆ¶](../../03-mechanisms/04-date-selection.md) - æ—¥æœŸé¸æ“‡é‚è¼¯
- ğŸ—ï¸ [ç¨‹å¼ç¢¼çµæ§‹åˆ†æ](../../02-development/structure.md) - HKTicketing å‡½æ•¸ç´¢å¼•
- ğŸ“– [12-Stage æ¨™æº–](../../02-development/ticket_automation_standard.md) - å®Œæ•´æµç¨‹è¦ç¯„

---

## ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è®Šæ›´å…§å®¹ |
|------|------|---------|
| v1.0 | 2024 | åˆç‰ˆï¼šType 01 åŸºæœ¬æ”¯æ´ |
| v1.1 | 2025-08 | Type 02 SPA æ”¯æ´ |
| v1.2 | 2025-10 | æ’éšŠé é¢è™•ç†å„ªåŒ– |
| **v1.3** | **2025-12** | **æµé‡éè¼‰åµæ¸¬ + å®Œæ•´æ–‡ä»¶** |

**v1.3 äº®é»**ï¼š
- âœ… å®Œæ•´çš„é›™æ¶æ§‹æ”¯æ´ï¼ˆType 01 + Type 02ï¼‰
- âœ… æµé‡éè¼‰è‡ªå‹•åµæ¸¬èˆ‡åˆ·æ–°
- âœ… å¤šç¨®æ’éšŠé é¢è™•ç†ï¼ˆhot0-hot19ï¼‰
- âœ… Type 02 localStorage ç™»å…¥
- âœ… ç¢ºèªè¨‚å–®é é¢å®Œæ•´è™•ç†
- âœ… æˆåŠŸåµæ¸¬ + éŸ³æ•ˆæ’­æ”¾
