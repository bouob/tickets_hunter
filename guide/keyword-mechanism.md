# 關鍵字與回退機制詳解

本文件詳細說明 Tickets Hunter 的**智慧選擇機制**：關鍵字匹配與自動回退策略。

---

## 📚 目錄

1. [核心概念](#核心概念)
2. [日期關鍵字機制](#日期關鍵字機制)
3. [區域關鍵字機制](#區域關鍵字機制)
4. [自動回退策略](#自動回退策略)
5. [實戰範例](#實戰範例)

---

## 核心概念

### 什麼是「關鍵字匹配」？

**關鍵字匹配**是程式自動選擇日期或區域的主要方式。您只需提供**部分文字**，程式會自動找到包含該文字的選項。

**舉例**：
- 網站顯示：「2024/11/16 (六) 19:30」
- 您的關鍵字：`"11/16"` 或 `"週六"` 或 `"19:30"`
- 結果：程式會自動選擇這個日期

---

### 什麼是「回退策略」？

**回退策略**是當關鍵字找不到時，程式會自動改用的備用方案。

**三層回退機制**：
```
第 1 層：嘗試關鍵字匹配
   ↓ 找不到
第 2 層：使用 mode 自動選擇（from top/bottom/center/random）
   ↓ 找不到
第 3 層：等待手動操作或重試
```

這確保即使關鍵字設定錯誤，程式仍能繼續執行。

---

## 日期關鍵字機制

### 完整流程圖

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 進入活動頁面                                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 查詢所有日期選項                                         │
│    例：2024/11/16 (六) 19:30                                │
│        2024/11/17 (日) 14:00                                │
│        2024/11/18 (一) 19:30                                │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 過濾不可選的日期                                         │
│    ✓ 排除「即將開賣」頁面                                   │
│    ✓ 排除「已售完」（如果設定 pass_date_is_sold_out=true） │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
             ┌────────────┴────────────┐
             │ 有設定 date_keyword？   │
             └────┬─────────────┬──────┘
                  │NO           │YES
                  │             │
                  │             ▼
                  │    ┌────────────────────────────────┐
                  │    │ 4. 關鍵字匹配                  │
                  │    │    date_keyword: "11/16","週六"│
                  │    └────────┬───────────────────────┘
                  │             │
                  │             ▼
                  │    ┌────────────────────────────────┐
                  │    │ 依序嘗試每組關鍵字             │
                  │    │ - "11/16" → 找到？             │
                  │    │ - "週六" → 找到？              │
                  │    └────┬───────────────────────────┘
                  │         │
                  │         ▼
                  │    ┌──────────┐
                  │    │ 找到了？ │
                  │    └────┬─────┘
                  │         │YES
                  │         │
                  ▼         ▼
         ┌────────────────────────────────────┐
         │ 5. 使用 mode 自動選擇              │
         │    - from top to bottom → 選第 1 個│
         │    - from bottom to top → 選最後   │
         │    - center → 選中間               │
         │    - random → 隨機選               │
         └────────────┬───────────────────────┘
                      │
                      ▼
         ┌────────────────────────────────────┐
         │ 6. 點擊選中的日期                  │
         │    → 成功進入下一頁面              │
         └────────────────────────────────────┘
```

---

### 設定範例

#### 範例 1：指定特定日期
**在圖形介面中設定**：
- 日期自動點選：啟用
- 日期關鍵字：11/16
- 日期排序方式：from top to bottom

**執行邏輯**：
1. 先找包含 11/16 的日期
2. 找到 → 選擇該日期
3. 找不到 → 選第一個可用日期

---

#### 範例 2：多組關鍵字（OR 邏輯）
**在圖形介面中設定**：
- 日期關鍵字：11/16;11/17;週六

**執行邏輯**：
1. 先找包含 11/16 的日期 → 找到就選
2. 找不到，再找 11/17 → 找到就選
3. 還是找不到，再找 週六 → 找到就選
4. 全部找不到 → 使用日期排序方式自動選

---

#### 範例 3：不指定關鍵字
**在圖形介面中設定**：
- 日期關鍵字：留空

**執行邏輯**：
- 直接使用日期排序方式自動選擇
- 例如 from top to bottom 會選第一個日期

---

### 進階技巧

#### 技巧 1：指定時間段
**日期關鍵字設定**：19:30;晚上

優先選擇晚上場次。

#### 技巧 2：指定星期
**日期關鍵字設定**：週六;週日

優先選擇週末場次。

#### 技巧 3：空格 AND 邏輯（單一關鍵字內）
**日期關鍵字設定**：週六 19:30

必須同時包含「週六」**和**「19:30」才匹配。

#### 技巧 4：多組 OR 邏輯
**日期關鍵字設定**：11/16 上午;11/16 下午

先找「11/16 上午」，找不到再找「11/16 下午」（依序嘗試）。

**注意**：逗號僅作為千位分隔符號（例如票價 "3,280" 中的逗號），不用於分隔多組關鍵字。

---

## 區域關鍵字機制

### 完整流程圖

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 進入選位頁面                                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 查詢所有區域選項                                         │
│    例：搖滾A區 $2280                                        │
│        搖滾B區 $1980                                        │
│        VIP區 $3880                                          │
│        輪椅區 $1280                                         │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 套用排除關鍵字（keyword_exclude）                        │
│    排除包含：「輪椅」「身障」「視線不良」等                 │
│    結果：                                                   │
│        搖滾A區 $2280                                        │
│        搖滾B區 $1980                                        │
│        VIP區 $3880                                          │
│        ~~輪椅區 $1280~~ (已排除)                            │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
             ┌────────────┴────────────┐
             │ 有設定 area_keyword？   │
             └────┬─────────────┬──────┘
                  │NO           │YES
                  │             │
                  │             ▼
                  │    ┌────────────────────────────────┐
                  │    │ 4. 關鍵字匹配                  │
                  │    │    area_keyword: "搖滾A","VIP" │
                  │    └────────┬───────────────────────┘
                  │             │
                  │             ▼
                  │    ┌────────────────────────────────┐
                  │    │ 依序嘗試每組關鍵字             │
                  │    │ - "搖滾A" → 找到？             │
                  │    │ - "VIP" → 找到？               │
                  │    └────┬───────────────────────────┘
                  │         │
                  │         ▼
                  │    ┌──────────┐
                  │    │ 找到了？ │
                  │    └────┬─────┘
                  │         │YES
                  │         │
                  ▼         ▼
         ┌────────────────────────────────────┐
         │ 5. 使用 mode 自動選擇              │
         │    - from top to bottom → 選第 1 個│
         │      (通常是最貴/最好的位置)       │
         │    - from bottom to top → 選最後   │
         │    - center → 選中間               │
         │    - random → 隨機選               │
         └────────────┬───────────────────────┘
                      │
                      ▼
         ┌────────────────────────────────────┐
         │ 6. 點擊選中的區域                  │
         │    → 成功進入下一頁面              │
         └────────────────────────────────────┘
```

---

### 設定範例

#### 範例 1：指定特定區域
**在圖形介面中設定**：
- 區域自動點選：啟用
- 區域關鍵字：搖滾A
- 區域排序方式：from top to bottom
- 排除關鍵字：輪椅;身障

**執行邏輯**：
1. 先排除包含「輪椅」「身障」的區域
2. 再找包含「搖滾A」的區域
3. 找到 → 選擇該區域
4. 找不到 → 選第一個可用區域（已排除輪椅區）

---

#### 範例 2：多組關鍵字（OR 邏輯）
**在圖形介面中設定**：
- 區域關鍵字：搖滾A;搖滾B;VIP

**執行邏輯**：
1. 先找「搖滾A」→ 找到就選
2. 找不到，再找「搖滾B」→ 找到就選
3. 還是找不到，再找「VIP」→ 找到就選
4. 全部找不到 → 使用區域排序方式自動選

---

#### 範例 3：用票價選擇
**在圖形介面中設定**：
- 區域關鍵字：3,280;2,680

**說明**：
- 優先選擇票價 3,280 的區域
- 找不到，再選 2,680
- 適合對價格有預算的情況
- **注意**：逗號是價格的一部分（千位分隔符號）

---

#### 範例 4：排除視線不良區
**在圖形介面中設定**：
- 排除關鍵字：輪椅;身障;身心;障礙;Restricted View;燈柱遮蔽;視線不完整

**重要性**：
- 避免誤選輪椅席（通常需特殊資格）
- 避免選到視線受阻的區域
- 強烈建議**一定要設定**

---

### 進階技巧

#### 技巧 1：精確匹配區域名稱
**區域關鍵字設定**：搖滾A區

加上「區」字，避免匹配到「搖滾A排」等其他選項。

#### 技巧 2：用位置關鍵字
**區域關鍵字設定**：前排;中央

優先選擇包含「前排」或「中央」的區域。

#### 技巧 3：空格 AND 邏輯（單一關鍵字內）
**區域關鍵字設定**：搖滾A 前排

必須同時包含「搖滾A」**和**「前排」才匹配。

#### 技巧 4：多組 OR 邏輯
**區域關鍵字設定**：搖滾A 3,280;搖滾B 2,680

先找「搖滾A 3,280」，找不到再找「搖滾B 2,680」（依序嘗試）。

**注意**：逗號是價格的一部分（千位分隔符號），分號才是分隔符。

---

## 自動回退策略

### 四種 Mode 說明

#### 1. from top to bottom（從上到下）
**在圖形介面中選擇**：日期排序方式 / 區域排序方式 → from top to bottom

**行為**：選擇**第一個**可用選項

**適用情境**：
- **日期**：選最早場次
- **區域**：選最貴/最好的位置（網站通常把貴的放前面）

**範例**：
```
可用選項：
  1. VIP區 $3880
  2. 搖滾A區 $2280
  3. 搖滾B區 $1980

→ 選擇：VIP區 $3880
```

---

#### 2. from bottom to top（從下到上）
**在圖形介面中選擇**：日期排序方式 / 區域排序方式 → from bottom to top

**行為**：選擇**最後一個**可用選項

**適用情境**：
- **日期**：選最晚場次
- **區域**：選最便宜/最後面的位置

**範例**：
```
可用選項：
  1. VIP區 $3880
  2. 搖滾A區 $2280
  3. 搖滾B區 $1980

→ 選擇：搖滾B區 $1980
```

---

#### 3. center（中間）
**在圖形介面中選擇**：日期排序方式 / 區域排序方式 → center

**行為**：選擇**中間**的選項

**適用情境**：
- 不想選太貴也不想選太便宜
- 平衡策略

**範例**：
```
可用選項：
  1. VIP區 $3880
  2. 搖滾A區 $2280
  3. 搖滾B區 $1980

→ 選擇：搖滾A區 $2280
```

---

#### 4. random（隨機）
**在圖形介面中選擇**：日期排序方式 / 區域排序方式 → random

**行為**：**隨機**選擇一個可用選項

**適用情境**：
- 增加不可預測性
- 分散風險
- 多人同時搶票時避免衝突

**範例**：
```
可用選項：
  1. VIP區 $3880
  2. 搖滾A區 $2280
  3. 搖滾B區 $1980

→ 選擇：（每次執行結果不同）
```

---

## 實戰範例

### 場景 1：指定週六晚上場，搖滾A區

**目標**：
- 日期：週六晚上
- 區域：搖滾A區
- 如果沒有，就選其他可用選項

**在圖形介面中設定**：
- 日期自動點選：啟用
- 日期關鍵字：週六 19:30;週六 晚上
- 日期排序方式：from top to bottom
- 區域自動點選：啟用
- 區域關鍵字：搖滾A;搖滾B
- 區域排序方式：from top to bottom
- 排除關鍵字：輪椅;身障;視線不良

**執行過程**：
1. **日期選擇**：
   - 先找「週六」且「19:30」的日期
   - 找不到，再找「週六」且「晚上」
   - 還是找不到，選第一個可用日期

2. **區域選擇**：
   - 先排除包含「輪椅」「身障」「視線不良」的區域
   - 再找「搖滾A」
   - 找不到，再找「搖滾B」
   - 還是找不到，選第一個可用區域

---

### 場景 2：不指定日期，只要最便宜的區域

**目標**：
- 日期：任意（選第一個）
- 區域：最便宜的

**在圖形介面中設定**：
- 日期自動點選：啟用
- 日期關鍵字：留空
- 日期排序方式：from top to bottom
- 區域自動點選：啟用
- 區域關鍵字：留空
- 區域排序方式：from bottom to top
- 排除關鍵字：輪椅;身障

**執行過程**：
1. **日期選擇**：選第一個可用日期
2. **區域選擇**：
   - 先排除包含「輪椅」「身障」的區域
   - 選最後一個可用區域（通常是最便宜）

---

### 場景 3：多組日期，隨機選區域

**目標**：
- 日期：11/16 或 11/17
- 區域：隨機選，增加變化性

**在圖形介面中設定**：
- 日期自動點選：啟用
- 日期關鍵字：11/16;11/17
- 日期排序方式：random
- 區域自動點選：啟用
- 區域關鍵字：留空
- 區域排序方式：random
- 排除關鍵字：輪椅;身障

**執行過程**：
1. **日期選擇**：
   - 先找「11/16」
   - 找不到，再找「11/17」
   - 還是找不到，隨機選一個日期

2. **區域選擇**：
   - 先排除包含「輪椅」「身障」的區域
   - 隨機選一個可用區域

---

## 💡 最佳實踐建議

### 建議 1：一定要設定排除關鍵字
**排除關鍵字設定**：輪椅;身障;身心;障礙;Restricted View;燈柱遮蔽;視線不完整

**原因**：避免誤選需要特殊資格或視線不良的區域。

---

### 建議 2：關鍵字由具體到模糊
**日期關鍵字設定**：11/16 19:30;11/16;週六

**原因**：
- 先嘗試最精確的匹配
- 逐步放寬條件
- 提高成功率

---

### 建議 3：使用多組關鍵字
**區域關鍵字設定**：搖滾A;搖滾B;VIP

**原因**：
- 第一選擇可能已售完
- 有備用選項提高成功率

---

### 建議 4：搭配 verbose 模式測試（僅當您知道您在做什麼時）
**在圖形介面的「進階設定」中**：
- 輸出詳細除錯訊息：打勾

**原因**：
- 可以看到關鍵字匹配過程
- 方便調整設定
- 確認邏輯正確

**警告**：輸出大量日誌可能影響效能，除非需要除錯，建議關閉。

---

### 建議 5：日期用 from top，區域看情況
**日期排序方式**：from top to bottom（選最早場次）

**區域排序方式**：
- from top to bottom（選最好位置）
- 或 from bottom to top（選最便宜）

---

## ❓ 常見問題

### Q1: 關鍵字要完全一樣嗎？
**A:** 不用！只要**包含**您的關鍵字即可。

**範例**：
- 網站顯示：「2024/11/16 (六) 19:30 場」
- 關鍵字：`"11/16"` ✅ 可匹配
- 關鍵字：`"週六"` ✅ 可匹配
- 關鍵字：`"19:30"` ✅ 可匹配

---

### Q2: 多組關鍵字是 AND 還是 OR？
**A:** 有三種邏輯：

**OR 邏輯**（分號分隔）：
- 日期關鍵字設定：11/16;11/17
- 找到 11/16 **或** 11/17 都可以

**空格 AND**（單一關鍵字內）：
- 日期關鍵字設定：週六 19:30
- 必須同時包含「週六」**且**「19:30」

**分號分隔**（多組關鍵字組合）：
- 日期關鍵字設定：11/16 上午;11/16 下午
- 分號表示「或」：先嘗試第一組（11/16 上午），如果失敗則嘗試第二組（11/16 下午）
- 每組內部用空格表示「且」：11/16 **且** 上午

---

### Q3: 如果關鍵字打錯了會怎樣？
**A:** 程式會自動**回退到日期/區域排序方式**，不會失敗。

**範例**：
- 日期關鍵字：11/99（不存在的日期）
- 日期排序方式：from top to bottom
- 結果：找不到 11/99，會自動選第一個可用日期

---

### Q4: keyword_exclude 可以用在日期嗎？
**A:** 目前排除關鍵字只適用於**區域選擇**。

如果想排除某些日期，建議：
- 使用更精確的日期關鍵字
- 或手動選擇

---

### Q5: 可以看到匹配過程嗎？
**A:** 可以！在圖形介面的「進階設定」中啟用「輸出詳細除錯訊息」。

**警告**：僅當您需要除錯時使用，輸出大量日誌可能影響效能。

您會看到類似輸出：
```
[DATE KEYWORD] Trying keyword: "11/16"
[DATE KEYWORD] Match found! Total: 1
[DATE SELECT] Selected: 2024/11/16 (六) 19:30

[AREA KEYWORD] Trying keyword: "搖滾A"
[AREA KEYWORD] Match found! Total: 1
[AREA SELECT] Selected: 搖滾A區 $2280
```

---

### Q6: KKTIX 票券顯示「尚未開賣」會怎樣？
**A:** 系統會智能處理「尚未開賣」的票券，並持續監控直到開賣。

**行為說明**：
1. **關鍵字匹配**：即使票券顯示「尚未開賣」，系統仍會進行關鍵字匹配
2. **追蹤待開賣票券**：匹配成功的「尚未開賣」票券會被追蹤並顯示在日誌中
3. **自動刷新**：系統會自動刷新頁面，直到票券開始販售

**Verbose 模式輸出範例**：
```
[KKTIX AREA] Match Summary:
  Tickets matched (with input): 0
  Tickets matched (waiting for open): 1

  Waiting for these tickets to open:
    - 全票(2F) TWD$3,800 (keywords: 2F, 3,800)
```

**為什麼需要這個功能**：
- 避免您誤以為關鍵字設定錯誤
- 清楚顯示系統正在等待哪些票券開賣
- 一旦票券開賣，系統會立即執行購買

**支援語言**：繁體中文（尚未開賣）、英文（Not Started）、日文（まだ発売）

---

## 📚 延伸閱讀

- [快速入門指南](quick-start.md) - 第一次使用設定
- [詳細設定說明](settings-guide.md) - 完整設定參考
- [使用者手冊首頁](README.md) - 回到總覽

---

**祝您搶票成功！** 🎉

*最後更新：2025-10-29 | 版本：1.1*
